<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>Graphics Output</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      background: transparent;
    }
    #output {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Animations */
    .graphic-container {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Team Logos - Row Layout (2-4 teams) */
    .graphic-logos {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 100px;
      background: transparent;
    }
    .graphic-logos .team-logo {
      width: 250px;
      height: 250px;
      object-fit: contain;
      background: #f4f4f5;
      border-radius: 24px;
      padding: 25px;
    }
    /* Team Logos - Grid Layout (5-6 teams) */
    .graphic-logos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 60px;
      padding: 100px;
      place-items: center;
    }
    .graphic-logos-grid .team-logo {
      width: 200px;
      height: 200px;
      padding: 20px;
    }

    /* Event Info Bar */
    .graphic-event-bar {
      position: absolute;
      bottom: 120px;
      left: 100px;
      display: flex;
      flex-direction: row;
      animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    .event-bar-logo {
      width: 100px;
      background: #BFBFBF;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .event-bar-logo img {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .event-bar-content {
      display: flex;
      flex-direction: column;
    }
    .event-bar-venue {
      background: #BFBFBF;
      padding: 10px 40px;
      min-width: 600px;
      font-size: 36px;
      font-weight: 900;
      color: #000;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }
    .event-bar-details {
      background: #000;
      padding: 10px 40px;
    }
    .event-bar-name {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .event-bar-location {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    /* Hosts Card */
    .graphic-hosts {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .hosts-header {
      background: #d4d4d8;
      padding: 16px 36px;
      min-width: 400px;
    }
    .hosts-title {
      font-size: 36px;
      font-weight: 800;
      color: #000;
    }
    .hosts-content {
      background: #000;
      padding: 20px 36px;
      min-width: 400px;
    }
    .hosts-name {
      font-size: 26px;
      font-weight: 600;
      color: #fff;
      line-height: 1.5;
    }

    /* Team Stats Card */
    .graphic-team-stats {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .stats-header {
      background: #d4d4d8;
      padding: 14px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      min-width: 480px;
    }
    .stats-team-name {
      font-size: 32px;
      font-weight: 800;
      color: #000;
      flex: 1;
    }
    .stats-logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .stats-content {
      background: #000;
      padding: 16px 30px;
      display: flex;
      gap: 60px;
    }
    .stat-item { color: #fff; }
    .stat-label {
      font-size: 20px;
      font-weight: 500;
      opacity: 0.7;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }

    /* Coaches Card */
    .graphic-coaches {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .coaches-header {
      background: #d4d4d8;
      padding: 16px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 420px;
    }
    .coaches-title {
      font-size: 36px;
      font-weight: 800;
      color: #000;
    }
    .coaches-logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .coaches-content {
      background: #000;
      padding: 20px 30px;
      min-width: 420px;
    }
    .coach-name {
      font-size: 24px;
      font-weight: 500;
      color: #fff;
      line-height: 1.6;
    }

    /* Event Frame */
    .graphic-event-frame {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .frame-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .frame-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
    }
    .frame-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .frame-content {
      flex: 1;
      background: #000;
    }

    /* Virtius Leaderboard - uses event frame layout */
    .graphic-virtius-leaderboard {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .graphic-virtius-leaderboard .frame-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .graphic-virtius-leaderboard .frame-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
    }
    .graphic-virtius-leaderboard .frame-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .graphic-virtius-leaderboard .frame-content {
      flex: 1;
      background: #000;
      position: relative;
      overflow: hidden;
    }
    .graphic-virtius-leaderboard iframe {
      position: absolute;
      border: none;
      /* Crop and scale the iframe - larger scale = bigger text */
      width: 1920px;
      height: 1080px;
      transform-origin: top left;
      transform: scale(1.05);
      top: -155px;
      left: 0px;
    }

    /* Custom Leaderboard Table - Dark Theme */
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 28px;
    }
    .leaderboard-table thead {
      background: #27272a;
    }
    .leaderboard-table th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      color: #a1a1aa;
      border-bottom: 2px solid #3f3f46;
    }
    .leaderboard-table th.col-score,
    .leaderboard-table th.col-diff,
    .leaderboard-table th.col-exec,
    .leaderboard-table th.col-sb {
      text-align: right;
    }
    .leaderboard-table th.col-rank {
      width: 70px;
    }
    .leaderboard-table th.col-sb {
      width: 70px;
    }
    .leaderboard-table tbody tr {
      border-bottom: 1px solid #3f3f46;
    }
    .leaderboard-table tbody tr:nth-child(odd) {
      background: #18181b;
    }
    .leaderboard-table tbody tr:nth-child(even) {
      background: #0f0f10;
    }
    .leaderboard-table td {
      padding: 14px 20px;
      color: #fff;
      font-weight: 500;
      vertical-align: middle;
    }
    .leaderboard-table td.col-rank {
      width: 70px;
      font-weight: 700;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-rank sup {
      font-size: 14px;
      color: #71717a;
    }
    .leaderboard-table td.col-name {
      font-weight: 600;
    }
    .leaderboard-table td.col-name .place-indicator {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    .leaderboard-table td.col-team {
      color: #d4d4d8;
    }
    .leaderboard-table td.col-team .leaderboard-team-logo {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    .leaderboard-table td.col-apparatus {
      width: 100px;
    }
    .apparatus-badge {
      display: inline-block;
      padding: 4px 12px;
      border: 1px solid #52525b;
      border-radius: 4px;
      font-size: 20px;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-score {
      text-align: right;
      font-weight: 700;
      font-size: 32px;
      color: #fff;
    }
    .leaderboard-table td.col-diff,
    .leaderboard-table td.col-exec {
      text-align: right;
      font-size: 26px;
      font-weight: 500;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-sb {
      text-align: right;
      width: 70px;
    }
    /* Team logo in leaderboard */
    .leaderboard-team-logo {
      width: 36px;
      height: 36px;
      object-fit: contain;
      border-radius: 4px;
      background: #27272a;
    }
    /* Medal indicators */
    .leaderboard-medal {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 16px;
    }
    .medal-gold {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
    }
    .medal-silver {
      background: linear-gradient(135deg, #d1d5db, #9ca3af);
      color: #000;
    }
    .medal-bronze {
      background: linear-gradient(135deg, #d97706, #b45309);
      color: #fff;
    }
    /* Place indicator circles (before name) */
    .place-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .place-indicator.gold {
      background: #facc15;
    }
    .place-indicator.silver {
      background: #d4d4d8;
    }
    .place-indicator.bronze {
      background: #d97706;
    }
    /* Stick bonus indicator - green circle with S */
    .stick-bonus {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #22c55e;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
    }
    .leaderboard-loading {
      color: #fff;
      font-size: 36px;
      text-align: center;
      padding: 100px;
    }
    .leaderboard-error {
      color: #ef4444;
      font-size: 28px;
      text-align: center;
      padding: 100px;
    }

    /* Event Summary Styles - Rotation-based layout */
    .graphic-event-summary {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .event-summary-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .event-summary-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
      font-style: italic;
    }
    .event-summary-header-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .event-summary-content {
      flex: 1;
      background: #27272a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Dual Meet Layout - 2 teams with center divider */
    .event-summary-dual {
      display: flex;
      flex: 1;
    }
    .event-summary-dual .team-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .event-summary-dual .team-header {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      background: #27272a;
      gap: 16px;
    }
    .event-summary-dual .team-header.left {
      justify-content: flex-start;
    }
    .event-summary-dual .team-header.right {
      justify-content: flex-end;
      flex-direction: row-reverse;
    }
    .event-summary-dual .team-logo {
      width: 56px;
      height: 56px;
      object-fit: contain;
    }
    .event-summary-dual .team-name {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-dual .team-total {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .event-summary-dual .team-header.right .team-total {
      margin-left: 0;
      margin-right: auto;
    }
    .event-summary-dual .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .event-summary-dual .athlete-row {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      min-height: 72px;
    }
    .event-summary-dual .athlete-row:nth-child(odd) {
      background: #18181b;
    }
    .event-summary-dual .athlete-row:nth-child(even) {
      background: #27272a;
    }
    .event-summary-dual .athlete-order {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .event-summary-dual .athlete-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      object-position: top;
      background: #3f3f46;
      flex-shrink: 0;
    }
    .event-summary-dual .athlete-name {
      flex: 1;
      font-size: 22px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }
    .event-summary-dual .athlete-score-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      min-width: 90px;
    }
    .event-summary-dual .athlete-score {
      font-size: 26px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-dual .athlete-start {
      font-size: 14px;
      color: #a1a1aa;
    }
    /* Left side layout */
    .event-summary-dual .team-column.left .athlete-row {
      gap: 12px;
    }
    .event-summary-dual .team-column.left .athlete-order {
      order: 1;
    }
    .event-summary-dual .team-column.left .athlete-photo {
      order: 2;
    }
    .event-summary-dual .team-column.left .athlete-name {
      order: 3;
    }
    .event-summary-dual .team-column.left .athlete-score-block {
      order: 4;
      align-items: flex-end;
    }
    /* Right side - reverse order for RTL layout */
    .event-summary-dual .team-column.right .athlete-row {
      flex-direction: row-reverse;
      gap: 12px;
    }
    .event-summary-dual .team-column.right .athlete-name {
      text-align: right;
    }
    .event-summary-dual .team-column.right .athlete-score-block {
      align-items: flex-start;
    }

    /* Center divider with rotation info and score diff bars */
    .event-summary-dual .center-divider {
      width: 140px;
      background: #27272a;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .event-summary-dual .center-header {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 88px;
    }
    .event-summary-dual .rotation-badge {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
    }
    .event-summary-dual .diff-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 72px;
      padding: 8px 12px;
      width: 100%;
    }
    .event-summary-dual .diff-row:nth-child(odd) {
      background: #18181b;
    }
    .event-summary-dual .diff-row:nth-child(even) {
      background: #27272a;
    }
    .event-summary-dual .diff-value {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .event-summary-dual .diff-bar {
      width: 100%;
      height: 8px;
      background: #3f3f46;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    .event-summary-dual .diff-bar-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 4px;
    }
    .event-summary-dual .diff-bar-fill.left {
      right: 50%;
      background: linear-gradient(to left, #eab308, #dc2626);
    }
    .event-summary-dual .diff-bar-fill.right {
      left: 50%;
      background: linear-gradient(to right, #eab308, #dc2626);
    }
    .event-summary-dual .diff-bar-fill.tie {
      left: 50%;
      width: 4px !important;
      transform: translateX(-50%);
      background: #a1a1aa;
    }
    .event-summary-dual .diff-indicator {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #27272a;
    }

    /* Footer with event totals and icons */
    .event-summary-footer {
      display: flex;
      background: #18181b;
      border-top: 2px solid #3f3f46;
      min-height: 80px;
    }
    .event-summary-footer .footer-team {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 16px 24px;
      gap: 16px;
    }
    .event-summary-footer .footer-team.right {
      flex-direction: row-reverse;
    }
    .event-summary-footer .event-abbr {
      font-size: 24px;
      font-weight: 800;
      color: #a1a1aa;
    }
    .event-summary-footer .event-icon {
      width: 40px;
      height: 40px;
      opacity: 0.6;
    }
    .event-summary-footer .event-label {
      font-size: 20px;
      font-weight: 600;
      color: #a1a1aa;
    }
    .event-summary-footer .event-total {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .event-summary-footer .footer-team.right .event-total {
      margin-left: 0;
      margin-right: auto;
    }
    .event-summary-footer .footer-center {
      width: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .event-summary-footer .footer-diff {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-footer .footer-diff-bar {
      width: 80%;
      height: 6px;
      background: #3f3f46;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    .event-summary-footer .footer-diff-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 3px;
    }
    .event-summary-footer .footer-diff-fill.left {
      right: 50%;
      background: linear-gradient(to left, #eab308, #dc2626);
    }
    .event-summary-footer .footer-diff-fill.right {
      left: 50%;
      background: linear-gradient(to right, #eab308, #dc2626);
    }

    /* ==========================================
       EVENT SUMMARY THEMES
       ========================================== */

    /* Theme 1: ESPN - Bold red/black sports broadcast style */
    .theme-espn .event-summary-dual {
      background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
    }
    .theme-espn .team-header {
      background: linear-gradient(90deg, #c41e3a 0%, #8b0000 100%);
      border-bottom: 3px solid #ffd700;
    }
    .theme-espn .team-header.right {
      background: linear-gradient(90deg, #8b0000 0%, #c41e3a 100%);
    }
    .theme-espn .team-name {
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .theme-espn .athlete-row:nth-child(odd) { background: #1a1a1a; }
    .theme-espn .athlete-row:nth-child(even) { background: #242424; }
    .theme-espn .center-divider { background: #c41e3a; }
    .theme-espn .rotation-badge { color: #ffd700; }
    .theme-espn .diff-bar { background: #333; }
    .theme-espn .diff-bar-fill.left { background: linear-gradient(to left, #ffd700, #c41e3a); }
    .theme-espn .diff-bar-fill.right { background: linear-gradient(to right, #ffd700, #c41e3a); }
    .theme-espn .event-summary-footer { background: #c41e3a; border-top: 3px solid #ffd700; }
    .theme-espn .event-summary-footer .event-total { color: #ffd700; }

    /* Theme 2: NBC Olympics - Gold/white elegant style */
    .theme-nbc .event-summary-dual {
      background: linear-gradient(180deg, #0a1628 0%, #051020 100%);
    }
    .theme-nbc .team-header {
      background: linear-gradient(90deg, #b8860b 0%, #daa520 50%, #b8860b 100%);
      border-bottom: 2px solid #fff;
    }
    .theme-nbc .team-name { color: #0a1628; font-weight: 800; }
    .theme-nbc .team-total { color: #0a1628; }
    .theme-nbc .athlete-row:nth-child(odd) { background: #0a1628; }
    .theme-nbc .athlete-row:nth-child(even) { background: #0f1f38; }
    .theme-nbc .athlete-score { color: #daa520; }
    .theme-nbc .center-divider { background: linear-gradient(180deg, #daa520 0%, #b8860b 100%); }
    .theme-nbc .rotation-badge { color: #0a1628; font-weight: 900; }
    .theme-nbc .diff-value { color: #0a1628; }
    .theme-nbc .diff-bar { background: rgba(10,22,40,0.5); }
    .theme-nbc .diff-bar-fill.left { background: linear-gradient(to left, #fff, #daa520); }
    .theme-nbc .diff-bar-fill.right { background: linear-gradient(to right, #fff, #daa520); }
    .theme-nbc .event-summary-footer { background: linear-gradient(90deg, #b8860b, #daa520, #b8860b); border-top: none; }
    .theme-nbc .event-summary-footer * { color: #0a1628; }

    /* Theme 3: Big Ten Network - Clean navy/white */
    .theme-btn .event-summary-dual {
      background: #041e42;
    }
    .theme-btn .team-header {
      background: #fff;
      border-bottom: 4px solid #041e42;
    }
    .theme-btn .team-name { color: #041e42; }
    .theme-btn .team-total { color: #041e42; }
    .theme-btn .athlete-row:nth-child(odd) { background: #041e42; }
    .theme-btn .athlete-row:nth-child(even) { background: #0a2d5c; }
    .theme-btn .athlete-order { background: #fff; color: #041e42; }
    .theme-btn .center-divider { background: #fff; }
    .theme-btn .rotation-badge { color: #041e42; }
    .theme-btn .diff-value { color: #041e42; }
    .theme-btn .diff-bar { background: #ccc; }
    .theme-btn .diff-bar-fill.left { background: linear-gradient(to left, #041e42, #0a2d5c); }
    .theme-btn .diff-bar-fill.right { background: linear-gradient(to right, #041e42, #0a2d5c); }
    .theme-btn .event-summary-footer { background: #fff; border-top: 4px solid #041e42; }
    .theme-btn .event-summary-footer * { color: #041e42; }

    /* Theme 4: Pac-12 Network - Gradient purple/blue */
    .theme-pac12 .event-summary-dual {
      background: linear-gradient(135deg, #1a0a2e 0%, #0f1a3d 100%);
    }
    .theme-pac12 .team-header {
      background: linear-gradient(90deg, #4a148c 0%, #1565c0 100%);
      border-bottom: 2px solid #00e5ff;
    }
    .theme-pac12 .team-header.right {
      background: linear-gradient(90deg, #1565c0 0%, #4a148c 100%);
    }
    .theme-pac12 .athlete-row:nth-child(odd) { background: rgba(74,20,140,0.3); }
    .theme-pac12 .athlete-row:nth-child(even) { background: rgba(21,101,192,0.3); }
    .theme-pac12 .athlete-score { color: #00e5ff; }
    .theme-pac12 .center-divider { background: linear-gradient(180deg, #4a148c 0%, #1565c0 100%); }
    .theme-pac12 .diff-bar-fill.left { background: linear-gradient(to left, #00e5ff, #4a148c); }
    .theme-pac12 .diff-bar-fill.right { background: linear-gradient(to right, #00e5ff, #1565c0); }
    .theme-pac12 .event-summary-footer { background: linear-gradient(90deg, #4a148c, #1565c0); border-top: 2px solid #00e5ff; }

    /* Theme 5: Virtius Dark - Sleek dark with subtle grays */
    .theme-virtius .event-summary-dual {
      background: #121214;
    }
    .theme-virtius .team-header {
      background: #1e1e21;
      border-bottom: 1px solid #333;
    }
    .theme-virtius .team-name { font-weight: 500; color: #e0e0e0; }
    .theme-virtius .team-total { color: #888; font-weight: 600; }
    .theme-virtius .athlete-row { border-bottom: 1px solid #222; }
    .theme-virtius .athlete-row:nth-child(odd) { background: #121214; }
    .theme-virtius .athlete-row:nth-child(even) { background: #18181b; }
    .theme-virtius .athlete-order { background: #333; }
    .theme-virtius .athlete-name { color: #ccc; font-weight: 500; }
    .theme-virtius .athlete-score { color: #888; }
    .theme-virtius .center-divider { background: #1e1e21; border-left: 1px solid #333; border-right: 1px solid #333; }
    .theme-virtius .rotation-badge { color: #666; font-weight: 600; }
    .theme-virtius .diff-value { color: #666; }
    .theme-virtius .diff-bar { background: #2a2a2d; height: 4px; }
    .theme-virtius .diff-bar-fill.left { background: #666; }
    .theme-virtius .diff-bar-fill.right { background: #666; }
    .theme-virtius .event-summary-footer { background: #1e1e21; border-top: 1px solid #333; }
    .theme-virtius .event-summary-footer .event-total { color: #888; }

    /* Theme 6: Neon Cyber - Futuristic neon accents */
    .theme-neon .event-summary-dual {
      background: #0a0a0f;
    }
    .theme-neon .team-header {
      background: linear-gradient(90deg, rgba(0,255,136,0.15) 0%, transparent 50%);
      border-bottom: 2px solid #00ff88;
      border-left: 3px solid #00ff88;
    }
    .theme-neon .team-header.right {
      background: linear-gradient(90deg, transparent 50%, rgba(255,0,136,0.15) 100%);
      border-bottom: 2px solid #ff0088;
      border-left: none;
      border-right: 3px solid #ff0088;
    }
    .theme-neon .team-column.left .team-name { color: #00ff88; }
    .theme-neon .team-column.right .team-name { color: #ff0088; }
    .theme-neon .team-total { color: #fff; text-shadow: 0 0 10px currentColor; }
    .theme-neon .athlete-row:nth-child(odd) { background: #0a0a0f; }
    .theme-neon .athlete-row:nth-child(even) { background: #0f0f18; }
    .theme-neon .team-column.left .athlete-score { color: #00ff88; }
    .theme-neon .team-column.right .athlete-score { color: #ff0088; }
    .theme-neon .center-divider { background: #0f0f18; }
    .theme-neon .rotation-badge { color: #fff; text-shadow: 0 0 15px #00ff88, 0 0 30px #ff0088; }
    .theme-neon .diff-bar { background: #1a1a2e; }
    .theme-neon .diff-bar-fill.left { background: linear-gradient(to left, #00ff88, #00cc6a); box-shadow: 0 0 10px #00ff88; }
    .theme-neon .diff-bar-fill.right { background: linear-gradient(to right, #ff0088, #cc006a); box-shadow: 0 0 10px #ff0088; }
    .theme-neon .event-summary-footer { background: #0a0a0f; border-top: 1px solid #333; }

    /* Theme 7: Classic Broadcast - Traditional TV sports look */
    .theme-classic .event-summary-dual {
      background: linear-gradient(180deg, #2c3e50 0%, #1a252f 100%);
    }
    .theme-classic .team-header {
      background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
      border-bottom: 3px solid #e74c3c;
    }
    .theme-classic .team-name { font-family: 'Arial Black', sans-serif; text-transform: uppercase; }
    .theme-classic .athlete-row:nth-child(odd) { background: #2c3e50; }
    .theme-classic .athlete-row:nth-child(even) { background: #34495e; }
    .theme-classic .athlete-order { background: #e74c3c; }
    .theme-classic .center-divider { background: #e74c3c; }
    .theme-classic .rotation-badge { color: #fff; font-family: 'Arial Black', sans-serif; }
    .theme-classic .diff-bar-fill.left { background: #f39c12; }
    .theme-classic .diff-bar-fill.right { background: #f39c12; }
    .theme-classic .event-summary-footer { background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%); border-top: 3px solid #e74c3c; }

    /* Theme 8: Minimal Light - Clean white/gray for daytime */
    .theme-light .event-summary-dual {
      background: #f5f5f5;
    }
    .theme-light .team-header {
      background: #fff;
      border-bottom: 2px solid #ddd;
    }
    .theme-light .team-name { color: #333; }
    .theme-light .team-total { color: #333; }
    .theme-light .team-logo { filter: none; }
    .theme-light .athlete-row:nth-child(odd) { background: #fff; }
    .theme-light .athlete-row:nth-child(even) { background: #f9f9f9; }
    .theme-light .athlete-name { color: #333; }
    .theme-light .athlete-score { color: #0066cc; }
    .theme-light .athlete-order { background: #333; color: #fff; }
    .theme-light .center-divider { background: #e0e0e0; }
    .theme-light .rotation-badge { color: #333; }
    .theme-light .diff-value { color: #333; }
    .theme-light .diff-bar { background: #ccc; }
    .theme-light .diff-bar-fill.left { background: linear-gradient(to left, #0066cc, #004499); }
    .theme-light .diff-bar-fill.right { background: linear-gradient(to right, #0066cc, #004499); }
    .theme-light .event-summary-footer { background: #fff; border-top: 2px solid #ddd; }
    .theme-light .event-summary-footer * { color: #333; }
    .theme-light .event-summary-footer .event-total { color: #0066cc; }

    /* Theme 9: Team Colors (Home) - Uses team's primary color */
    .theme-home .event-summary-dual {
      background: var(--home-bg, #18181b);
    }
    .theme-home .team-header {
      background: var(--home-primary, #00274c);
      border-bottom: 3px solid var(--home-secondary, #ffcb05);
    }
    .theme-home .team-header.right {
      background: var(--away-primary, #bb0000);
      border-bottom-color: var(--away-secondary, #fff);
    }
    .theme-home .athlete-row:nth-child(odd) { background: rgba(0,0,0,0.3); }
    .theme-home .athlete-row:nth-child(even) { background: rgba(0,0,0,0.15); }
    .theme-home .team-column.left .athlete-score { color: var(--home-secondary, #ffcb05); }
    .theme-home .team-column.right .athlete-score { color: var(--away-secondary, #fff); }
    .theme-home .center-divider { background: #27272a; }
    .theme-home .diff-bar-fill.left { background: var(--home-primary, #00274c); }
    .theme-home .diff-bar-fill.right { background: var(--away-primary, #bb0000); }
    .theme-home .event-summary-footer { background: var(--home-primary, #00274c); border-top: 3px solid var(--home-secondary, #ffcb05); }

    /* Theme 10: Gradient Split - Each side uses team gradient */
    .theme-gradient .event-summary-dual {
      background: linear-gradient(90deg, var(--home-primary, #00274c) 0%, #18181b 40%, #18181b 60%, var(--away-primary, #bb0000) 100%);
    }
    .theme-gradient .team-header {
      background: linear-gradient(180deg, var(--home-primary, #00274c) 0%, rgba(0,39,76,0.7) 100%);
    }
    .theme-gradient .team-header.right {
      background: linear-gradient(180deg, var(--away-primary, #bb0000) 0%, rgba(187,0,0,0.7) 100%);
    }
    .theme-gradient .team-column.left { background: linear-gradient(180deg, rgba(0,39,76,0.3) 0%, transparent 100%); }
    .theme-gradient .team-column.right { background: linear-gradient(180deg, rgba(187,0,0,0.3) 0%, transparent 100%); }
    .theme-gradient .athlete-row { background: transparent !important; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .theme-gradient .team-column.left .athlete-score { color: var(--home-secondary, #ffcb05); }
    .theme-gradient .team-column.right .athlete-score { color: var(--away-secondary, #fff); }
    .theme-gradient .center-divider { background: rgba(255,255,255,0.05); }
    .theme-gradient .diff-bar-fill.left { background: var(--home-secondary, #ffcb05); }
    .theme-gradient .diff-bar-fill.right { background: var(--away-secondary, #fff); }
    .theme-gradient .event-summary-footer {
      background: linear-gradient(90deg, var(--home-primary, #00274c) 0%, #27272a 40%, #27272a 60%, var(--away-primary, #bb0000) 100%);
      border-top: none;
    }

    /* ==========================================
       END EVENT SUMMARY THEMES
       ========================================== */

    /* ==========================================
       LAYOUT OPTIONS - Different structural layouts
       ========================================== */

    /* Layout 1: Hero Cards - Clean, symmetric, big text */
    .layout-broadcast-table {
      display: flex;
      flex-direction: column;
      flex: 1;
      background: #0a0a0a;
      padding: 32px;
      gap: 24px;
    }
    /* Top scoreboard bar */
    .layout-broadcast-table .hero-scoreboard {
      display: flex;
      align-items: center;
      background: #151515;
      border-radius: 12px;
      padding: 20px 40px;
    }
    .layout-broadcast-table .hero-team-score {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 24px;
    }
    .layout-broadcast-table .hero-team-score.away {
      flex-direction: row-reverse;
    }
    .layout-broadcast-table .hero-team-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .layout-broadcast-table .hero-team-info {
      display: flex;
      flex-direction: column;
    }
    .layout-broadcast-table .hero-team-score.away .hero-team-info {
      align-items: flex-end;
    }
    .layout-broadcast-table .hero-team-name {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .layout-broadcast-table .hero-team-total {
      font-size: 56px;
      font-weight: 900;
      color: #fff;
      line-height: 1;
    }
    .layout-broadcast-table .hero-center-vs {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 40px;
    }
    .layout-broadcast-table .hero-rotation-badge {
      background: #252525;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 20px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .layout-broadcast-table .hero-vs-text {
      font-size: 18px;
      font-weight: 700;
      color: #444;
      margin-top: 8px;
    }
    /* Athlete cards - symmetric 6-row grid */
    .layout-broadcast-table .hero-cards-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      overflow: hidden;
    }
    .layout-broadcast-table .hero-team-column {
      display: grid;
      grid-template-rows: repeat(6, 1fr);
      gap: 8px;
    }
    .layout-broadcast-table .hero-athlete-card {
      display: flex;
      align-items: center;
      background: #151515;
      border-radius: 12px;
      padding: 8px 20px;
      gap: 20px;
      min-height: 0;
    }
    .layout-broadcast-table .hero-athlete-card.away {
      flex-direction: row-reverse;
    }
    .layout-broadcast-table .hero-athlete-card.empty {
      background: transparent;
    }
    .layout-broadcast-table .hero-athlete-photo {
      height: 100%;
      aspect-ratio: 1;
      max-height: 100px;
      border-radius: 8px;
      object-fit: cover;
      object-position: top;
      background: #252525;
      flex-shrink: 0;
    }
    .layout-broadcast-table .hero-athlete-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }
    .layout-broadcast-table .hero-athlete-card.away .hero-athlete-info {
      align-items: flex-end;
    }
    .layout-broadcast-table .hero-athlete-name {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.1;
    }
    .layout-broadcast-table .hero-athlete-score {
      font-size: 44px;
      font-weight: 900;
      color: #f59e0b;
      line-height: 1;
      flex-shrink: 0;
    }
    /* Event totals footer */
    .layout-broadcast-table .hero-footer {
      display: flex;
      align-items: center;
      background: #151515;
      border-radius: 12px;
      padding: 16px 40px;
    }
    .layout-broadcast-table .hero-footer-team {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .layout-broadcast-table .hero-footer-team.away {
      flex-direction: row-reverse;
    }
    .layout-broadcast-table .hero-footer-event {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .layout-broadcast-table .hero-footer-event-code {
      font-size: 28px;
      font-weight: 900;
      color: #666;
    }
    .layout-broadcast-table .hero-footer-event-label {
      font-size: 18px;
      font-weight: 600;
      color: #444;
      text-transform: uppercase;
    }
    .layout-broadcast-table .hero-footer-total {
      font-size: 48px;
      font-weight: 900;
      color: #fff;
      margin-left: auto;
    }
    .layout-broadcast-table .hero-footer-team.away .hero-footer-total {
      margin-left: 0;
      margin-right: auto;
    }
    .layout-broadcast-table .hero-footer-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 32px;
    }
    .layout-broadcast-table .hero-footer-diff {
      font-size: 28px;
      font-weight: 800;
      color: #666;
    }

    /* Layout 2: Classic Broadcast - Exact replica of default layout */
    .layout-classic-broadcast {
      display: flex;
      flex: 1;
      background: #27272a;
    }
    .layout-classic-broadcast .team-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .layout-classic-broadcast .team-header {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      background: #27272a;
      gap: 16px;
    }
    .layout-classic-broadcast .team-header.left {
      justify-content: flex-start;
    }
    .layout-classic-broadcast .team-header.right {
      justify-content: flex-end;
      flex-direction: row-reverse;
    }
    .layout-classic-broadcast .team-logo {
      width: 56px;
      height: 56px;
      object-fit: contain;
    }
    .layout-classic-broadcast .team-name {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }
    .layout-classic-broadcast .team-total {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .layout-classic-broadcast .team-header.right .team-total {
      margin-left: 0;
      margin-right: auto;
    }
    .layout-classic-broadcast .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #18181b;
    }
    .layout-classic-broadcast .athlete-row {
      display: flex;
      align-items: center;
      padding: 8px 20px;
      min-height: 72px;
      background: #27272a;
    }
    /* Left side layout */
    .layout-classic-broadcast .team-column.left .athlete-row {
      gap: 12px;
    }
    .layout-classic-broadcast .team-column.left .athlete-order {
      order: 1;
    }
    .layout-classic-broadcast .team-column.left .athlete-photo {
      order: 2;
    }
    .layout-classic-broadcast .team-column.left .athlete-name {
      order: 3;
    }
    .layout-classic-broadcast .team-column.left .athlete-score-block {
      order: 4;
      align-items: flex-end;
    }
    /* Right side - reverse order for RTL layout */
    .layout-classic-broadcast .team-column.right .athlete-row {
      flex-direction: row-reverse;
      gap: 12px;
    }
    .layout-classic-broadcast .team-column.right .athlete-name {
      text-align: right;
    }
    .layout-classic-broadcast .team-column.right .athlete-score-block {
      align-items: flex-start;
    }
    .layout-classic-broadcast .athlete-order {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .layout-classic-broadcast .athlete-order.anchor {
      background: #eab308;
      color: #000;
    }
    .layout-classic-broadcast .athlete-photo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
      object-position: top;
      background: #3f3f46;
      flex-shrink: 0;
    }
    .layout-classic-broadcast .athlete-name {
      flex: 1;
      font-size: 22px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
    }
    .layout-classic-broadcast .athlete-score-block {
      display: flex;
      flex-direction: column;
      min-width: 90px;
    }
    .layout-classic-broadcast .athlete-score {
      font-size: 26px;
      font-weight: 700;
      color: #fff;
    }
    .layout-classic-broadcast .athlete-start {
      font-size: 14px;
      color: #a1a1aa;
    }
    /* Center divider with rotation info and score diff bars */
    .layout-classic-broadcast .center-divider {
      width: 140px;
      background: #18181b;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .layout-classic-broadcast .center-header {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 88px;
      background: #27272a;
    }
    .layout-classic-broadcast .rotation-badge {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
    }
    .layout-classic-broadcast .diff-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 72px;
      padding: 8px 12px;
      width: 100%;
      background: #27272a;
    }
    .layout-classic-broadcast .diff-value {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }
    .layout-classic-broadcast .diff-bar {
      width: 100%;
      height: 8px;
      background: #3f3f46;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    .layout-classic-broadcast .diff-bar-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 4px;
    }
    .layout-classic-broadcast .diff-bar-fill.left {
      right: 50%;
      background: linear-gradient(to left, #eab308, #dc2626);
    }
    .layout-classic-broadcast .diff-bar-fill.right {
      left: 50%;
      background: linear-gradient(to right, #eab308, #dc2626);
    }
    .layout-classic-broadcast .diff-bar-fill.tie {
      left: 50%;
      width: 4px !important;
      transform: translateX(-50%);
      background: #a1a1aa;
    }
    /* Footer with event totals and icons */
    .layout-classic-broadcast .summary-footer {
      display: flex;
      background: #18181b;
      border-top: 2px solid #3f3f46;
      min-height: 80px;
    }
    .layout-classic-broadcast .footer-team {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 16px 24px;
      gap: 16px;
    }
    .layout-classic-broadcast .footer-team.right {
      flex-direction: row-reverse;
    }
    .layout-classic-broadcast .event-abbr {
      font-size: 24px;
      font-weight: 800;
      color: #a1a1aa;
    }
    .layout-classic-broadcast .event-icon {
      width: 40px;
      height: 40px;
      opacity: 0.6;
    }
    .layout-classic-broadcast .event-label {
      font-size: 20px;
      font-weight: 600;
      color: #a1a1aa;
    }
    .layout-classic-broadcast .event-total {
      font-size: 32px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .layout-classic-broadcast .footer-team.right .event-total {
      margin-left: 0;
      margin-right: auto;
    }
    .layout-classic-broadcast .footer-center {
      width: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .layout-classic-broadcast .footer-diff {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
    }
    .layout-classic-broadcast .footer-diff-bar {
      width: 80%;
      height: 6px;
      background: #3f3f46;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    .layout-classic-broadcast .footer-diff-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 3px;
    }
    .layout-classic-broadcast .footer-diff-fill.left {
      right: 50%;
      background: linear-gradient(to left, #eab308, #dc2626);
    }
    .layout-classic-broadcast .footer-diff-fill.right {
      left: 50%;
      background: linear-gradient(to right, #eab308, #dc2626);
    }

    /* Layout 3: Default Original V2 - Improved default with larger text and inline D-score */
    .layout-default-v2 {
      display: flex;
      flex-direction: column;
      flex: 1;
      background: #18181b;
    }
    /* Title bar at top - EVENT SUMMARY on left, logos on right */
    .layout-default-v2 .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 40px;
      background: #d4d4d8;
      min-height: 80px;
    }
    .layout-default-v2 .title-bar .title-text {
      font-size: 42px;
      font-weight: 800;
      color: #000;
      font-style: italic;
    }
    .layout-default-v2 .title-bar .title-logos {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .layout-default-v2 .title-bar .title-logo {
      width: 72px;
      height: 72px;
      object-fit: contain;
    }
    /* Main content area */
    .layout-default-v2 .main-content {
      display: flex;
      flex: 1;
    }
    .layout-default-v2 .team-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .layout-default-v2 .team-header {
      display: flex;
      align-items: center;
      padding: 16px 24px;
      background: #27272a;
      gap: 16px;
      height: 88px;
    }
    .layout-default-v2 .team-header.left {
      justify-content: flex-start;
    }
    .layout-default-v2 .team-header.right {
      justify-content: flex-end;
      flex-direction: row-reverse;
    }
    .layout-default-v2 .team-logo {
      width: 72px;
      height: 72px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .layout-default-v2 .team-name {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
    }
    .layout-default-v2 .team-total {
      font-size: 36px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .layout-default-v2 .team-header.right .team-total {
      margin-left: 0;
      margin-right: auto;
    }
    .layout-default-v2 .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #18181b;
      gap: 4px;
      padding: 4px 0;
    }
    .layout-default-v2 .athlete-row {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      flex: 1;
      min-height: 100px;
      background: #27272a;
      gap: 16px;
    }
    /* Left side layout - score then D-score */
    .layout-default-v2 .team-column.left .athlete-row {
      flex-direction: row;
    }
    .layout-default-v2 .team-column.left .athlete-score-block {
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    /* Right side - mirrored layout */
    .layout-default-v2 .team-column.right .athlete-row {
      flex-direction: row-reverse;
    }
    .layout-default-v2 .team-column.right .athlete-info {
      text-align: right;
    }
    .layout-default-v2 .team-column.right .athlete-score-block {
      flex-direction: row;
      justify-content: flex-start;
    }
    .layout-default-v2 .athlete-order {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }
    .layout-default-v2 .athlete-order.anchor {
      background: #eab308;
      color: #000;
    }
    .layout-default-v2 .athlete-photo {
      width: 88px;
      height: 88px;
      border-radius: 8px;
      object-fit: contain;
      background: transparent;
      flex-shrink: 0;
    }
    .layout-default-v2 .athlete-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }
    .layout-default-v2 .athlete-name {
      font-size: 36px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .layout-default-v2 .athlete-score-block {
      display: flex;
      align-items: baseline;
      gap: 12px;
      min-width: 180px;
    }
    .layout-default-v2 .athlete-score {
      font-size: 44px;
      font-weight: 700;
      color: #fff;
    }
    .layout-default-v2 .athlete-start {
      font-size: 24px;
      font-weight: 500;
      color: #a1a1aa;
      margin-bottom: -4px;
    }
    /* Center divider */
    .layout-default-v2 .center-divider {
      width: 140px;
      display: flex;
      flex-direction: column;
      background: #18181b;
    }
    .layout-default-v2 .center-header {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 88px;
      background: #27272a;
    }
    .layout-default-v2 .rotation-badge {
      font-size: 36px;
      font-weight: 800;
      color: #fff;
    }
    .layout-default-v2 .diff-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 4px 0;
    }
    .layout-default-v2 .diff-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-height: 100px;
      background: #27272a;
      padding: 8px 12px;
    }
    .layout-default-v2 .diff-value {
      font-size: 22px;
      font-weight: 600;
      color: #a1a1aa;
      margin-bottom: 8px;
    }
    .layout-default-v2 .diff-bar {
      width: 100%;
      height: 6px;
      background: #3f3f46;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    .layout-default-v2 .diff-bar-fill {
      position: absolute;
      top: 0;
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .layout-default-v2 .diff-bar-fill.left {
      right: 50%;
      background: linear-gradient(to left, #22c55e, #16a34a);
    }
    .layout-default-v2 .diff-bar-fill.right {
      left: 50%;
      background: linear-gradient(to right, #ef4444, #dc2626);
    }
    .layout-default-v2 .diff-bar-fill.tie {
      left: 50%;
      transform: translateX(-50%);
      width: 4px !important;
      background: #a1a1aa;
    }
    /* Footer overrides for Default V2 layout - larger text */
    .layout-default-v2-footer {
      border-top: 2px solid #3f3f46;
    }
    .layout-default-v2-footer .event-abbr {
      font-size: 28px;
      font-weight: 800;
    }
    .layout-default-v2-footer .event-icon {
      width: 32px;
      height: 32px;
    }
    .layout-default-v2-footer .event-label {
      font-size: 18px;
    }
    .layout-default-v2-footer .event-total {
      font-size: 36px;
      font-weight: 800;
    }
    .layout-default-v2-footer .footer-center {
      width: 160px;
    }
    .layout-default-v2-footer .footer-diff {
      font-size: 24px;
      font-weight: 700;
    }

    /* ==========================================
       END LAYOUT OPTIONS
       ========================================== */

    /* Quad Meet Layout - 4 team columns */
    .event-summary-quad {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      flex: 1;
      gap: 2px;
      background: #3f3f46;
    }
    .event-summary-quad .team-column {
      background: #18181b;
      display: flex;
      flex-direction: column;
    }
    .event-summary-quad .team-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      background: #27272a;
      border-bottom: 2px solid #3f3f46;
    }
    .event-summary-quad .event-name {
      font-size: 14px;
      color: #a1a1aa;
      margin-bottom: 4px;
    }
    .event-summary-quad .team-name {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .event-summary-quad .team-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }
    .event-summary-quad .athlete-list {
      flex: 1;
      overflow: hidden;
    }
    .event-summary-quad .athlete-row {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #3f3f46;
    }
    .event-summary-quad .athlete-row:nth-child(odd) {
      background: #18181b;
    }
    .event-summary-quad .athlete-row:nth-child(even) {
      background: #0f0f10;
    }
    .event-summary-quad .athlete-order {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      margin-right: 8px;
    }
    .event-summary-quad .athlete-name {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-summary-quad .athlete-score {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-quad .team-footer {
      padding: 10px;
      background: #27272a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-summary-quad .footer-label {
      font-size: 14px;
      color: #a1a1aa;
    }
    .event-summary-quad .footer-total {
      font-size: 22px;
      font-weight: 800;
      color: #fff;
    }

    /* ==========================================
       Layout: Default Original V3 (Multi-Team)
       Full-height symmetric rows, no headshots
       ========================================== */
    .event-summary-quad-v3 {
      display: grid;
      flex: 1;
      gap: 2px;
      background: #3f3f46;
      height: 100%;
    }
    .event-summary-quad-v3.teams-2 { grid-template-columns: repeat(2, 1fr); }
    .event-summary-quad-v3.teams-3 { grid-template-columns: repeat(3, 1fr); }
    .event-summary-quad-v3.teams-4 { grid-template-columns: repeat(4, 1fr); }
    .event-summary-quad-v3.teams-5 { grid-template-columns: repeat(5, 1fr); }
    .event-summary-quad-v3.teams-6 { grid-template-columns: repeat(6, 1fr); }

    .event-summary-quad-v3 .team-column {
      background: #18181b;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .event-summary-quad-v3 .team-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 12px;
      background: #27272a;
      border-bottom: 2px solid #3f3f46;
      flex-shrink: 0;
    }

    .event-summary-quad-v3 .event-name {
      font-size: 14px;
      color: #a1a1aa;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-summary-quad-v3 .team-name {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .event-summary-quad-v3 .team-logo {
      width: 32px;
      height: 32px;
      object-fit: contain;
    }

    .event-summary-quad-v3 .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .event-summary-quad-v3 .athlete-row {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0 14px;
      min-height: 0;
      border-bottom: 1px solid #27272a;
    }

    .event-summary-quad-v3 .athlete-row:nth-child(odd) {
      background: #18181b;
    }

    .event-summary-quad-v3 .athlete-row:nth-child(even) {
      background: #0f0f10;
    }

    .event-summary-quad-v3 .athlete-row.empty {
      background: #141416;
    }

    .event-summary-quad-v3 .athlete-order {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .event-summary-quad-v3 .athlete-row.empty .athlete-order {
      background: #3f3f46;
      color: #71717a;
    }

    .event-summary-quad-v3 .athlete-name {
      flex: 1;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-summary-quad-v3 .athlete-row.empty .athlete-name {
      color: #52525b;
    }

    .event-summary-quad-v3 .athlete-score {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      min-width: 70px;
      text-align: right;
    }

    .event-summary-quad-v3 .athlete-row.empty .athlete-score {
      color: #3f3f46;
    }

    .event-summary-quad-v3 .team-footer {
      padding: 14px 16px;
      background: #27272a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 2px solid #3f3f46;
      flex-shrink: 0;
    }

    .event-summary-quad-v3 .footer-label {
      font-size: 15px;
      color: #a1a1aa;
      font-weight: 500;
    }

    .event-summary-quad-v3 .footer-total {
      font-size: 26px;
      font-weight: 800;
      color: #fff;
    }

    /* ==========================================
       Layout: Default Original V4 (Multi-Team)
       Based on V3 with team rankings and totals
       ========================================== */
    .event-summary-quad-v4 {
      display: grid;
      flex: 1;
      gap: 2px;
      background: #3f3f46;
      height: 100%;
    }
    .event-summary-quad-v4.teams-2 { grid-template-columns: repeat(2, 1fr); }
    .event-summary-quad-v4.teams-3 { grid-template-columns: repeat(3, 1fr); }
    .event-summary-quad-v4.teams-4 { grid-template-columns: repeat(4, 1fr); }
    .event-summary-quad-v4.teams-5 { grid-template-columns: repeat(5, 1fr); }
    .event-summary-quad-v4.teams-6 { grid-template-columns: repeat(6, 1fr); }

    .event-summary-quad-v4 .team-column {
      background: #18181b;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .event-summary-quad-v4 .team-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 14px;
      background: #27272a;
      border-bottom: 2px solid #3f3f46;
      flex-shrink: 0;
    }

    /* Line 1: Rank + Logo + Team Name */
    .event-summary-quad-v4 .header-line1 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .event-summary-quad-v4 .team-rank {
      font-size: 11px;
      font-weight: 700;
      color: #18181b;
      background: #a1a1aa;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-summary-quad-v4 .team-rank.rank-1 {
      background: #fbbf24;
      color: #18181b;
    }

    .event-summary-quad-v4 .team-rank.rank-2 {
      background: #94a3b8;
      color: #18181b;
    }

    .event-summary-quad-v4 .team-rank.rank-3 {
      background: #cd7f32;
      color: #18181b;
    }

    .event-summary-quad-v4 .team-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }

    .event-summary-quad-v4 .team-name {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Line 2: Total Score + Event Label */
    .event-summary-quad-v4 .header-line2 {
      display: flex;
      align-items: baseline;
      justify-content: center;
      gap: 10px;
    }

    .event-summary-quad-v4 .team-total {
      font-size: 22px;
      font-weight: 800;
      color: #fff;
    }

    .event-summary-quad-v4 .event-label {
      font-size: 12px;
      color: #71717a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .event-summary-quad-v4 .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .event-summary-quad-v4 .athlete-row {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0 14px;
      min-height: 0;
      border-bottom: 1px solid #27272a;
    }

    .event-summary-quad-v4 .athlete-row:nth-child(odd) {
      background: #18181b;
    }

    .event-summary-quad-v4 .athlete-row:nth-child(even) {
      background: #0f0f10;
    }

    .event-summary-quad-v4 .athlete-row.empty {
      background: #141416;
    }

    .event-summary-quad-v4 .athlete-order {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: #fff;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .event-summary-quad-v4 .athlete-row.empty .athlete-order {
      background: #3f3f46;
      color: #71717a;
    }

    .event-summary-quad-v4 .athlete-name {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .event-summary-quad-v4 .athlete-row.empty .athlete-name {
      color: #52525b;
    }

    .event-summary-quad-v4 .athlete-score {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      min-width: 65px;
      text-align: right;
    }

    .event-summary-quad-v4 .athlete-row.empty .athlete-score {
      color: #3f3f46;
    }

    .event-summary-quad-v4 .team-footer {
      padding: 12px 14px;
      background: #27272a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 2px solid #3f3f46;
      flex-shrink: 0;
    }

    .event-summary-quad-v4 .footer-label {
      font-size: 14px;
      color: #a1a1aa;
      font-weight: 500;
    }

    .event-summary-quad-v4 .footer-total {
      font-size: 24px;
      font-weight: 800;
      color: #fff;
    }

    .event-summary-loading {
      color: #fff;
      font-size: 36px;
      text-align: center;
      padding: 100px;
    }
    .event-summary-error {
      color: #ef4444;
      font-size: 28px;
      text-align: center;
      padding: 100px;
    }

    /* Stream Graphics */
    .graphic-stream {
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stream-title {
      font-size: 48px;
      font-weight: 800;
      color: #000;
      margin-bottom: 50px;
    }
    .stream-logo {
      width: 320px;
      height: 320px;
      object-fit: contain;
      margin-bottom: 50px;
    }
    .stream-event-name {
      font-size: 54px;
      font-weight: 800;
      color: #000;
    }
    .stream-date {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin-top: 10px;
    }
    .stream-branding {
      margin-top: 30px;
      font-size: 36px;
      font-weight: 600;
      color: #000;
    }
    .stream-branding span {
      color: #22d3ee;
    }

    /* Warm Up Graphic */
    .graphic-warm-up {
      position: absolute;
      bottom: 120px;
      left: 100px;
      display: flex;
      flex-direction: row;
      animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .warm-up-logo-section {
      width: 100px;
      background: #BFBFBF;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .warm-up-logo-section img {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .warm-up-content-section {
      display: flex;
      flex-direction: column;
    }
    .warm-up-teams-row {
      background: #BFBFBF;
      padding: 10px 40px;
      min-width: 450px;
    }
    .warm-up-teams-text {
      font-size: 30px;
      font-weight: 900;
      color: #000;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }
    .warm-up-status-row {
      background: #000;
      padding: 10px 40px;
    }
    .warm-up-status-text {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    /* Now Competing Graphic */
    .graphic-now-competing {
      position: absolute;
      bottom: 120px;
      left: 100px;
      display: flex;
      flex-direction: row;
      animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .now-competing-status {
      background: #22c55e;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .now-competing-status-dot {
      width: 14px;
      height: 14px;
      background: #fff;
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.85); }
    }
    .now-competing-status-text {
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .now-competing-logo {
      width: 100px;
      background: #d4d4d8;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .now-competing-logo img {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .now-competing-content {
      display: flex;
      flex-direction: column;
    }
    .now-competing-event {
      background: #d4d4d8;
      padding: 10px 40px;
      min-width: 500px;
      font-size: 24px;
      font-weight: 700;
      color: #000;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .now-competing-details {
      background: #000;
      padding: 14px 40px;
    }
    .now-competing-name {
      font-size: 36px;
      font-weight: 800;
      color: #fff;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .now-competing-team {
      font-size: 22px;
      font-weight: 600;
      color: #a1a1aa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* Frame Overlays for OBS */
    .graphic-frame-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 1920px;
      height: 1080px;
      background: transparent;
    }
    .frame-overlay-container {
      position: absolute;
      top: 10px;
      left: 40px;
      right: 40px;
      bottom: 50px;
    }
    .frame-panel {
      border: 2px solid white;
      background: transparent;
    }
    /* Quad View - 2x2 grid */
    .frame-quad .frame-overlay-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 0;
    }
    /* Tri View Center - 2 top, 1 centered bottom */
    .frame-tri-center .frame-overlay-container {
      display: flex;
      flex-direction: column;
    }
    .frame-tri-center .top-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      flex: 1;
    }
    .frame-tri-center .bottom-row {
      display: flex;
      justify-content: center;
      flex: 1;
    }
    .frame-tri-center .bottom-row .frame-panel {
      width: 50%;
    }
    /* Tri View Wide - 2 top, 1 full-width bottom */
    .frame-tri-wide .frame-overlay-container {
      display: grid;
      grid-template-rows: 1fr 1fr;
    }
    .frame-tri-wide .top-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    /* Single Frame */
    .frame-single .frame-overlay-container {
      display: flex;
    }
    .frame-single .frame-panel {
      width: 100%;
      height: 100%;
    }
    /* Team Header Frame */
    .frame-team-header .header-row {
      position: absolute;
      top: 30px;
      left: 40px;
      right: 40px;
      height: 140px;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    .frame-team-header .team-logo {
      height: 120px;
      width: auto;
      max-width: 200px;
      object-fit: contain;
    }
    .frame-team-header .frame-overlay-container {
      top: 200px;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    /* Virtius watermark for frame overlays */
    .frame-watermark {
      position: absolute;
      bottom: 15px;
      right: 50px;
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      font-weight: bold;
      color: #6b7280;
    }
    .frame-watermark .v {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div id="output"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // Get competition ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const competitionId = urlParams.get('comp');

    if (!competitionId) {
      console.error('No competition ID specified in URL');
      document.body.innerHTML = '<div style="color: red; font-size: 48px; text-align: center; padding: 100px;">ERROR: No competition ID specified. Please access via dashboard.</div>';
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCh0aZUvKl6Qvqsva3hvOgJJlleP1OwcTY",
      authDomain: "gymnastics-graphics.firebaseapp.com",
      databaseURL: "https://gymnastics-graphics-default-rtdb.firebaseio.com",
      projectId: "gymnastics-graphics",
      storageBucket: "gymnastics-graphics.firebasestorage.app",
      messagingSenderId: "702072609550",
      appId: "1:702072609550:web:ac74a811186d3ff45b955f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Firebase headshots cache - loaded once at startup
    let firebaseHeadshots = {};
    let headshotsLoaded = false;

    /**
     * UNIFIED NAME NORMALIZATION - used for both saving and looking up headshots
     * This function must match the normalization in:
     * - show-controller/src/lib/nameNormalization.js
     * - show-controller/src/hooks/useCompetitions.js
     * - show-controller/src/hooks/useTeamsDatabase.js
     *
     * Process:
     * 1. Convert accents to ASCII equivalents (  oe,   e, etc.)
     * 2. Lowercase everything
     * 3. Replace hyphens/underscores with spaces
     * 4. Remove apostrophes
     * 5. Collapse multiple spaces and trim
     */
    function normalizeAccentsUnified(str) {
      if (!str) return '';
      return str
        // German/Swedish umlauts - convert to two-letter equivalents
        .replace(//g, 'oe').replace(//g, 'oe')
        .replace(//g, 'ae').replace(//g, 'ae')
        .replace(//g, 'ue').replace(//g, 'ue')
        .replace(//g, 'ss')
        // French/Spanish/Portuguese accents - convert to base letter
        .replace(/[]/g, 'e').replace(/[]/g, 'e')
        .replace(/[]/g, 'a').replace(/[]/g, 'a')
        .replace(/[]/g, 'i').replace(/[]/g, 'i')
        .replace(/[]/g, 'o').replace(/[]/g, 'o')
        .replace(/[]/g, 'u').replace(/[]/g, 'u')
        .replace(//g, 'n').replace(//g, 'n')
        .replace(//g, 'c').replace(//g, 'c')
        .replace(//g, 'y').replace(//g, 'y')
        // Ligatures
        .replace(//g, 'ae').replace(//g, 'ae')
        .replace(//g, 'oe').replace(//g, 'oe');
    }

    // Remove common name suffixes (Jr., Sr., III, etc.)
    function removeSuffixesUnified(name) {
      if (!name) return '';
      return name
        .replace(/,?\s*(jr\.?|junior|sr\.?|senior|[iv]+|[1-5](?:st|nd|rd|th))$/i, '')
        .trim();
    }

    function normalizeNameUnified(name) {
      if (!name) return '';
      return normalizeAccentsUnified(removeSuffixesUnified(name))
        .toLowerCase()
        .replace(/[-_]/g, ' ')      // Hyphens and underscores to spaces
        .replace(/[''`]/g, '')      // Remove apostrophes (curly and straight)
        .replace(/\s+/g, ' ')       // Collapse multiple spaces
        .trim();
    }

    // Load headshots from Firebase teamsDatabase
    function loadFirebaseHeadshots() {
      db.ref('teamsDatabase/headshots').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        firebaseHeadshots = {};

        // Convert Firebase structure to simple name -> url map
        // Store multiple keys for each headshot to maximize matching
        for (const [key, value] of Object.entries(data)) {
          if (value && value.url) {
            // 1. Store by Firebase key (underscores  spaces)
            const keyWithSpaces = key.toLowerCase().trim().replace(/_/g, ' ').replace(/\s+/g, ' ');
            firebaseHeadshots[keyWithSpaces] = value.url;

            // 2. Store by fully normalized key (handles accents, hyphens, etc.)
            const normalizedKey = normalizeNameUnified(key);
            firebaseHeadshots[normalizedKey] = value.url;

            // 3. Store by name field (original stored name)
            if (value.name) {
              const nameNormalized = normalizeNameUnified(value.name);
              firebaseHeadshots[nameNormalized] = value.url;

              // Also store just lowercased version (in case accents are already normalized)
              const nameLower = value.name.toLowerCase().trim().replace(/\s+/g, ' ');
              firebaseHeadshots[nameLower] = value.url;
            }

            // 4. Store stripped version (only letters and spaces - handles unknown chars)
            const strippedKey = normalizedKey.replace(/[^a-z\s]/g, '').replace(/\s+/g, ' ').trim();
            if (strippedKey && strippedKey.length > 2) {
              firebaseHeadshots[strippedKey] = value.url;
            }

            // 5. Handle 3+ part names - store variants for reverse lookup
            // e.g., "benjamin thurlow lam" also stored as "benjamin lam", "benjamin t lam"
            const parts = normalizedKey.split(' ').filter(Boolean);
            if (parts.length >= 3) {
              // First + Last only (skip middle name)
              const firstLast = `${parts[0]} ${parts[parts.length - 1]}`;
              firebaseHeadshots[firstLast] = value.url;

              // First + Middle initial + Last
              const firstInitialLast = `${parts[0]} ${parts[1][0]} ${parts[parts.length - 1]}`;
              firebaseHeadshots[firstInitialLast] = value.url;

              // For 4+ parts, first two + last
              if (parts.length >= 4) {
                const firstTwoLast = `${parts[0]} ${parts[1]} ${parts[parts.length - 1]}`;
                firebaseHeadshots[firstTwoLast] = value.url;
              }
            }
          }
        }
        headshotsLoaded = true;
        console.log(`Loaded ${Object.keys(firebaseHeadshots).length} headshot entries from Firebase`);
      });
    }

    // Initialize headshots loading
    loadFirebaseHeadshots();

    // Wait for headshots to be loaded (used by graphics that need headshots)
    // Timeout after 5 seconds to avoid hanging forever if Firebase fails
    function waitForHeadshots(maxWaitMs = 5000) {
      return new Promise((resolve) => {
        if (headshotsLoaded) {
          resolve(true);
          return;
        }
        const startTime = Date.now();
        const checkInterval = setInterval(() => {
          if (headshotsLoaded) {
            clearInterval(checkInterval);
            resolve(true);
          } else if (Date.now() - startTime > maxWaitMs) {
            clearInterval(checkInterval);
            console.warn('Timeout waiting for headshots to load from Firebase');
            resolve(false);
          }
        }, 50);
      });
    }

    // Firebase team logos cache - loaded once at startup
    let firebaseTeamLogos = {};

    // Common university name aliases
    const universityAliases = {
      'california': 'cal',
      'uc berkeley': 'cal',
      'berkeley': 'cal',
      'penn state': 'penn-state',
      'pennsylvania state': 'penn-state',
      'michigan': 'michigan',
      'ohio state': 'ohio-state',
      'stanford': 'stanford',
      'oklahoma': 'oklahoma',
      'minnesota': 'minnesota',
      'illinois': 'illinois',
      'nebraska': 'nebraska',
      'iowa': 'iowa',
    };

    // Load team logos from Firebase teamsDatabase
    function loadFirebaseTeamLogos() {
      db.ref('teamsDatabase/teams').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        firebaseTeamLogos = {};
        for (const [key, value] of Object.entries(data)) {
          if (value && value.logo) {
            // Store by team key (e.g., 'army-mens')
            firebaseTeamLogos[key] = value.logo;
            // Also store by school name variations
            if (value.school) {
              const school = value.school.toLowerCase().trim();
              firebaseTeamLogos[school] = value.logo;
              firebaseTeamLogos[`${school} men's`] = value.logo;
              firebaseTeamLogos[`${school} women's`] = value.logo;
            }
            if (value.displayName) {
              firebaseTeamLogos[value.displayName.toLowerCase().trim()] = value.logo;
            }
          }
        }
        // Add aliases that map to existing team logos
        for (const [alias, schoolKey] of Object.entries(universityAliases)) {
          if (firebaseTeamLogos[`${schoolKey}-mens`]) {
            firebaseTeamLogos[alias] = firebaseTeamLogos[`${schoolKey}-mens`];
            firebaseTeamLogos[`${alias} men's`] = firebaseTeamLogos[`${schoolKey}-mens`];
          }
          if (firebaseTeamLogos[`${schoolKey}-womens`]) {
            if (!firebaseTeamLogos[alias]) firebaseTeamLogos[alias] = firebaseTeamLogos[`${schoolKey}-womens`];
            firebaseTeamLogos[`${alias} women's`] = firebaseTeamLogos[`${schoolKey}-womens`];
          }
        }
        console.log(`Loaded ${Object.keys(firebaseTeamLogos).length} team logo entries from Firebase`);
      });
    }

    // Get team logo - checks Firebase first, then falls back to API logo
    // Skips placeholder URLs (via.placeholder.com)
    function getTeamLogoUrl(teamName, apiLogo) {
      // Use API logo if it exists and isn't a placeholder
      if (apiLogo && !apiLogo.includes('via.placeholder.com')) return apiLogo;
      if (!teamName) return '';

      const normalized = teamName.toLowerCase().trim();
      if (firebaseTeamLogos[normalized]) return firebaseTeamLogos[normalized];

      // Try without "Men's" or "Women's" suffix
      const withoutGender = normalized
        .replace(/ men'?s?$/i, '')
        .replace(/ women'?s?$/i, '');
      if (firebaseTeamLogos[withoutGender]) return firebaseTeamLogos[withoutGender];
      if (firebaseTeamLogos[`${withoutGender}-mens`]) return firebaseTeamLogos[`${withoutGender}-mens`];
      if (firebaseTeamLogos[`${withoutGender}-womens`]) return firebaseTeamLogos[`${withoutGender}-womens`];

      // Try with spaces replaced by dashes
      const dashed = withoutGender.replace(/ /g, '-');
      if (firebaseTeamLogos[dashed]) return firebaseTeamLogos[dashed];
      if (firebaseTeamLogos[`${dashed}-mens`]) return firebaseTeamLogos[`${dashed}-mens`];
      if (firebaseTeamLogos[`${dashed}-womens`]) return firebaseTeamLogos[`${dashed}-womens`];

      // Search through all keys for partial matches
      for (const [key, logoUrl] of Object.entries(firebaseTeamLogos)) {
        if (key.includes(withoutGender) || withoutGender.includes(key.replace(/-mens$/, '').replace(/-womens$/, ''))) {
          return logoUrl;
        }
      }

      console.log(`No logo found for team: "${teamName}" (normalized: "${normalized}", withoutGender: "${withoutGender}")`);
      return '';
    }

    // Initialize team logos loading
    loadFirebaseTeamLogos();

    const output = document.getElementById('output');

    // Fetch leaderboard data from Virtius API and render custom table
    // gender parameter controls column visibility (women don't have Exec/SB)
    async function fetchAndRenderLeaderboard(sessionId, eventName, shortCode, gender = 'mens') {
      const contentEl = document.getElementById('leaderboard-content');
      if (!contentEl) return;

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        // Build team logo map from teams data
        const teamLogos = {};
        if (data.meet?.teams) {
          data.meet.teams.forEach(team => {
            if (team.tricode && team.logo) {
              teamLogos[team.tricode] = team.logo;
            }
            if (team.short_name && team.logo) {
              teamLogos[team.short_name] = team.logo;
            }
          });
        }

        // Find the event results
        const eventResults = data.meet?.event_results?.find(e => e.event_name === eventName);
        if (!eventResults || !eventResults.gymnasts) {
          contentEl.innerHTML = '<div class="leaderboard-error">No results found for this event</div>';
          return;
        }

        // Build a map of gymnast_id -> detailed scores from team data FIRST
        // (needed for tiebreaker sorting by execution score)
        // The event_results only has final_score, but team.events[].gymnasts[] has e_score and scores[].start
        const gymnastScores = {};
        if (data.meet?.teams) {
          data.meet.teams.forEach(team => {
            if (team.events) {
              team.events.forEach(event => {
                if (event.event_name === eventName && event.gymnasts) {
                  event.gymnasts.forEach(g => {
                    if (g.gymnast_id) {
                      // Get start value from the first score entry (judge scores)
                      const startValue = g.scores && g.scores.length > 0
                        ? parseFloat(g.scores[0].start) || 0
                        : 0;
                      const execValue = parseFloat(g.e_score) || 0;
                      const ndValue = parseFloat(g.neutral) || 0;
                      const bonusValue = parseFloat(g.bonus) || 0;
                      const finalScore = parseFloat(g.final_score) || 0;

                      // Validation: score = difficulty + execution - neutral + bonus
                      // (e_score already includes the 10.0 base)
                      const calculated = startValue + execValue - ndValue + bonusValue;
                      console.log(`${g.first_name} ${g.last_name}: D=${startValue} E=${execValue} ND=${ndValue} B=${bonusValue} | Calc=${calculated.toFixed(3)} Actual=${finalScore.toFixed(3)}`);

                      gymnastScores[g.gymnast_id] = {
                        start: startValue,
                        exec: execValue,
                        nd: ndValue,
                        bonus: bonusValue
                      };
                    }
                  });
                }
              });
            }
          });
        }
        console.log('Gymnast scores map:', gymnastScores);

        // Sort by place, then by execution score (higher exec wins tiebreaker), limit to top 10
        const gymnasts = eventResults.gymnasts
          .sort((a, b) => {
            const placeA = a.place || 999;
            const placeB = b.place || 999;
            if (placeA !== placeB) return placeA - placeB;
            // Tiebreaker: higher execution score comes first
            const execA = gymnastScores[a.gymnast_id]?.exec || 0;
            const execB = gymnastScores[b.gymnast_id]?.exec || 0;
            return execB - execA; // Descending (higher exec first)
          })
          .slice(0, 10);

        // Calculate diff from leader (scores are strings in API)
        const topScore = parseFloat(gymnasts[0]?.final_score) || 0;

        // Build table HTML - columns vary by gender
        // Men's: #, Name, Team, Apparatus, Score, Diff., Exec., SB
        // Women's: #, Name, Team, Apparatus, Score, Diff. (no Exec or SB)
        const isWomens = gender === 'womens';

        let tableHtml = `
          <table class="leaderboard-table${isWomens ? ' leaderboard-womens' : ''}">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-name">Name</th>
                <th class="col-team">Team</th>
                <th class="col-apparatus">Apparatus</th>
                <th class="col-score">Score</th>
                <th class="col-diff">Diff.</th>
                ${isWomens ? '' : '<th class="col-exec">Exec.</th>'}
                ${isWomens ? '' : '<th class="col-sb">SB</th>'}
              </tr>
            </thead>
            <tbody>
        `;

        // Check for ties - count how many gymnasts share each place
        const placeCounts = {};
        gymnasts.forEach(g => {
          const p = g.place || 999;
          placeCounts[p] = (placeCounts[p] || 0) + 1;
        });

        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const place = g.place || i + 1;
          const isTied = placeCounts[place] > 1;

          // Get detailed scores from the gymnastScores map (built from team data)
          const detailedScores = gymnastScores[g.gymnast_id] || {};
          const dScore = detailedScores.start || 0;
          const eScore = detailedScores.exec || 0;
          // Stick bonus is indicated by bonus > 0 in the API
          const hasStick = detailedScores.bonus > 0;

          // Rank display - medal for 1st/2nd/3rd, with T superscript for ties
          let rankHtml = '';
          if (place === 1) {
            rankHtml = `<span class="leaderboard-medal medal-gold">1</span>`;
          } else if (place === 2) {
            rankHtml = isTied ? `${place}<sup>T</sup>` : `<span class="leaderboard-medal medal-silver">2</span>`;
          } else if (place === 3) {
            rankHtml = isTied ? `${place}<sup>T</sup>` : `<span class="leaderboard-medal medal-bronze">3</span>`;
          } else {
            rankHtml = isTied ? `${place}<sup>T</sup>` : place;
          }

          // Name with colored circle indicator for top 3
          const placeIndicator = place === 1 ? '<span class="place-indicator gold"></span>' :
                                 place === 2 ? '<span class="place-indicator silver"></span>' :
                                 place === 3 ? '<span class="place-indicator bronze"></span>' : '';

          // Team logo - try tricode first, then short_name
          const teamKey = g.tricode || g.short_name || '';
          const logoUrl = teamLogos[teamKey] || '';
          const logoHtml = logoUrl ? `<img class="leaderboard-team-logo" src="${logoUrl}" alt="">` : '';

          // Stick bonus indicator
          const stickHtml = hasStick ? '<span class="stick-bonus">S</span>' : '';

          // Format difficulty - show 1 decimal, execution show 3 decimals
          const dScoreStr = dScore > 0 ? dScore.toFixed(1) : '-';
          const eScoreStr = eScore > 0 ? eScore.toFixed(3) : '-';

          // Use team_name for the team column (short_name is the team abbreviation)
          const teamName = g.team_name || g.short_name || '';

          tableHtml += `
            <tr>
              <td class="col-rank">${rankHtml}</td>
              <td class="col-name">${placeIndicator}${g.full_name || g.last_name || 'Unknown'}</td>
              <td class="col-team">${logoHtml}${teamName}</td>
              <td class="col-apparatus"><span class="apparatus-badge">${shortCode}</span></td>
              <td class="col-score">${score.toFixed(3)}</td>
              <td class="col-diff">${dScoreStr}</td>
              ${isWomens ? '' : `<td class="col-exec">${eScoreStr}</td>`}
              ${isWomens ? '' : `<td class="col-sb">${stickHtml}</td>`}
            </tr>
          `;
        });

        tableHtml += '</tbody></table>';
        contentEl.innerHTML = tableHtml;

      } catch (error) {
        console.error('Leaderboard fetch error:', error);
        contentEl.innerHTML = '<div class="leaderboard-error">Error loading leaderboard</div>';
      }
    }

    // Men's gymnastics events in Olympic order
    const MENS_EVENTS_ORDER = ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'];
    // Women's gymnastics events in Olympic order
    const WOMENS_EVENTS_ORDER = ['VAULT', 'BARS', 'BEAM', 'FLOOR'];

    // Helper to get events order by gender
    function getEventsOrder(gender) {
      return gender === 'womens' ? WOMENS_EVENTS_ORDER : MENS_EVENTS_ORDER;
    }

    const EVENT_DISPLAY_NAMES = {
      'FLOOR': 'Floor Exercise',
      'HORSE': 'Pommel Horse',
      'RINGS': 'Still Rings',
      'VAULT': 'Vault',
      'PBARS': 'Parallel Bars',
      'BAR': 'High Bar',
      // Women's events
      'BARS': 'Uneven Bars',
      'BEAM': 'Balance Beam'
    };
    const EVENT_SHORT_CODES = {
      'FLOOR': 'FX',
      'HORSE': 'PH',
      'RINGS': 'SR',
      'VAULT': 'VT',
      'PBARS': 'PB',
      'BAR': 'HB',
      // Women's events
      'BARS': 'UB',
      'BEAM': 'BB'
    };

    // Team colors database for dynamic themes
    const TEAM_COLORS = {
      'michigan': { primary: '#00274c', secondary: '#ffcb05', bg: '#001a33' },
      'ohio state': { primary: '#bb0000', secondary: '#ffffff', bg: '#660000' },
      'penn state': { primary: '#041e42', secondary: '#ffffff', bg: '#021024' },
      'illinois': { primary: '#e84a27', secondary: '#13294b', bg: '#8a2c17' },
      'minnesota': { primary: '#7a0019', secondary: '#ffcc33', bg: '#4d0010' },
      'iowa': { primary: '#ffcd00', secondary: '#000000', bg: '#9e7f00' },
      'nebraska': { primary: '#d00000', secondary: '#ffffff', bg: '#800000' },
      'california': { primary: '#003262', secondary: '#fdb515', bg: '#001a33' },
      'cal': { primary: '#003262', secondary: '#fdb515', bg: '#001a33' },
      'stanford': { primary: '#8c1515', secondary: '#ffffff', bg: '#4d0c0c' },
      'ucla': { primary: '#2774ae', secondary: '#ffd100', bg: '#164570' },
      'oklahoma': { primary: '#841617', secondary: '#ffffff', bg: '#4a0c0c' },
      'navy': { primary: '#00205b', secondary: '#c4a400', bg: '#001030' },
      'army': { primary: '#c1a875', secondary: '#000000', bg: '#8a7850' },
      'air force': { primary: '#003087', secondary: '#8a8d8f', bg: '#001a45' },
      'william & mary': { primary: '#115740', secondary: '#b29a5b', bg: '#0a3326' },
      'springfield': { primary: '#8b0000', secondary: '#c0a000', bg: '#4d0000' },
      'temple': { primary: '#9d2235', secondary: '#ffffff', bg: '#5a1420' },
      'arizona state': { primary: '#8c1d40', secondary: '#ffc627', bg: '#4d1024' },
      'default': { primary: '#3b82f6', secondary: '#ffffff', bg: '#1e3a5f' }
    };

    // Get team colors by name (case insensitive partial match)
    function getTeamColors(teamName) {
      if (!teamName) return TEAM_COLORS.default;
      const lowerName = teamName.toLowerCase();
      for (const [name, colors] of Object.entries(TEAM_COLORS)) {
        if (name !== 'default' && lowerName.includes(name)) {
          return colors;
        }
      }
      return TEAM_COLORS.default;
    }

    // Available themes for event summary
    const EVENT_SUMMARY_THEMES = {
      'default': 'Default (Dark)',
      'espn': 'ESPN (Red/Gold)',
      'nbc': 'NBC Olympics (Gold)',
      'btn': 'Big Ten Network (Navy)',
      'pac12': 'Pac-12 (Purple/Blue)',
      'virtius': 'Virtius (Minimal Dark)',
      'neon': 'Neon Cyber (Green/Pink)',
      'classic': 'Classic Broadcast',
      'light': 'Minimal Light',
      'home': 'Team Colors (Home)',
      'gradient': 'Team Gradient Split'
    };

    // Athlete headshot library - maps lowercase athlete name to Virtius media URL
    // This allows us to use our own curated headshots instead of API defaults
    const ATHLETE_HEADSHOTS = {
      // Navy
      'aaron stein': 'https://media.virti.us/upload/images/athlete/bVREzuzMfJF5Pi3INKuss',
      'aaron zorgo': 'https://media.virti.us/upload/images/athlete/RNYnjPd8T8bVwuAqicvdA',
      'benjamin thurlow lam': 'https://media.virti.us/upload/images/athlete/ThZW7XIbg2YbyXJ2EnD7H',
      'benjamin venters': 'https://media.virti.us/upload/images/athlete/r-oKniK7q45of_qtKATRp',
      'boone washburn': 'https://media.virti.us/upload/images/athlete/ZQ3tK20Awuf-PB6Xr2tlo',
      'brian solomon': 'https://media.virti.us/upload/images/athlete/zxKpzPO1WD1wuCTqu7yPR',
      'cody phillips': 'https://media.virti.us/upload/images/athlete/CBgJfcoBg99i_6dyApgPK',
      'colby prince': 'https://media.virti.us/upload/images/athlete/G7njrXwnxJ-EEKmGfPNFE',
      'daniel gurevich': 'https://media.virti.us/upload/images/athlete/kkZkc2xI9W89c57kITtbt',
      'danilo viciana': 'https://media.virti.us/upload/images/athlete/cSSPoHA9GXaHtV75aV61n',
      'garrett lawless': 'https://media.virti.us/upload/images/athlete/YbATup9pdxGJULqPmjenU',
      'jonah soltz': 'https://media.virti.us/upload/images/athlete/7Wp4vRjGrChEPu8Mwd_sq',
      'julian galvez': 'https://media.virti.us/upload/images/athlete/5Fmj6ulMKyhrDvUwIKBvm',
      'justin lozano': 'https://media.virti.us/upload/images/athlete/X8uS5pYTvziEg7UctRMTL',
      'kody tokunaga': 'https://media.virti.us/upload/images/athlete/7T-wvjPMsWIpiGClmVOgS',
      'matthew petros': 'https://media.virti.us/upload/images/athlete/Cf_PyziTQlB1O82sDBiww',
      'matthew zeigler': 'https://media.virti.us/upload/images/athlete/a3culpWPBE-_iMG44An6d',
      'mckinley michel': 'https://media.virti.us/upload/images/athlete/Zzm1XxWflm3d6afQPPZFg',
      'michael romo': 'https://media.virti.us/upload/images/athlete/m9Ujh6AViDf4uUUIFKaPQ',
      'payton guillory': 'https://media.virti.us/upload/images/athlete/Ic6oFPMimFW7FMuJtNxMw',
      'saran alexander': 'https://media.virti.us/upload/images/athlete/TrNnHtfYrH5BozHozZzvL',
      'sean armstrong': 'https://media.virti.us/upload/images/athlete/SCrZqcbmFrPnJqOSu77bG',
      // Cal (California)
      'brendan strom': 'https://media.virti.us/upload/images/athlete/1cVXy-T-5mgwnNav4VJ6k',
      'carter kim': 'https://media.virti.us/upload/images/athlete/COfO8fbGgFA_ZBnE37ndJ',
      'davide comparin': 'https://media.virti.us/upload/images/athlete/R8Y1dfHBDHeiszcSGw3Wd',
      'evan wenstad': 'https://media.virti.us/upload/images/athlete/ZmxVIe-6MFDVd1U9wXCdK',
      'finley chin': 'https://media.virti.us/upload/images/athlete/f3STeUMwZ0TVWsu5w6J2b',
      'harry kim': 'https://media.virti.us/upload/images/athlete/hIqN7d97gKOnCC2G_5fk5',
      'jasper smith-gordon': 'https://media.virti.us/upload/images/athlete/ceZUXMm4uDBQSSqVh9zXZ',
      'jaxon mitchell': 'https://media.virti.us/upload/images/athlete/P29GhcR9nqOqN3aVASjaE',
      'jd ehinger': 'https://media.virti.us/upload/images/athlete/kz5pENbBzHno2zd0CllHl',
      'kaien orion': 'https://media.virti.us/upload/images/athlete/wXur_UvfSugKysN6D8Olm',
      'khalen curry': 'https://media.virti.us/upload/images/athlete/nMiYTGBmoDQibJ6cGExHv',
      'liam deweese': 'https://media.virti.us/upload/images/athlete/n9jC3XkZoWTj3D6da3s3M',
      'matteo bardana': 'https://media.virti.us/upload/images/athlete/SmVMJA7m8A6AcYGsi51oD',
      'nathan underhill': 'https://media.virti.us/upload/images/athlete/gLKC-_s0WAuZGXo8LRTzV',
      'sam cirlincione': 'https://media.virti.us/upload/images/athlete/HkzVaqzoshqzieNTnBev7',
      'theodor roald gadderud': 'https://media.virti.us/upload/images/athlete/eMTETdroQg1Nl73PIhR8n',
      'trigg dudley': 'https://media.virti.us/upload/images/athlete/L7dfIQiIDF2ao7T8n4Mm5',
      'troy nuesca': 'https://media.virti.us/upload/images/athlete/iX_ld2SgoQNEyCPNg_ASM',
      'tucker yasunaga': 'https://media.virti.us/upload/images/athlete/EYAEZe97glrJFWqyiReUm',
      'will horenziak': 'https://media.virti.us/upload/images/athlete/3XEFbFASgcKc2x720zZfJ',
      // Stanford
      'arun chhetri': 'https://media.virti.us/upload/images/athlete/j_v4sIFnfBzHUwleTC68X',
      'asher hong': 'https://media.virti.us/upload/images/athlete/aH7Kk874GhAh590PuEVFK',
      'cooper kim': 'https://media.virti.us/upload/images/athlete/0IBtstDrlJxbpErwM_UNp',
      'david shamah': 'https://media.virti.us/upload/images/athlete/QvYoTeG65O4dMEUdjNuBw',
      'deano roberts': 'https://media.virti.us/upload/images/athlete/PYQP_A7cjIs43SZv3i6qb',
      'divier ramos-delgado': 'https://media.virti.us/upload/images/athlete/vJXpAVVkqcDWWnPcbC190',
      'jowy nieves': 'https://media.virti.us/upload/images/athlete/IEXuMRTPVcettEEuebjfV',
      'junnosuke iwai': 'https://media.virti.us/upload/images/athlete/W9sFpRcn6HvjjByDVYpp-',
      'kai uemura': 'https://media.virti.us/upload/images/athlete/n83H-u8_JtPWdGLwlQuzz',
      'kiran mandava': 'https://media.virti.us/upload/images/athlete/yOzUdi_gNYlXjYSer5KfA',
      'marcus kushner': 'https://media.virti.us/upload/images/athlete/fAbKKbZZNJccKh9F8nzWj',
      'marcus pietarinen': 'https://media.virti.us/upload/images/athlete/lOtiWvRbryKEPMpQ14sqK',
      'michael scheiner': 'https://media.virti.us/upload/images/athlete/h59SVg975ou4-i5__6rlH',
      'nick kuebler': 'https://media.virti.us/upload/images/athlete/NohCBsw4JRhcakpVG7BBV',
      'reece landsperger': 'https://media.virti.us/upload/images/athlete/DoN-UgHC2qrI4nbeZg1F6',
      'toma murakawa': 'https://media.virti.us/upload/images/athlete/q-quTVY2a-8bzzI4jnIyd',
      'wade nelson': 'https://media.virti.us/upload/images/athlete/q4wfg5mr_FnE4YrjNwUI6',
      'xander hong': 'https://media.virti.us/upload/images/athlete/quAXgfD40w-f5mLDzqrGQ',
      'zachary green': 'https://media.virti.us/upload/images/athlete/coBnRbQygRwoK6epO36LC',
      // Fisk University (Women's)
      'aiyana thomas': 'https://media.virti.us/upload/images/athlete/QCIWQjesQnaUAKhnE-tnL',
      'aliyah reed-hammon': 'https://media.virti.us/upload/images/athlete/M83B6Hrx3nKLNX9e7PSf6',
      'allie berkley': 'https://media.virti.us/upload/images/athlete/1FM5JNidhdVPTWlCIEYTM',
      'ciniah rosby': 'https://media.virti.us/upload/images/athlete/u46EN0dgCtUgN3sAOoiVy',
      'hadassah diggs': 'https://media.virti.us/upload/images/athlete/i72U-MXljHxgEw8A8r5iy',
      'jordynn cromartie': 'https://media.virti.us/upload/images/athlete/S2DO-FlczUy33MMzfU3uq',
      'kennedi johnson': 'https://media.virti.us/upload/images/athlete/6u82DqwshCFIWiAYtBnbd',
      'liberty mora': 'https://media.virti.us/upload/images/athlete/oyGyeVtmmPQQW0lCFD_w8',
      'makia rosado': 'https://media.virti.us/upload/images/athlete/_6WhV5x-9sKeK3lEIlwjr',
      'sophia pratt': 'https://media.virti.us/upload/images/athlete/X7rB2_ZgSFDXfs0eW8UFr',
      'zanna brewer': 'https://media.virti.us/upload/images/athlete/v0oBQIJ7H0TkxBS55xK47',
      'zyia coleman': 'https://media.virti.us/upload/images/athlete/kXS5CGn6ch1iQYC3YRFT5',
      // Centenary College (Women's)
      'amy foret': 'https://media.virti.us/upload/images/athlete/YSWTModYqlsFZK3WdnrzK',
      'anna ichiba': 'https://media.virti.us/upload/images/athlete/Fvt_cH77bWufJ6juvuLZR',
      'brooke murdock': 'https://media.virti.us/upload/images/athlete/TwDo2-r9291i3bb5oVzVC',
      'cecilia paredes': 'https://media.virti.us/upload/images/athlete/GiglP2tBIueo166zWsS7d',
      'chloe gilbert': 'https://media.virti.us/upload/images/athlete/MmdqdhRFTWjiOnBSBi61B',
      'claire flores': 'https://media.virti.us/upload/images/athlete/YQeKZjm_C3LHO6Ne7G287',
      'erin pinder': 'https://media.virti.us/upload/images/athlete/s3wYoVHXVoLMulUc15Xyd',
      'hayden cagle': 'https://media.virti.us/upload/images/athlete/4SPIOiKHVs07SAZwDWbXQ',
      'lelia dunlavy': 'https://media.virti.us/upload/images/athlete/KugvvPNIFcWhwFQjE04cP',
      'mallory stephens': 'https://media.virti.us/upload/images/athlete/xSsPI3ZZ2wp14L-g0oQbK',
      'molly english': 'https://media.virti.us/upload/images/athlete/WxKykVl1ufwVxRVCw6iGO',
      'nyah washington': 'https://media.virti.us/upload/images/athlete/BRnuNCn2gSFlC2WDDwP1D',
      'olivia montgomery': 'https://media.virti.us/upload/images/athlete/FzXmVWGhGkfm7OtLm55q1',
      'olivia stratmann': 'https://media.virti.us/upload/images/athlete/Ub9lMyNwtBW8TPnx4nrbv',
      'olivia williams': 'https://media.virti.us/upload/images/athlete/qGG7TVOvXqk5K5sUxGGHN',
      'peyton burford': 'https://media.virti.us/upload/images/athlete/vnemcpLN8OwerOEuAPacV',
      'riley navarro': 'https://media.virti.us/upload/images/athlete/dEyNMURLSl7Rw-SIO1hwt',
      'skyla cruz': 'https://media.virti.us/upload/images/athlete/ChsX3x1OD2yJiwnpV8kts',
      // Wilberforce (Women's)
      'carli finkley': 'https://media.virti.us/upload/images/athlete/jRQJcUOc-91YvL4TF9Gpp',
      'danielle johnson': 'https://media.virti.us/upload/images/athlete/M2kvQSaF6z4Yp6VeoqurV',
      'diamond cook': 'https://media.virti.us/upload/images/athlete/dh8QK5ckClYJSNysBpEBe',
      'emily herrera': 'https://media.virti.us/upload/images/athlete/yciQBEg0HXty3ugDhlwHK',
      'hannah gouldbourne': 'https://media.virti.us/upload/images/athlete/LtoKResa_Bc0u0ZXB_mJx',
      'jaidyn bryant': 'https://media.virti.us/upload/images/athlete/EOLLc780NzbKv6loHhCuX',
      'kaleigh garner': 'https://media.virti.us/upload/images/athlete/rjSs6Hu8q7ympHQ2ZQ1Ng',
      'mackenzie butler': 'https://media.virti.us/upload/images/athlete/V2CeS42mKVR7It524CAWR',
      'madison kelly': 'https://media.virti.us/upload/images/athlete/plCiU8VPx_qLs3YnMVgIx',
      'makiyah davis': 'https://media.virti.us/upload/images/athlete/1Di7Al76uWLhA2sCCar-A',
      'mikayla clements': 'https://media.virti.us/upload/images/athlete/1O41JjAQjiNnR7Uhqq4Oo',
      'myca kelly': 'https://media.virti.us/upload/images/athlete/2W1DlvcyZZHA5rbdwyGLf',
      'myna caines': 'https://media.virti.us/upload/images/athlete/iKFe8UAfJuPWUgwJCDA7g',
      "n'diah brown": 'https://media.virti.us/upload/images/athlete/rf6EYRlhPtyVIaZxx4fhI',
      'nishayla riley': 'https://media.virti.us/upload/images/athlete/87iqde2o7Ht-wZFtMhrc_',
      'promise jean-marie': 'https://media.virti.us/upload/images/athlete/OWZun71ChfPJeV8bIAhX4',
      'sadara mayhorn': 'https://media.virti.us/upload/images/athlete/1pSuBF5AyDypHc4yRc00q',
      'saniah smith': 'https://media.virti.us/upload/images/athlete/GdDVF4oxa-aNTcjolceBC',
      'sydney smith': 'https://media.virti.us/upload/images/athlete/UoRyzVz2LksoEoTj8iSIC',
      // Greenville (Women's)
      'alessia russo': 'https://media.virti.us/upload/images/athlete/smkg4wf_S-ihWRpjgSDFX',
      'alexis stonebraker': 'https://media.virti.us/upload/images/athlete/JF-_Ra50E-f_HcveHgbDS',
      'amara nelson': 'https://media.virti.us/upload/images/athlete/1tGFjzE1os0N5y7g7gQe7',
      'aubrey kenimer': 'https://media.virti.us/upload/images/athlete/7eLgaVnOWsM19QDXn9DIc',
      'christianna cutler': 'https://media.virti.us/upload/images/athlete/UeBdwZMa1LOlYrkDNisQH',
      'ellery gilmer': 'https://media.virti.us/upload/images/athlete/TKHPU0R_3rjvgi_xwm6X5',
      'elli schnieders': 'https://media.virti.us/upload/images/athlete/-OcZrBQdnQA4jiSKVarAx',
      'emma brannon': 'https://media.virti.us/upload/images/athlete/qxlRn2xGi20UwMTOZfwwk',
      'faye jones': 'https://media.virti.us/upload/images/athlete/bLP-Hntcp9yXOhtAo60NJ',
      'isabella feltman': 'https://media.virti.us/upload/images/athlete/3VoKov015ClGqzt9HL4-T',
      'izabella yanis': 'https://media.virti.us/upload/images/athlete/5Y-yKeMM1M1ivbJLU1tW7',
      'laila manley': 'https://media.virti.us/upload/images/athlete/-E8-v9NHgPXuhOSWPGZAb',
      'madison carter': 'https://media.virti.us/upload/images/athlete/SGQWkwNtuLvlWIin7dfCM',
      'madison ford': 'https://media.virti.us/upload/images/athlete/kPVDaeF31R4iso9-ZlJt1',
      'matilda brougham': 'https://media.virti.us/upload/images/athlete/9MnxatWgy46cgqdPDMY3L',
      'maycee mcknight': 'https://media.virti.us/upload/images/athlete/cR2UZ1w6XfaF4eyYieq7G',
      'naima murray': 'https://media.virti.us/upload/images/athlete/ToXEjbKMGSBAjdolhdcvE',
      'olivia tocco': 'https://media.virti.us/upload/images/athlete/KnlNsoKjFdGlJCo6g44-1',
      'reagan rodriguez': 'https://media.virti.us/upload/images/athlete/pSF0sqJQ7c4Dyjp_UaVgl',
      'reese clapper': 'https://media.virti.us/upload/images/athlete/xOxDOKLTx5B2F_Z5OxG_X',
      'roya zehtab': 'https://media.virti.us/upload/images/athlete/7maWXHWLsZvg9X6rcrSYS',
      'taylor templin': 'https://media.virti.us/upload/images/athlete/MAu3yL7pFaNCiAYWH2-Mo',
      'valeria arraiz': 'https://media.virti.us/upload/images/athlete/CXnHDBhbLTupvDgyQyIwm',
    };

    // Look up athlete headshot - checks Firebase first, then static library, then API headshot
    // Uses unified normalization (normalizeNameUnified) defined above
    // Handles 3+ part names (e.g., "Benjamin Thurlow Lam")
    function getAthleteHeadshot(firstName, lastName, apiHeadshot) {
      if (!firstName && !lastName) return apiHeadshot || '';

      // Build full name for lookup
      const rawFullName = `${firstName || ''} ${lastName || ''}`.trim();
      const normalized = normalizeNameUnified(rawFullName);
      const stripped = normalized.replace(/[^a-z\s]/g, '').replace(/\s+/g, ' ').trim();

      // Generate multiple lookup keys to maximize matching
      const lookupKeys = [
        // 1. Original lowercase (exact match)
        rawFullName.toLowerCase().replace(/\s+/g, ' ').trim(),
        // 2. Fully normalized (unified normalization)
        normalized,
        // 3. Stripped (only letters and spaces)
        stripped,
      ];

      // 4. Handle 3+ part names (e.g., "Benjamin Thurlow Lam")
      const parts = normalized.split(' ').filter(Boolean);
      if (parts.length >= 3) {
        // First + Last only (skip middle name)
        lookupKeys.push(`${parts[0]} ${parts[parts.length - 1]}`);
        // First + Middle initial + Last
        lookupKeys.push(`${parts[0]} ${parts[1][0]} ${parts[parts.length - 1]}`);
        // For 4+ parts, try first two + last
        if (parts.length >= 4) {
          lookupKeys.push(`${parts[0]} ${parts[1]} ${parts[parts.length - 1]}`);
        }
      }

      // 5. Handle case where firstName contains multiple parts
      const firstParts = (firstName || '').trim().split(/\s+/).filter(Boolean);
      if (firstParts.length >= 2 && lastName) {
        // Just first part of firstName + lastName
        lookupKeys.push(`${normalizeNameUnified(firstParts[0])} ${normalizeNameUnified(lastName)}`);
        // First part + initial + lastName
        lookupKeys.push(`${normalizeNameUnified(firstParts[0])} ${firstParts[1][0].toLowerCase()} ${normalizeNameUnified(lastName)}`);
      }

      // Remove duplicates and empty strings
      const uniqueKeys = [...new Set(lookupKeys.filter(Boolean))];

      // Try each key against Firebase headshots
      for (const key of uniqueKeys) {
        if (firebaseHeadshots[key]) {
          return firebaseHeadshots[key];
        }
      }

      // Try each key against static library
      for (const key of uniqueKeys) {
        if (ATHLETE_HEADSHOTS[key]) {
          return ATHLETE_HEADSHOTS[key];
        }
      }

      // Debug: log when no headshot found (only if not found after all attempts)
      console.log(`No headshot found for: "${rawFullName}" (tried keys: ${uniqueKeys.join(', ')})`);

      // Fall back to API headshot
      return apiHeadshot || '';
    }

    // Handle image load errors gracefully - hide broken images
    // Called via onerror="handleImageError(this)"
    function handleImageError(img) {
      // Hide the broken image and show placeholder styling instead
      img.style.display = 'none';
      // Create a placeholder div to replace it
      const placeholder = document.createElement('div');
      placeholder.className = img.className;
      placeholder.style.background = '#52525b';
      placeholder.style.minWidth = img.width ? img.width + 'px' : '60px';
      placeholder.style.minHeight = img.height ? img.height + 'px' : '60px';
      img.parentNode.insertBefore(placeholder, img);
    }

    // Generate athlete photo HTML with error handling
    function renderAthletePhoto(photoUrl, className = 'athlete-photo') {
      if (photoUrl) {
        return `<img class="${className}" src="${photoUrl}" alt="" referrerpolicy="no-referrer" onerror="handleImageError(this)">`;
      }
      return `<div class="${className}" style="background: #52525b;"></div>`;
    }

    // ============================================================================
    // ROTATION SCHEDULE TEMPLATES
    // ============================================================================
    // Standard NCAA rotation patterns for different meet types.
    // schedule[rotation][eventId] = teamOrder (0-indexed) or array for head-to-head
    // null = no team on that event

    const ROTATION_SCHEDULES = {
      // Women's meets (4 events: vault=0, bars=1, beam=2, floor=3)
      'womens-dual-headtohead': {
        rotationCount: 4,
        eventOrder: ['VAULT', 'BARS', 'BEAM', 'FLOOR'],
        schedule: {
          1: { VAULT: [0, 1], BARS: null, BEAM: null, FLOOR: null },
          2: { VAULT: null, BARS: [0, 1], BEAM: null, FLOOR: null },
          3: { VAULT: null, BARS: null, BEAM: [0, 1], FLOOR: null },
          4: { VAULT: null, BARS: null, BEAM: null, FLOOR: [0, 1] },
        },
      },
      'womens-dual-alternating': {
        rotationCount: 4,
        eventOrder: ['VAULT', 'BARS', 'BEAM', 'FLOOR'],
        schedule: {
          1: { VAULT: 0, BARS: 1, BEAM: null, FLOOR: null },
          2: { VAULT: 1, BARS: 0, BEAM: null, FLOOR: null },
          3: { VAULT: null, BARS: null, BEAM: 0, FLOOR: 1 },
          4: { VAULT: null, BARS: null, BEAM: 1, FLOOR: 0 },
        },
      },
      'womens-tri': {
        rotationCount: 4,
        eventOrder: ['VAULT', 'BARS', 'BEAM', 'FLOOR'],
        schedule: {
          1: { VAULT: 0, BARS: 1, BEAM: 2, FLOOR: null },
          2: { VAULT: null, BARS: 0, BEAM: 1, FLOOR: 2 },
          3: { VAULT: 2, BARS: null, BEAM: 0, FLOOR: 1 },
          4: { VAULT: 1, BARS: 2, BEAM: null, FLOOR: 0 },
        },
      },
      'womens-quad': {
        rotationCount: 4,
        eventOrder: ['VAULT', 'BARS', 'BEAM', 'FLOOR'],
        schedule: {
          1: { VAULT: 0, BARS: 1, BEAM: 2, FLOOR: 3 },
          2: { VAULT: 1, BARS: 2, BEAM: 3, FLOOR: 0 },
          3: { VAULT: 2, BARS: 3, BEAM: 0, FLOOR: 1 },
          4: { VAULT: 3, BARS: 0, BEAM: 1, FLOOR: 2 },
        },
      },

      // Men's meets (6 events: floor=0, pommel=1, rings=2, vault=3, pBars=4, hBar=5)
      'mens-dual-headtohead': {
        rotationCount: 6,
        eventOrder: ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'],
        schedule: {
          1: { FLOOR: [0, 1], HORSE: null, RINGS: null, VAULT: null, PBARS: null, BAR: null },
          2: { FLOOR: null, HORSE: [0, 1], RINGS: null, VAULT: null, PBARS: null, BAR: null },
          3: { FLOOR: null, HORSE: null, RINGS: [0, 1], VAULT: null, PBARS: null, BAR: null },
          4: { FLOOR: null, HORSE: null, RINGS: null, VAULT: [0, 1], PBARS: null, BAR: null },
          5: { FLOOR: null, HORSE: null, RINGS: null, VAULT: null, PBARS: [0, 1], BAR: null },
          6: { FLOOR: null, HORSE: null, RINGS: null, VAULT: null, PBARS: null, BAR: [0, 1] },
        },
      },
      'mens-dual-alternating': {
        rotationCount: 6,
        eventOrder: ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'],
        schedule: {
          1: { FLOOR: 0, HORSE: 1, RINGS: null, VAULT: null, PBARS: null, BAR: null },
          2: { FLOOR: 1, HORSE: 0, RINGS: null, VAULT: null, PBARS: null, BAR: null },
          3: { FLOOR: null, HORSE: null, RINGS: 0, VAULT: 1, PBARS: null, BAR: null },
          4: { FLOOR: null, HORSE: null, RINGS: 1, VAULT: 0, PBARS: null, BAR: null },
          5: { FLOOR: null, HORSE: null, RINGS: null, VAULT: null, PBARS: 0, BAR: 1 },
          6: { FLOOR: null, HORSE: null, RINGS: null, VAULT: null, PBARS: 1, BAR: 0 },
        },
      },
      'mens-tri': {
        rotationCount: 6,
        eventOrder: ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'],
        schedule: {
          1: { FLOOR: 0, HORSE: null, RINGS: 1, VAULT: null, PBARS: 2, BAR: null },
          2: { FLOOR: null, HORSE: 0, RINGS: null, VAULT: 1, PBARS: null, BAR: 2 },
          3: { FLOOR: 2, HORSE: null, RINGS: 0, VAULT: null, PBARS: 1, BAR: null },
          4: { FLOOR: null, HORSE: 2, RINGS: null, VAULT: 0, PBARS: null, BAR: 1 },
          5: { FLOOR: 1, HORSE: null, RINGS: 2, VAULT: null, PBARS: 0, BAR: null },
          6: { FLOOR: null, HORSE: 1, RINGS: null, VAULT: 2, PBARS: null, BAR: 0 },
        },
      },
      'mens-quad': {
        rotationCount: 6,
        eventOrder: ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'],
        schedule: {
          1: { FLOOR: 0, HORSE: 1, RINGS: 2, VAULT: 3, PBARS: null, BAR: null },
          2: { FLOOR: null, HORSE: 0, RINGS: 1, VAULT: 2, PBARS: 3, BAR: null },
          3: { FLOOR: null, HORSE: null, RINGS: 0, VAULT: 1, PBARS: 2, BAR: 3 },
          4: { FLOOR: 3, HORSE: null, RINGS: null, VAULT: 0, PBARS: 1, BAR: 2 },
          5: { FLOOR: 2, HORSE: 3, RINGS: null, VAULT: null, PBARS: 0, BAR: 1 },
          6: { FLOOR: 1, HORSE: 2, RINGS: 3, VAULT: null, PBARS: null, BAR: 0 },
        },
      },
    };

    // Get the schedule key based on competition parameters
    function getScheduleKey(numTeams, competitionFormat, gender = 'mens') {
      const genderPrefix = gender === 'womens' ? 'womens' : 'mens';

      if (numTeams === 2) {
        // Dual meet - check format
        if (competitionFormat === 'head-to-head') {
          return `${genderPrefix}-dual-headtohead`;
        } else if (competitionFormat === 'alternating') {
          return `${genderPrefix}-dual-alternating`;
        }
        return `${genderPrefix}-dual-headtohead`; // default
      } else if (numTeams === 3) {
        return `${genderPrefix}-tri`;
      } else if (numTeams >= 4) {
        return `${genderPrefix}-quad`;
      }
      return `${genderPrefix}-dual-headtohead`; // fallback
    }

    // Get all events active in a rotation with their team assignments
    // Returns array of { eventName, teamOrders: number[] }
    function getEventsInRotation(rotation, numTeams, competitionFormat, gender = 'mens') {
      const scheduleKey = getScheduleKey(numTeams, competitionFormat, gender);
      const schedule = ROTATION_SCHEDULES[scheduleKey];

      if (!schedule || !schedule.schedule[rotation]) {
        // Fallback: all events with no specific assignment
        const events = gender === 'womens'
          ? ['VAULT', 'BARS', 'BEAM', 'FLOOR']
          : ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'];
        return events.map(e => ({ eventName: e, teamOrders: [0] }));
      }

      const rotationSchedule = schedule.schedule[rotation];
      const events = [];

      for (const [eventName, teamValue] of Object.entries(rotationSchedule)) {
        if (teamValue !== null) {
          const teamOrders = Array.isArray(teamValue) ? teamValue : [teamValue];
          events.push({ eventName, teamOrders });
        }
      }

      // Sort by event order
      const eventOrder = schedule.eventOrder || [];
      events.sort((a, b) => eventOrder.indexOf(a.eventName) - eventOrder.indexOf(b.eventName));

      return events;
    }

    // Calculate which event a team is on for a given rotation
    // Returns the event name (API format like 'FLOOR', 'HORSE', etc.)
    // - Head-to-head: Both teams compete on the SAME apparatus (Floor, then PH, etc.)
    // - Alternating: Teams start on different events and swap every rotation
    // - Multi-team (tri/quad): Different teams on different events each rotation
    function getTeamEventForRotation(teamOrder, rotation, numTeams, competitionFormat, gender = 'mens') {
      // teamOrder is 0-indexed (0 = home/team1, 1 = away/team2, etc.), rotation is 1-indexed
      const scheduleKey = getScheduleKey(numTeams, competitionFormat, gender);
      const schedule = ROTATION_SCHEDULES[scheduleKey];

      if (!schedule || !schedule.schedule[rotation]) {
        // Fallback to legacy behavior for men's events
        if (competitionFormat === 'head-to-head') {
          return MENS_EVENTS_ORDER[(rotation - 1) % 6];
        }
        // Alternating fallback
        const pairIndex = Math.floor((rotation - 1) / 2);
        const isSecondInPair = (rotation - 1) % 2 === 1;
        const baseEvent = pairIndex * 2;
        const eventIndex = teamOrder === 0
          ? (isSecondInPair ? baseEvent + 1 : baseEvent)
          : (isSecondInPair ? baseEvent : baseEvent + 1);
        return MENS_EVENTS_ORDER[eventIndex];
      }

      // Look up which event this team is on from the schedule
      const rotationSchedule = schedule.schedule[rotation];

      for (const [eventName, teamValue] of Object.entries(rotationSchedule)) {
        if (teamValue !== null) {
          if (Array.isArray(teamValue)) {
            // Head-to-head: array of team orders
            if (teamValue.includes(teamOrder)) {
              return eventName;
            }
          } else if (teamValue === teamOrder) {
            // Single team on this event
            return eventName;
          }
        }
      }

      // Team has a bye this rotation (no event)
      return null;
    }

    // Fetch event summary data from Virtius API and render rotation view
    async function fetchAndRenderEventSummary(sessionId, rotation, numTeams, competitionFormat, layout = 'default', gender = 'mens') {
      const contentEl = document.getElementById('event-summary-content');
      if (!contentEl) return;

      // Wait for headshots to be loaded before rendering
      await waitForHeadshots();

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        const teams = data.meet?.teams || [];
        if (teams.length === 0) {
          contentEl.innerHTML = '<div class="event-summary-error">No teams found</div>';
          return;
        }

        // Sort teams by team_order
        const sortedTeams = [...teams].sort((a, b) => (a.team_order || 0) - (b.team_order || 0));

        // Determine if this is a dual meet (2 teams) or multi-team (3+)
        const isDual = sortedTeams.length === 2;
        const actualNumTeams = Math.min(sortedTeams.length, numTeams || sortedTeams.length);

        // Build rotation data for each team
        // getTeamEventForRotation now returns the event name directly (e.g., 'FLOOR', 'VAULT', 'BARS')
        const rotationData = sortedTeams.slice(0, actualNumTeams).map((team, idx) => {
          const eventName = getTeamEventForRotation(idx, rotation, actualNumTeams, competitionFormat, gender);
          const teamEvent = team.events?.find(e => e.event_name === eventName);
          const gymnasts = teamEvent?.gymnasts?.sort((a, b) => (a.order || 0) - (b.order || 0)) || [];
          const eventScore = parseFloat(teamEvent?.event_score) || 0;
          const totalScore = parseFloat(team.final_score) || 0;

          return {
            team,
            eventName,
            eventDisplayName: EVENT_DISPLAY_NAMES[eventName] || eventName,
            eventShortCode: EVENT_SHORT_CODES[eventName] || eventName,
            gymnasts,
            eventScore,
            totalScore
          };
        });

        // Render based on meet type and layout
        if (isDual) {
          // Check if using a specific layout
          if (layout === 'broadcast-table') {
            renderBroadcastTableLayout(contentEl, rotationData, rotation);
          } else if (layout === 'classic-broadcast') {
            renderClassicBroadcastLayout(contentEl, rotationData, rotation);
          } else if (layout === 'default-v2') {
            renderDefaultV2Layout(contentEl, rotationData, rotation);
          } else if (layout === 'default-v3') {
            // V3 works for both dual and multi-team
            renderMultiTeamSummaryV3(contentEl, rotationData, rotation, actualNumTeams);
          } else if (layout === 'default-v4') {
            // V4: V3 with team rankings and totals
            renderMultiTeamSummaryV4(contentEl, rotationData, rotation, actualNumTeams);
          } else {
            renderDualMeetSummary(contentEl, rotationData, rotation);
          }
        } else {
          // Multi-team meet (3+ teams)
          if (layout === 'default-v3') {
            renderMultiTeamSummaryV3(contentEl, rotationData, rotation, actualNumTeams);
          } else if (layout === 'default-v4') {
            renderMultiTeamSummaryV4(contentEl, rotationData, rotation, actualNumTeams);
          } else {
            renderMultiTeamSummary(contentEl, rotationData, rotation, actualNumTeams);
          }
        }

      } catch (error) {
        console.error('Event summary fetch error:', error);
        contentEl.innerHTML = '<div class="event-summary-error">Error loading event summary</div>';
      }
    }

    // SVG icons for events
    const EVENT_ICONS = {
      'FX': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="18" width="20" height="4" rx="1"/><rect x="4" y="14" width="16" height="2" rx="0.5"/></svg>`,
      'PH': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><ellipse cx="12" cy="12" rx="10" ry="4"/><rect x="6" y="4" width="2" height="8" rx="1"/><rect x="16" y="4" width="2" height="8" rx="1"/></svg>`,
      'SR': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><circle cx="7" cy="16" r="4" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="17" cy="16" r="4" stroke="currentColor" stroke-width="2" fill="none"/><line x1="7" y1="12" x2="7" y2="4" stroke="currentColor" stroke-width="2"/><line x1="17" y1="12" x2="17" y2="4" stroke="currentColor" stroke-width="2"/></svg>`,
      'VT': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><rect x="8" y="8" width="8" height="12" rx="1" transform="rotate(-15 12 14)"/><rect x="2" y="18" width="6" height="4" rx="1"/></svg>`,
      'PB': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="10" width="18" height="2" rx="1"/><rect x="3" y="16" width="18" height="2" rx="1"/><rect x="5" y="8" width="2" height="12" rx="0.5"/><rect x="17" y="8" width="2" height="12" rx="0.5"/></svg>`,
      'HB': `<svg class="event-icon" viewBox="0 0 24 24" fill="currentColor"><rect x="2" y="10" width="20" height="2" rx="1"/><rect x="4" y="10" width="2" height="10" rx="0.5"/><rect x="18" y="10" width="2" height="10" rx="0.5"/></svg>`,
    };

    // Render dual meet layout (2 teams side-by-side with center divider)
    function renderDualMeetSummary(contentEl, rotationData, rotation) {
      const team1 = rotationData[0];
      const team2 = rotationData[1];

      // Calculate score differences for each lineup position
      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildTeamColumn(team1, 'left', maxAthletes);
      const rightColumn = buildTeamColumn(team2, 'right', maxAthletes);

      // Build center divider with visual diff bars
      let centerHtml = `<div class="center-divider"><div class="center-header"><div class="rotation-badge">R${rotation}</div></div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        // Calculate bar width (max diff around 2.0 points maps to 50% width)
        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        centerHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons
      const footerHtml = `
        <div class="event-summary-footer">
          <div class="footer-team left">
            <div class="event-abbr">${team1.eventShortCode}</div>
            ${EVENT_ICONS[team1.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${team2.eventShortCode}</div>
            ${EVENT_ICONS[team2.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="event-summary-dual">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // Build a team column for dual meet layout
    function buildTeamColumn(teamData, side, maxAthletes) {
      const { team, gymnasts, totalScore, eventShortCode } = teamData;

      let athletesHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const g = gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          // Get start value from scores array
          const startValue = g.scores && g.scores.length > 0 ? parseFloat(g.scores[0].start) || 0 : 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          // Look up headshot from library first, fall back to API headshot
          const photoUrl = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              ${renderAthletePhoto(photoUrl)}
              <div class="athlete-name">${name}</div>
              <div class="athlete-score-block">
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : 'On Eval'}</div>
                ${startValue > 0 ? `<div class="athlete-start">${startValue.toFixed(1)}</div>` : ''}
              </div>
            </div>
          `;
        } else {
          athletesHtml += `<div class="athlete-row" style="min-height: 72px;"></div>`;
        }
      }

      const logoUrl = getTeamLogoUrl(team.name, team.logo);
      return `
        <div class="team-column ${side}">
          <div class="team-header ${side}">
            ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
            <div class="team-name">${team.name || team.tricode}</div>
            <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : ''}</div>
          </div>
          <div class="athlete-list">
            ${athletesHtml}
          </div>
        </div>
      `;
    }

    // Render multi-team layout (quad meet - 4 columns)
    function renderMultiTeamSummary(contentEl, rotationData, rotation, numTeams) {
      let columnsHtml = '';

      rotationData.forEach(teamData => {
        const { team, eventDisplayName, eventShortCode, gymnasts, eventScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);

        let athletesHtml = '';
        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              <div class="athlete-name">${name}</div>
              <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        });

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad">${columnsHtml}</div>`;
    }

    // Render multi-team layout V3 (full-height symmetric rows)
    // Key features:
    // - All columns have same number of rows (max across all teams, capped at 10)
    // - Rows stretch to fill available height equally
    // - Empty rows are styled consistently
    // - No headshots, clean text-only design
    function renderMultiTeamSummaryV3(contentEl, rotationData, rotation, numTeams) {
      // Find max athletes across all teams (cap at 10)
      const maxAthletes = Math.min(
        Math.max(...rotationData.map(t => t.gymnasts.length)),
        10
      );

      let columnsHtml = '';

      rotationData.forEach(teamData => {
        const { team, eventDisplayName, gymnasts, eventScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);

        // Build athlete rows - pad to maxAthletes for symmetry
        let athletesHtml = '';
        for (let i = 0; i < maxAthletes; i++) {
          const g = gymnasts[i];
          if (g) {
            const score = parseFloat(g.final_score) || 0;
            const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
            athletesHtml += `
              <div class="athlete-row">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name">${name}</div>
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
              </div>
            `;
          } else {
            // Empty placeholder row for symmetry
            athletesHtml += `
              <div class="athlete-row empty">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name"></div>
                <div class="athlete-score"></div>
              </div>
            `;
          }
        }

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad-v3 teams-${numTeams}">${columnsHtml}</div>`;
    }

    // Render multi-team apparatus layout V3 (all teams on same event, full-height)
    function renderMultiTeamSummaryApparatusV3(contentEl, apparatusData, eventDisplayName, eventShortCode, numTeams) {
      // Find max athletes across all teams (cap at 10)
      const maxAthletes = Math.min(
        Math.max(...apparatusData.map(t => t.gymnasts.length)),
        10
      );

      let columnsHtml = '';

      apparatusData.forEach(teamData => {
        const { team, gymnasts, eventScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);

        // Build athlete rows - pad to maxAthletes for symmetry
        let athletesHtml = '';
        for (let i = 0; i < maxAthletes; i++) {
          const g = gymnasts[i];
          if (g) {
            const score = parseFloat(g.final_score) || 0;
            const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
            athletesHtml += `
              <div class="athlete-row">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name">${name}</div>
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
              </div>
            `;
          } else {
            // Empty placeholder row for symmetry
            athletesHtml += `
              <div class="athlete-row empty">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name"></div>
                <div class="athlete-score"></div>
              </div>
            `;
          }
        }

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad-v3 teams-${numTeams}">${columnsHtml}</div>`;
    }

    // V4 Layout: Based on V3 with team rankings and totals in header
    // Key features:
    // - Team ranking displayed at top of header (1st, 2nd, 3rd with colored badges)
    // - Team total score prominently displayed below logo/name
    // - Event name shown below total as subtle label
    // - All columns have same number of rows (max across all teams, capped at 10)
    function renderMultiTeamSummaryV4(contentEl, rotationData, rotation, numTeams) {
      // Find max athletes across all teams (cap at 10)
      const maxAthletes = Math.min(
        Math.max(...rotationData.map(t => t.gymnasts.length)),
        10
      );

      // Calculate rankings based on total score
      const teamsWithRanks = rotationData.map(t => ({
        ...t,
        totalScore: t.totalScore || 0
      }));

      // Sort by total score descending to determine ranks
      const sortedByScore = [...teamsWithRanks].sort((a, b) => b.totalScore - a.totalScore);
      const rankMap = new Map();
      sortedByScore.forEach((t, idx) => {
        rankMap.set(t.team.name || t.team.tricode, idx + 1);
      });

      let columnsHtml = '';

      rotationData.forEach(teamData => {
        const { team, eventDisplayName, gymnasts, eventScore, totalScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);
        const teamName = team.name || team.tricode;
        const rank = rankMap.get(teamName) || 0;

        // Rank display with ordinal suffix
        const rankSuffix = rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th';
        const rankText = totalScore > 0 ? `${rank}${rankSuffix} Place` : '';
        const rankClass = rank <= 3 && totalScore > 0 ? `rank-${rank}` : '';

        // Build athlete rows - pad to maxAthletes for symmetry
        let athletesHtml = '';
        for (let i = 0; i < maxAthletes; i++) {
          const g = gymnasts[i];
          if (g) {
            const score = parseFloat(g.final_score) || 0;
            const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
            athletesHtml += `
              <div class="athlete-row">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name">${name}</div>
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
              </div>
            `;
          } else {
            // Empty placeholder row for symmetry
            athletesHtml += `
              <div class="athlete-row empty">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name"></div>
                <div class="athlete-score"></div>
              </div>
            `;
          }
        }

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="header-line1">
                <div class="team-rank ${rankClass}">${rank}${rankSuffix}</div>
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
                <div class="team-name">${teamName}</div>
              </div>
              <div class="header-line2">
                <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : ''}</div>
                <div class="event-label">${eventDisplayName}</div>
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad-v4 teams-${numTeams}">${columnsHtml}</div>`;
    }

    // Render multi-team apparatus layout V4 (all teams on same event, with rankings)
    function renderMultiTeamSummaryApparatusV4(contentEl, apparatusData, eventDisplayName, eventShortCode, numTeams) {
      // Find max athletes across all teams (cap at 10)
      const maxAthletes = Math.min(
        Math.max(...apparatusData.map(t => t.gymnasts.length)),
        10
      );

      // Calculate rankings based on total score
      const teamsWithRanks = apparatusData.map(t => ({
        ...t,
        totalScore: t.totalScore || 0
      }));

      // Sort by total score descending to determine ranks
      const sortedByScore = [...teamsWithRanks].sort((a, b) => b.totalScore - a.totalScore);
      const rankMap = new Map();
      sortedByScore.forEach((t, idx) => {
        rankMap.set(t.team.name || t.team.tricode, idx + 1);
      });

      let columnsHtml = '';

      apparatusData.forEach(teamData => {
        const { team, gymnasts, eventScore, totalScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);
        const teamName = team.name || team.tricode;
        const rank = rankMap.get(teamName) || 0;

        // Rank display with ordinal suffix
        const rankSuffix = rank === 1 ? 'st' : rank === 2 ? 'nd' : rank === 3 ? 'rd' : 'th';
        const rankText = totalScore > 0 ? `${rank}${rankSuffix} Place` : '';
        const rankClass = rank <= 3 && totalScore > 0 ? `rank-${rank}` : '';

        // Build athlete rows - pad to maxAthletes for symmetry
        let athletesHtml = '';
        for (let i = 0; i < maxAthletes; i++) {
          const g = gymnasts[i];
          if (g) {
            const score = parseFloat(g.final_score) || 0;
            const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
            athletesHtml += `
              <div class="athlete-row">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name">${name}</div>
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
              </div>
            `;
          } else {
            // Empty placeholder row for symmetry
            athletesHtml += `
              <div class="athlete-row empty">
                <div class="athlete-order">${i + 1}</div>
                <div class="athlete-name"></div>
                <div class="athlete-score"></div>
              </div>
            `;
          }
        }

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="header-line1">
                <div class="team-rank ${rankClass}">${rank}${rankSuffix}</div>
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
                <div class="team-name">${teamName}</div>
              </div>
              <div class="header-line2">
                <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : ''}</div>
                <div class="event-label">${eventDisplayName}</div>
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad-v4 teams-${numTeams}">${columnsHtml}</div>`;
    }

    // Map apparatus short codes to API event names
    // Supports both short codes (fx, ub) and button IDs (floor, ubars)
    const APPARATUS_TO_EVENT = {
      // Men's events
      'fx': 'FLOOR',
      'floor': 'FLOOR',
      'ph': 'HORSE',
      'pommel': 'HORSE',
      'sr': 'RINGS',
      'rings': 'RINGS',
      'vt': 'VAULT',
      'vault': 'VAULT',
      'pb': 'PBARS',
      'pbars': 'PBARS',
      'hb': 'BAR',
      'hbar': 'BAR',
      // Women's events
      'ub': 'BARS',
      'ubars': 'BARS',
      'bb': 'BEAM',
      'beam': 'BEAM'
    };

    // Fetch event summary by apparatus (both teams on same event)
    async function fetchAndRenderEventSummaryByApparatus(sessionId, apparatus, numTeams, competitionFormat, layout = 'default', gender = 'mens') {
      const contentEl = document.getElementById('event-summary-content');
      if (!contentEl) return;

      // Wait for headshots to be loaded before rendering
      await waitForHeadshots();

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        const teams = data.meet?.teams || [];
        if (teams.length === 0) {
          contentEl.innerHTML = '<div class="event-summary-error">No teams found</div>';
          return;
        }

        // Sort teams by team_order
        const sortedTeams = [...teams].sort((a, b) => (a.team_order || 0) - (b.team_order || 0));

        // Get the event name from the apparatus code
        const eventName = APPARATUS_TO_EVENT[apparatus] || 'FLOOR';
        const eventDisplayName = EVENT_DISPLAY_NAMES[eventName] || eventName;
        const eventShortCode = EVENT_SHORT_CODES[eventName] || apparatus.toUpperCase();

        // Determine if this is a dual meet (2 teams) or multi-team (3+)
        const isDual = sortedTeams.length === 2;
        const actualNumTeams = Math.min(sortedTeams.length, numTeams || sortedTeams.length);

        // Build data for each team on the SAME event (apparatus mode)
        const apparatusData = sortedTeams.slice(0, actualNumTeams).map((team) => {
          const teamEvent = team.events?.find(e => e.event_name === eventName);
          const gymnasts = teamEvent?.gymnasts?.sort((a, b) => (a.order || 0) - (b.order || 0)) || [];
          const eventScore = parseFloat(teamEvent?.event_score) || 0;
          const totalScore = parseFloat(team.final_score) || 0;

          return {
            team,
            eventName,
            eventDisplayName,
            eventShortCode,
            gymnasts,
            eventScore,
            totalScore
          };
        });

        // Render based on meet type and layout
        if (isDual) {
          if (layout === 'broadcast-table') {
            renderBroadcastTableLayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode);
          } else if (layout === 'classic-broadcast') {
            renderClassicBroadcastLayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode);
          } else if (layout === 'default-v2') {
            renderDefaultV2LayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode);
          } else if (layout === 'default-v3') {
            // V3 works for both dual and multi-team
            renderMultiTeamSummaryApparatusV3(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
          } else if (layout === 'default-v4') {
            // V4: V3 with team rankings and totals
            renderMultiTeamSummaryApparatusV4(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
          } else {
            renderDualMeetSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode);
          }
        } else {
          // Multi-team meet (3+ teams)
          if (layout === 'default-v3') {
            renderMultiTeamSummaryApparatusV3(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
          } else if (layout === 'default-v4') {
            renderMultiTeamSummaryApparatusV4(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
          } else {
            renderMultiTeamSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
          }
        }

      } catch (error) {
        console.error('Event summary fetch error:', error);
        contentEl.innerHTML = '<div class="event-summary-error">Error loading event summary</div>';
      }
    }

    // Render dual meet apparatus layout (2 teams side-by-side, same event)
    function renderDualMeetSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode) {
      const team1 = apparatusData[0];
      const team2 = apparatusData[1];

      // Calculate score differences for each lineup position
      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildTeamColumn(team1, 'left', maxAthletes);
      const rightColumn = buildTeamColumn(team2, 'right', maxAthletes);

      // Build center divider with event name and visual diff bars
      let centerHtml = `<div class="center-divider"><div class="center-header"><div class="rotation-badge">${eventShortCode}</div></div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        // Calculate bar width (max diff around 2.0 points maps to 50% width)
        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        centerHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons (same event for both teams)
      const footerHtml = `
        <div class="event-summary-footer">
          <div class="footer-team left">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="event-summary-dual">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // Render multi-team apparatus layout (all teams on same event)
    function renderMultiTeamSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode, numTeams) {
      let columnsHtml = '';

      apparatusData.forEach(teamData => {
        const { team, gymnasts, eventScore } = teamData;
        const logoUrl = getTeamLogoUrl(team.name, team.logo);

        let athletesHtml = '';
        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              <div class="athlete-name">${name}</div>
              <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        });

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : ''}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad">${columnsHtml}</div>`;
    }

    // ==========================================
    // LAYOUT: Hero Cards
    // Clean symmetric layout with big text
    // ==========================================

    function renderBroadcastTableLayout(contentEl, rotationData, rotation) {
      const team1 = rotationData[0];
      const team2 = rotationData[1];
      // Always use 6 rows for symmetric grid
      const gridRows = 6;

      // Build top scoreboard bar
      const team1Logo = getTeamLogoUrl(team1.team.name, team1.team.logo);
      const team2Logo = getTeamLogoUrl(team2.team.name, team2.team.logo);
      const scoreboardHtml = `
        <div class="hero-scoreboard">
          <div class="hero-team-score home">
            ${team1Logo ? `<img class="hero-team-logo" src="${team1Logo}" alt="">` : ''}
            <div class="hero-team-info">
              <div class="hero-team-name">${team1.team.name || team1.team.tricode}</div>
              <div class="hero-team-total">${team1.totalScore > 0 ? team1.totalScore.toFixed(3) : '0.000'}</div>
            </div>
          </div>
          <div class="hero-center-vs">
            <div class="hero-rotation-badge">Rotation ${rotation}</div>
            <div class="hero-vs-text">VS</div>
          </div>
          <div class="hero-team-score away">
            ${team2Logo ? `<img class="hero-team-logo" src="${team2Logo}" alt="">` : ''}
            <div class="hero-team-info">
              <div class="hero-team-name">${team2.team.name || team2.team.tricode}</div>
              <div class="hero-team-total">${team2.totalScore > 0 ? team2.totalScore.toFixed(3) : '0.000'}</div>
            </div>
          </div>
        </div>
      `;

      // Build athlete cards for home team (always 6 rows for symmetry)
      let homeCardsHtml = '';
      for (let i = 0; i < gridRows; i++) {
        const g = team1.gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name || ''} ${g.last_name || ''}`;
          const photo = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          homeCardsHtml += `
            <div class="hero-athlete-card home">
              ${renderAthletePhoto(photo, 'hero-athlete-photo')}
              <div class="hero-athlete-info">
                <div class="hero-athlete-name">${name}</div>
              </div>
              <div class="hero-athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        } else {
          // Empty placeholder to maintain symmetry
          homeCardsHtml += `<div class="hero-athlete-card empty"></div>`;
        }
      }

      // Build athlete cards for away team (always 6 rows for symmetry)
      let awayCardsHtml = '';
      for (let i = 0; i < gridRows; i++) {
        const g = team2.gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name || ''} ${g.last_name || ''}`;
          const photo = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          awayCardsHtml += `
            <div class="hero-athlete-card away">
              ${renderAthletePhoto(photo, 'hero-athlete-photo')}
              <div class="hero-athlete-info">
                <div class="hero-athlete-name">${name}</div>
              </div>
              <div class="hero-athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        } else {
          // Empty placeholder to maintain symmetry
          awayCardsHtml += `<div class="hero-athlete-card empty"></div>`;
        }
      }

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffText = eventDiff > 0 ? `+${eventDiff.toFixed(3)}` : eventDiff.toFixed(3);

      // Build footer with event totals
      const footerHtml = `
        <div class="hero-footer">
          <div class="hero-footer-team home">
            <div class="hero-footer-event">
              <div class="hero-footer-event-code">${team1.eventShortCode}</div>
              <div class="hero-footer-event-label">Total</div>
            </div>
            <div class="hero-footer-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="hero-footer-center">
            <div class="hero-footer-diff">${eventDiffText}</div>
          </div>
          <div class="hero-footer-team away">
            <div class="hero-footer-event">
              <div class="hero-footer-event-code">${team2.eventShortCode}</div>
              <div class="hero-footer-event-label">Total</div>
            </div>
            <div class="hero-footer-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-broadcast-table">
          ${scoreboardHtml}
          <div class="hero-cards-container">
            <div class="hero-team-column">${homeCardsHtml}</div>
            <div class="hero-team-column">${awayCardsHtml}</div>
          </div>
          ${footerHtml}
        </div>
      `;
    }

    // Hero Cards Layout for Apparatus mode (same event for both teams)
    function renderBroadcastTableLayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode) {
      const team1 = apparatusData[0];
      const team2 = apparatusData[1];
      // Always use 6 rows for symmetric grid
      const gridRows = 6;

      // Build top scoreboard bar
      const team1Logo = getTeamLogoUrl(team1.team.name, team1.team.logo);
      const team2Logo = getTeamLogoUrl(team2.team.name, team2.team.logo);
      const scoreboardHtml = `
        <div class="hero-scoreboard">
          <div class="hero-team-score home">
            ${team1Logo ? `<img class="hero-team-logo" src="${team1Logo}" alt="">` : ''}
            <div class="hero-team-info">
              <div class="hero-team-name">${team1.team.name || team1.team.tricode}</div>
              <div class="hero-team-total">${team1.totalScore > 0 ? team1.totalScore.toFixed(3) : '0.000'}</div>
            </div>
          </div>
          <div class="hero-center-vs">
            <div class="hero-rotation-badge">${eventDisplayName}</div>
            <div class="hero-vs-text">${eventShortCode}</div>
          </div>
          <div class="hero-team-score away">
            ${team2Logo ? `<img class="hero-team-logo" src="${team2Logo}" alt="">` : ''}
            <div class="hero-team-info">
              <div class="hero-team-name">${team2.team.name || team2.team.tricode}</div>
              <div class="hero-team-total">${team2.totalScore > 0 ? team2.totalScore.toFixed(3) : '0.000'}</div>
            </div>
          </div>
        </div>
      `;

      // Build athlete cards for home team (always 6 rows for symmetry)
      let homeCardsHtml = '';
      for (let i = 0; i < gridRows; i++) {
        const g = team1.gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name || ''} ${g.last_name || ''}`;
          const photo = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          homeCardsHtml += `
            <div class="hero-athlete-card home">
              ${renderAthletePhoto(photo, 'hero-athlete-photo')}
              <div class="hero-athlete-info">
                <div class="hero-athlete-name">${name}</div>
              </div>
              <div class="hero-athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        } else {
          homeCardsHtml += `<div class="hero-athlete-card empty"></div>`;
        }
      }

      // Build athlete cards for away team (always 6 rows for symmetry)
      let awayCardsHtml = '';
      for (let i = 0; i < gridRows; i++) {
        const g = team2.gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name || ''} ${g.last_name || ''}`;
          const photo = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          awayCardsHtml += `
            <div class="hero-athlete-card away">
              ${renderAthletePhoto(photo, 'hero-athlete-photo')}
              <div class="hero-athlete-info">
                <div class="hero-athlete-name">${name}</div>
              </div>
              <div class="hero-athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        } else {
          awayCardsHtml += `<div class="hero-athlete-card empty"></div>`;
        }
      }

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffText = eventDiff > 0 ? `+${eventDiff.toFixed(3)}` : eventDiff.toFixed(3);

      // Build footer with event totals
      const footerHtml = `
        <div class="hero-footer">
          <div class="hero-footer-team home">
            <div class="hero-footer-event">
              <div class="hero-footer-event-code">${eventShortCode}</div>
              <div class="hero-footer-event-label">Total</div>
            </div>
            <div class="hero-footer-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="hero-footer-center">
            <div class="hero-footer-diff">${eventDiffText}</div>
          </div>
          <div class="hero-footer-team away">
            <div class="hero-footer-event">
              <div class="hero-footer-event-code">${eventShortCode}</div>
              <div class="hero-footer-event-label">Total</div>
            </div>
            <div class="hero-footer-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-broadcast-table">
          ${scoreboardHtml}
          <div class="hero-cards-container">
            <div class="hero-team-column">${homeCardsHtml}</div>
            <div class="hero-team-column">${awayCardsHtml}</div>
          </div>
          ${footerHtml}
        </div>
      `;
    }

    // ==========================================
    // Layout 2: Classic Broadcast
    // Exact replica of default dual meet layout
    // ==========================================

    function renderClassicBroadcastLayout(contentEl, rotationData, rotation) {
      const team1 = rotationData[0];
      const team2 = rotationData[1];

      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildClassicBroadcastColumn(team1, 'left', maxAthletes);
      const rightColumn = buildClassicBroadcastColumn(team2, 'right', maxAthletes);

      // Build center divider with visual diff bars
      let centerHtml = `<div class="center-divider"><div class="center-header"><div class="rotation-badge">R${rotation}</div></div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        centerHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons
      const footerHtml = `
        <div class="summary-footer">
          <div class="footer-team left">
            <div class="event-abbr">${team1.eventShortCode}</div>
            ${EVENT_ICONS[team1.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${team2.eventShortCode}</div>
            ${EVENT_ICONS[team2.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-classic-broadcast">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // Build a team column for classic broadcast layout
    function buildClassicBroadcastColumn(teamData, side, maxAthletes) {
      const { team, gymnasts, totalScore, eventShortCode } = teamData;

      let athletesHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const g = gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const startValue = g.scores && g.scores.length > 0 ? parseFloat(g.scores[0].start) || 0 : 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          const photoUrl = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);
          const isAnchor = i === 5;

          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order${isAnchor ? ' anchor' : ''}">${i + 1}</div>
              ${renderAthletePhoto(photoUrl)}
              <div class="athlete-name">${name}</div>
              <div class="athlete-score-block">
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : 'On Eval'}</div>
                ${startValue > 0 ? `<div class="athlete-start">${startValue.toFixed(1)}</div>` : ''}
              </div>
            </div>
          `;
        } else {
          athletesHtml += `<div class="athlete-row" style="min-height: 72px;"></div>`;
        }
      }

      const logoUrl = getTeamLogoUrl(team.name, team.logo);
      return `
        <div class="team-column ${side}">
          <div class="team-header ${side}">
            ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
            <div class="team-name">${team.name || team.tricode}</div>
            <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : '0.000'}</div>
          </div>
          <div class="athlete-list">
            ${athletesHtml}
          </div>
        </div>
      `;
    }

    // Classic Broadcast Layout for Apparatus mode (same event for both teams)
    function renderClassicBroadcastLayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode) {
      const team1 = apparatusData[0];
      const team2 = apparatusData[1];

      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildClassicBroadcastColumn(team1, 'left', maxAthletes);
      const rightColumn = buildClassicBroadcastColumn(team2, 'right', maxAthletes);

      // Build center divider with event name and visual diff bars
      let centerHtml = `<div class="center-divider"><div class="center-header"><div class="rotation-badge">${eventShortCode}</div></div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        centerHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons (same event for both teams)
      const footerHtml = `
        <div class="summary-footer">
          <div class="footer-team left">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-classic-broadcast">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // ==========================================
    // Layout 3: Default Original V2
    // Improved default with larger text, team logos, and inline D-score
    // ==========================================

    function renderDefaultV2Layout(contentEl, rotationData, rotation) {
      const team1 = rotationData[0];
      const team2 = rotationData[1];

      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Get home team logo from Firebase or API (only show home team in title bar)
      const team1Logo = getTeamLogoUrl(team1.team.name, team1.team.logo);

      // Build title bar - EVENT SUMMARY on left, home team logo on right
      const titleHtml = `
        <div class="title-bar">
          <div class="title-text">Event Summary</div>
          ${team1Logo ? `<img class="title-logo" src="${team1Logo}" alt="">` : ''}
        </div>
      `;

      // Build left team column
      const leftColumn = buildDefaultV2Column(team1, 'left', maxAthletes);
      const rightColumn = buildDefaultV2Column(team2, 'right', maxAthletes);

      // Build center divider with visual diff bars (wrapped in diff-list for alignment)
      let diffRowsHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        diffRowsHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }

      const centerHtml = `
        <div class="center-divider">
          <div class="center-header"><div class="rotation-badge">R${rotation}</div></div>
          <div class="diff-list">${diffRowsHtml}</div>
        </div>
      `;

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons
      const footerHtml = `
        <div class="event-summary-footer layout-default-v2-footer">
          <div class="footer-team left">
            <div class="event-abbr">${team1.eventShortCode}</div>
            ${EVENT_ICONS[team1.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${team2.eventShortCode}</div>
            ${EVENT_ICONS[team2.eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-default-v2">
          ${titleHtml}
          <div class="main-content">
            ${leftColumn}
            ${centerHtml}
            ${rightColumn}
          </div>
        </div>
        ${footerHtml}
      `;
    }

    // Build a team column for Default V2 layout
    function buildDefaultV2Column(teamData, side, maxAthletes) {
      const { team, gymnasts, totalScore, eventShortCode } = teamData;

      let athletesHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const g = gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const startValue = g.scores && g.scores.length > 0 ? parseFloat(g.scores[0].start) || 0 : 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          const photoUrl = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);
          const isAnchor = i === 5;

          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order${isAnchor ? ' anchor' : ''}">${i + 1}</div>
              ${renderAthletePhoto(photoUrl)}
              <div class="athlete-info">
                <div class="athlete-name">${name}</div>
              </div>
              <div class="athlete-score-block">
                <div class="athlete-score">${score > 0 ? score.toFixed(3) : 'On Eval'}</div>
                ${startValue > 0 ? `<div class="athlete-start">${startValue.toFixed(1)}</div>` : ''}
              </div>
            </div>
          `;
        } else {
          athletesHtml += `<div class="athlete-row"></div>`;
        }
      }

      const logoUrl = getTeamLogoUrl(team.name, team.logo);
      return `
        <div class="team-column ${side}">
          <div class="team-header ${side}">
            ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
            <div class="team-name">${team.name || team.tricode}</div>
            <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : '0.000'}</div>
          </div>
          <div class="athlete-list">
            ${athletesHtml}
          </div>
        </div>
      `;
    }

    // Default V2 Layout for Apparatus mode (same event for both teams)
    function renderDefaultV2LayoutApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode) {
      const team1 = apparatusData[0];
      const team2 = apparatusData[1];

      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Get home team logo from Firebase or API (only show home team in title bar)
      const team1Logo = getTeamLogoUrl(team1.team.name, team1.team.logo);

      // Build title bar - EVENT SUMMARY on left, home team logo on right
      const titleHtml = `
        <div class="title-bar">
          <div class="title-text">Event Summary</div>
          ${team1Logo ? `<img class="title-logo" src="${team1Logo}" alt="">` : ''}
        </div>
      `;

      // Build left team column
      const leftColumn = buildDefaultV2Column(team1, 'left', maxAthletes);
      const rightColumn = buildDefaultV2Column(team2, 'right', maxAthletes);

      // Build center divider with event name and visual diff bars (wrapped in diff-list for alignment)
      let diffRowsHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = (score1 === 0 && score2 === 0) ? '--' : diff.toFixed(3);

        const barWidth = Math.min(Math.abs(diff) * 25, 50);
        let barClass = 'tie';
        if (diff > 0.001) barClass = 'left';
        else if (diff < -0.001) barClass = 'right';

        diffRowsHtml += `
          <div class="diff-row">
            <div class="diff-value">${diffStr}</div>
            <div class="diff-bar">
              <div class="diff-bar-fill ${barClass}" style="width: ${barWidth}%;"></div>
            </div>
          </div>
        `;
      }

      const centerHtml = `
        <div class="center-divider">
          <div class="center-header"><div class="rotation-badge">${eventShortCode}</div></div>
          <div class="diff-list">${diffRowsHtml}</div>
        </div>
      `;

      // Calculate event total difference
      const eventDiff = team1.eventScore - team2.eventScore;
      const eventDiffStr = eventDiff.toFixed(3);
      const eventBarWidth = Math.min(Math.abs(eventDiff) * 5, 50);
      let eventBarClass = 'tie';
      if (eventDiff > 0.001) eventBarClass = 'left';
      else if (eventDiff < -0.001) eventBarClass = 'right';

      // Build footer with event totals and icons (same event for both teams)
      const footerHtml = `
        <div class="event-summary-footer layout-default-v2-footer">
          <div class="footer-team left">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : ''}</div>
          </div>
          <div class="footer-center">
            <div class="footer-diff">${eventDiffStr}</div>
            <div class="footer-diff-bar">
              <div class="footer-diff-fill ${eventBarClass}" style="width: ${eventBarWidth}%;"></div>
            </div>
          </div>
          <div class="footer-team right">
            <div class="event-abbr">${eventShortCode}</div>
            ${EVENT_ICONS[eventShortCode] || ''}
            <div class="event-label">Event Total</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : ''}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="layout-default-v2">
          ${titleHtml}
          <div class="main-content">
            ${leftColumn}
            ${centerHtml}
            ${rightColumn}
          </div>
        </div>
        ${footerHtml}
      `;
    }

    // Graphic renderers
    const renderers = {
      clear: () => '',

      logos: (data) => {
        // Collect all team logos that exist (filter out empty/placeholder)
        const logos = [];
        for (let i = 1; i <= 6; i++) {
          const logo = data[`team${i}Logo`];
          if (logo && logo.trim() && !logo.includes('placeholder')) {
            logos.push(logo);
          }
        }

        // Use grid layout for 5+ teams, row for 2-4
        const isGrid = logos.length >= 5;
        const containerClass = isGrid ? 'graphic-logos graphic-logos-grid' : 'graphic-logos';

        const logosHtml = logos.map((logo, i) =>
          `<img class="team-logo" src="${logo}" alt="Team ${i + 1}">`
        ).join('');

        return `<div class="graphic-container ${containerClass}">${logosHtml}</div>`;
      },

      'event-bar': (data) => `
        <div class="graphic-container graphic-event-bar">
          <div class="event-bar-logo">
            <img src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          </div>
          <div class="event-bar-content">
            <div class="event-bar-venue">${data.venue}</div>
            <div class="event-bar-details">
              <div class="event-bar-name">${data.eventName}</div>
              <div class="event-bar-location">${data.location}</div>
            </div>
          </div>
        </div>
      `,

      hosts: (data) => `
        <div class="graphic-container graphic-hosts">
          <div class="hosts-header">
            <div class="hosts-title">HOSTS</div>
          </div>
          <div class="hosts-content">
            ${data.hosts.split('\n').map(h => `<div class="hosts-name">${h}</div>`).join('')}
          </div>
        </div>
      `,

      'team1-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team1Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team1Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team1High}</div>
            </div>
          </div>
        </div>
      `,

      'team1-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team1Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team2-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team2Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team2Name, data.team2Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team2Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team2High}</div>
            </div>
          </div>
        </div>
      `,

      'team2-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team2Name, data.team2Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team2Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team3-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team3Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team3Name, data.team3Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team3Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team3High}</div>
            </div>
          </div>
        </div>
      `,

      'team3-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team3Name, data.team3Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team3Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team4-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team4Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team4Name, data.team4Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team4Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team4High}</div>
            </div>
          </div>
        </div>
      `,

      'team4-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team4Name, data.team4Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team4Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team5-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team5Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team5Name, data.team5Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team5Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team5High}</div>
            </div>
          </div>
        </div>
      `,

      'team5-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team5Name, data.team5Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team5Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team6-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team6Name}</div>
            <img class="stats-logo" src="${getTeamLogoUrl(data.team6Name, data.team6Logo)}" alt="Team">
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team6Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team6High}</div>
            </div>
          </div>
        </div>
      `,

      'team6-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${getTeamLogoUrl(data.team6Name, data.team6Logo)}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team6Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'event-frame': (data) => `
        <div class="graphic-container graphic-event-frame">
          <div class="frame-header">
            <div class="frame-title">${data.frameTitle}</div>
            <img class="frame-logo" src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          </div>
          <div class="frame-content"></div>
        </div>
      `,

      'stream-starting': (data) => `
        <div class="graphic-container graphic-stream">
          <div class="stream-title">STREAM STARTING SOON</div>
          <img class="stream-logo" src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          <div class="stream-event-name">${data.eventName}</div>
          <div class="stream-date">${data.meetDate}</div>
          <div class="stream-branding"><span>V</span>irtius</div>
        </div>
      `,

      'stream-thanks': (data) => `
        <div class="graphic-container graphic-stream">
          <div class="stream-title">THANKS FOR WATCHING</div>
          <img class="stream-logo" src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          <div class="stream-event-name">${data.eventName}</div>
          <div class="stream-date">${data.meetDate}</div>
          <div class="stream-branding"><span>V</span>irtius</div>
        </div>
      `,

      // Frame Overlays for OBS
      'frame-quad': () => `
        <div class="graphic-frame-overlay frame-quad">
          <div class="frame-overlay-container">
            <div class="frame-panel"></div>
            <div class="frame-panel"></div>
            <div class="frame-panel"></div>
            <div class="frame-panel"></div>
          </div>
          <div class="frame-watermark"><span class="v">V</span>irtius</div>
        </div>
      `,

      'frame-tri-center': () => `
        <div class="graphic-frame-overlay frame-tri-center">
          <div class="frame-overlay-container">
            <div class="top-row">
              <div class="frame-panel"></div>
              <div class="frame-panel"></div>
            </div>
            <div class="bottom-row">
              <div class="frame-panel"></div>
            </div>
          </div>
          <div class="frame-watermark"><span class="v">V</span>irtius</div>
        </div>
      `,

      'frame-tri-wide': () => `
        <div class="graphic-frame-overlay frame-tri-wide">
          <div class="frame-overlay-container">
            <div class="top-row">
              <div class="frame-panel"></div>
              <div class="frame-panel"></div>
            </div>
            <div class="frame-panel"></div>
          </div>
          <div class="frame-watermark"><span class="v">V</span>irtius</div>
        </div>
      `,

      'frame-single': () => `
        <div class="graphic-frame-overlay frame-single">
          <div class="frame-overlay-container">
            <div class="frame-panel"></div>
          </div>
          <div class="frame-watermark"><span class="v">V</span>irtius</div>
        </div>
      `,

      'frame-team-header': (data) => {
        // Collect all team logos that exist
        const logos = [];
        for (let i = 1; i <= 6; i++) {
          const logo = data[`team${i}Logo`];
          if (logo && logo.trim() && !logo.includes('placeholder')) {
            logos.push(logo);
          }
        }
        const logosHtml = logos.map((logo, i) =>
          `<img class="team-logo" src="${logo}" alt="Team ${i + 1}">`
        ).join('');

        return `
          <div class="graphic-frame-overlay frame-team-header">
            <div class="header-row">${logosHtml}</div>
            <div class="frame-overlay-container">
              <div class="frame-panel"></div>
              <div class="frame-panel"></div>
            </div>
            <div class="frame-watermark"><span class="v">V</span>irtius</div>
          </div>
        `;
      },

      'warm-up': (data) => {
        const teamsText = data.eventName || (data.team1Name && data.team2Name
          ? `${data.team1Name.toUpperCase()} VS ${data.team2Name.toUpperCase()}`
          : 'WARM UP');
        return `
          <div class="graphic-container graphic-warm-up">
            <div class="warm-up-logo-section">
              <img src="${getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
            </div>
            <div class="warm-up-content-section">
              <div class="warm-up-teams-row">
                <div class="warm-up-teams-text">${teamsText}</div>
              </div>
              <div class="warm-up-status-row">
                <div class="warm-up-status-text">WARM UP</div>
              </div>
            </div>
          </div>
        `;
      },

      'now-competing': (data) => `
        <div class="graphic-container graphic-now-competing">
          <div class="now-competing-status">
            <div class="now-competing-status-dot"></div>
            <div class="now-competing-status-text">Live</div>
          </div>
          <div class="now-competing-logo">
            <img src="${data.athleteLogo || getTeamLogoUrl(data.team1Name, data.team1Logo)}" alt="Team">
          </div>
          <div class="now-competing-content">
            <div class="now-competing-event">${data.athleteEvent || 'Floor Exercise'}</div>
            <div class="now-competing-details">
              <div class="now-competing-name">${data.athleteName || 'Athlete Name'}</div>
              <div class="now-competing-team">${data.athleteTeam || 'Team'}</div>
            </div>
          </div>
        </div>
      `,

      'event-summary': (data) => {
        const sessionId = data.virtiusSessionId;
        const mode = data.summaryMode || 'rotation';
        const rotation = data.summaryRotation || 1;
        const apparatus = data.summaryApparatus || 'fx';
        const numTeams = data.summaryNumTeams || 2;
        const competitionFormat = data.summaryFormat || 'head-to-head';
        const gender = data.summaryGender || 'mens'; // Gender for correct event order
        const hostLogo = getTeamLogoUrl(data.team1Name, data.team1Logo);
        const theme = data.summaryTheme || 'default';

        // Get team colors for dynamic themes
        const team1Colors = getTeamColors(data.team1Name);
        const team2Colors = getTeamColors(data.team2Name);

        if (!sessionId) {
          return '<div style="color: red; padding: 100px; font-size: 36px;">No Virtius Session ID configured for this competition</div>';
        }

        // Determine if this is a layout theme (starts with 'layout-') or a color theme
        const isLayoutTheme = theme.startsWith('layout-');
        const layout = isLayoutTheme ? theme.replace('layout-', '') : 'default';

        // Fetch and render after initial paint
        if (mode === 'apparatus') {
          setTimeout(() => fetchAndRenderEventSummaryByApparatus(sessionId, apparatus, numTeams, competitionFormat, layout, gender), 100);
        } else {
          setTimeout(() => fetchAndRenderEventSummary(sessionId, rotation, numTeams, competitionFormat, layout, gender), 100);
        }

        const logoHtml = hostLogo && hostLogo.trim() && !hostLogo.includes('placeholder')
          ? `<img class="event-summary-header-logo" src="${hostLogo}" alt="">`
          : '';

        const loadingText = mode === 'apparatus'
          ? `Loading ${apparatus.toUpperCase()}...`
          : `Loading rotation ${rotation}...`;

        // Build theme class and CSS variables for team colors
        // Only apply color theme class if not using a layout theme
        const themeClass = (!isLayoutTheme && theme !== 'default') ? `theme-${theme}` : '';
        const teamColorVars = `--home-primary: ${team1Colors.primary}; --home-secondary: ${team1Colors.secondary}; --home-bg: ${team1Colors.bg}; --away-primary: ${team2Colors.primary}; --away-secondary: ${team2Colors.secondary};`;

        // For layout themes, don't show the standard header
        if (isLayoutTheme) {
          return `
            <div class="graphic-container graphic-event-summary" style="${teamColorVars}">
              <div class="event-summary-content" id="event-summary-content" style="flex: 1;">
                <div class="event-summary-loading">${loadingText}</div>
              </div>
            </div>
          `;
        }

        return `
          <div class="graphic-container graphic-event-summary ${themeClass}" style="${teamColorVars}">
            <div class="event-summary-header">
              <div class="event-summary-title">EVENT SUMMARY</div>
              ${logoHtml}
            </div>
            <div class="event-summary-content" id="event-summary-content">
              <div class="event-summary-loading">${loadingText}</div>
            </div>
          </div>
        `;
      },

      'virtius-leaderboard': (data) => {
        const sessionId = data.virtiusSessionId;
        const event = data.leaderboardEvent || 'aa';
        if (!sessionId) {
          return '<div style="color: red; padding: 100px; font-size: 36px;">No Virtius Session ID configured for this competition</div>';
        }

        // Map event codes to display titles and API event names
        // Includes both men's and women's events
        const eventTitles = {
          // Men's events
          'fx': 'FLOOR EXERCISE',
          'ph': 'POMMEL HORSE',
          'sr': 'STILL RINGS',
          'vt': 'VAULT',
          'pb': 'PARALLEL BARS',
          'hb': 'HORIZONTAL BAR',
          // Women's events
          'ub': 'UNEVEN BARS',
          'bb': 'BALANCE BEAM',
          // All-around
          'aa': 'ALL AROUND'
        };
        const eventApiNames = {
          // Men's events
          'fx': 'FLOOR',
          'ph': 'HORSE',
          'sr': 'RINGS',
          'vt': 'VAULT',
          'pb': 'PBARS',
          'hb': 'BAR',
          // Women's events
          'ub': 'BARS',
          'bb': 'BEAM',
          // All-around
          'aa': 'All Around'
        };
        const eventShortCodes = {
          // Men's events
          'fx': 'FX',
          'ph': 'PH',
          'sr': 'SR',
          'vt': 'VT',
          'pb': 'PB',
          'hb': 'HB',
          // Women's events
          'ub': 'UB',
          'bb': 'BB',
          // All-around
          'aa': 'AA'
        };
        const title = eventTitles[event] || event.toUpperCase();
        const apiEventName = eventApiNames[event] || event;
        const shortCode = eventShortCodes[event] || event.toUpperCase();
        const gender = data.leaderboardGender || 'mens'; // Women don't have Exec/SB columns

        // Return loading state initially, then fetch and update
        setTimeout(() => fetchAndRenderLeaderboard(sessionId, apiEventName, shortCode, gender), 100);

        // Only show logo if it exists and is valid
        const resolvedLogo = getTeamLogoUrl(data.team1Name, data.team1Logo);
        const logoHtml = resolvedLogo
          ? `<img class="frame-logo" src="${resolvedLogo}" alt="">`
          : '';

        return `
          <div class="graphic-container graphic-virtius-leaderboard">
            <div class="frame-header">
              <div class="frame-title">${title}</div>
              ${logoHtml}
            </div>
            <div class="frame-content" id="leaderboard-content">
              <div class="leaderboard-loading">Loading leaderboard...</div>
            </div>
          </div>
        `;
      }
    };

    // Listen for graphic changes
    db.ref(`competitions/${competitionId}/currentGraphic`).on('value', (snapshot) => {
      const state = snapshot.val();
      if (!state) {
        output.innerHTML = '';
        return;
      }

      const { graphic, data } = state;
      
      if (graphic === 'clear' || !renderers[graphic]) {
        output.innerHTML = '';
        return;
      }

      output.innerHTML = renderers[graphic](data);
    });

    console.log(`Output panel ready - listening for graphics on competition: ${competitionId}`);
    // Note: Keyboard shortcuts (like 'b' for bold mode) work in OBS via Interact mode,
    // but not in regular browsers due to cross-origin iframe restrictions.
  </script>
</body>
</html>
