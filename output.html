<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, height=1080">
  <title>Graphics Output</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      width: 1920px;
      height: 1080px;
      overflow: hidden;
      background: transparent;
    }
    #output {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* Animations */
    .graphic-container {
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Team Logos - Row Layout (2-4 teams) */
    .graphic-logos {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 100px;
      background: transparent;
    }
    .graphic-logos .team-logo {
      width: 250px;
      height: 250px;
      object-fit: contain;
      background: #f4f4f5;
      border-radius: 24px;
      padding: 25px;
    }
    /* Team Logos - Grid Layout (5-6 teams) */
    .graphic-logos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 60px;
      padding: 100px;
      place-items: center;
    }
    .graphic-logos-grid .team-logo {
      width: 200px;
      height: 200px;
      padding: 20px;
    }

    /* Event Info Bar */
    .graphic-event-bar {
      position: absolute;
      bottom: 120px;
      left: 100px;
      display: flex;
      flex-direction: row;
      animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    .event-bar-logo {
      width: 100px;
      background: #BFBFBF;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
    }
    .event-bar-logo img {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .event-bar-content {
      display: flex;
      flex-direction: column;
    }
    .event-bar-venue {
      background: #BFBFBF;
      padding: 10px 40px;
      min-width: 600px;
      font-size: 36px;
      font-weight: 900;
      color: #000;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }
    .event-bar-details {
      background: #000;
      padding: 10px 40px;
    }
    .event-bar-name {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .event-bar-location {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    /* Hosts Card */
    .graphic-hosts {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .hosts-header {
      background: #d4d4d8;
      padding: 16px 36px;
      min-width: 400px;
    }
    .hosts-title {
      font-size: 36px;
      font-weight: 800;
      color: #000;
    }
    .hosts-content {
      background: #000;
      padding: 20px 36px;
      min-width: 400px;
    }
    .hosts-name {
      font-size: 26px;
      font-weight: 600;
      color: #fff;
      line-height: 1.5;
    }

    /* Team Stats Card */
    .graphic-team-stats {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .stats-header {
      background: #d4d4d8;
      padding: 14px 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      min-width: 480px;
    }
    .stats-team-name {
      font-size: 32px;
      font-weight: 800;
      color: #000;
      flex: 1;
    }
    .stats-logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .stats-con {
      font-size: 20px;
      font-weight: 600;
      color: #000;
      opacity: 0.7;
    }
    .stats-content {
      background: #000;
      padding: 16px 30px;
      display: flex;
      gap: 60px;
    }
    .stat-item { color: #fff; }
    .stat-label {
      font-size: 20px;
      font-weight: 500;
      opacity: 0.7;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }

    /* Coaches Card */
    .graphic-coaches {
      position: absolute;
      bottom: 120px;
      left: 100px;
    }
    .coaches-header {
      background: #d4d4d8;
      padding: 16px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-width: 420px;
    }
    .coaches-title {
      font-size: 36px;
      font-weight: 800;
      color: #000;
    }
    .coaches-logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .coaches-content {
      background: #000;
      padding: 20px 30px;
      min-width: 420px;
    }
    .coach-name {
      font-size: 24px;
      font-weight: 500;
      color: #fff;
      line-height: 1.6;
    }

    /* Event Frame */
    .graphic-event-frame {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .frame-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .frame-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
    }
    .frame-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .frame-content {
      flex: 1;
      background: #000;
    }

    /* Virtius Leaderboard - uses event frame layout */
    .graphic-virtius-leaderboard {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .graphic-virtius-leaderboard .frame-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .graphic-virtius-leaderboard .frame-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
    }
    .graphic-virtius-leaderboard .frame-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .graphic-virtius-leaderboard .frame-content {
      flex: 1;
      background: #000;
      position: relative;
      overflow: hidden;
    }
    .graphic-virtius-leaderboard iframe {
      position: absolute;
      border: none;
      /* Crop and scale the iframe - larger scale = bigger text */
      width: 1920px;
      height: 1080px;
      transform-origin: top left;
      transform: scale(1.05);
      top: -155px;
      left: 0px;
    }

    /* Custom Leaderboard Table - Dark Theme */
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 28px;
    }
    .leaderboard-table thead {
      background: #27272a;
    }
    .leaderboard-table th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 600;
      color: #a1a1aa;
      border-bottom: 2px solid #3f3f46;
    }
    .leaderboard-table th.col-score,
    .leaderboard-table th.col-diff,
    .leaderboard-table th.col-exec,
    .leaderboard-table th.col-sb {
      text-align: right;
    }
    .leaderboard-table th.col-rank {
      width: 70px;
    }
    .leaderboard-table th.col-sb {
      width: 70px;
    }
    .leaderboard-table tbody tr {
      border-bottom: 1px solid #3f3f46;
    }
    .leaderboard-table tbody tr:nth-child(odd) {
      background: #18181b;
    }
    .leaderboard-table tbody tr:nth-child(even) {
      background: #0f0f10;
    }
    .leaderboard-table td {
      padding: 14px 20px;
      color: #fff;
      font-weight: 500;
      vertical-align: middle;
    }
    .leaderboard-table td.col-rank {
      width: 70px;
      font-weight: 700;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-rank sup {
      font-size: 14px;
      color: #71717a;
    }
    .leaderboard-table td.col-name {
      font-weight: 600;
    }
    .leaderboard-table td.col-name .place-indicator {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    .leaderboard-table td.col-team {
      color: #d4d4d8;
    }
    .leaderboard-table td.col-team .leaderboard-team-logo {
      display: inline-block;
      vertical-align: middle;
      margin-right: 10px;
    }
    .leaderboard-table td.col-apparatus {
      width: 100px;
    }
    .apparatus-badge {
      display: inline-block;
      padding: 4px 12px;
      border: 1px solid #52525b;
      border-radius: 4px;
      font-size: 20px;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-score {
      text-align: right;
      font-weight: 700;
      font-size: 32px;
      color: #fff;
    }
    .leaderboard-table td.col-diff,
    .leaderboard-table td.col-exec {
      text-align: right;
      font-size: 26px;
      font-weight: 500;
      color: #a1a1aa;
    }
    .leaderboard-table td.col-sb {
      text-align: right;
      width: 70px;
    }
    /* Team logo in leaderboard */
    .leaderboard-team-logo {
      width: 36px;
      height: 36px;
      object-fit: contain;
      border-radius: 4px;
      background: #27272a;
    }
    /* Medal indicators */
    .leaderboard-medal {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 16px;
    }
    .medal-gold {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
    }
    .medal-silver {
      background: linear-gradient(135deg, #d1d5db, #9ca3af);
      color: #000;
    }
    .medal-bronze {
      background: linear-gradient(135deg, #d97706, #b45309);
      color: #fff;
    }
    /* Place indicator circles (before name) */
    .place-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    .place-indicator.gold {
      background: #facc15;
    }
    .place-indicator.silver {
      background: #d4d4d8;
    }
    .place-indicator.bronze {
      background: #d97706;
    }
    /* Stick bonus indicator - green circle with S */
    .stick-bonus {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #22c55e;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
    }
    .leaderboard-loading {
      color: #fff;
      font-size: 36px;
      text-align: center;
      padding: 100px;
    }
    .leaderboard-error {
      color: #ef4444;
      font-size: 28px;
      text-align: center;
      padding: 100px;
    }

    /* Event Summary Styles - Rotation-based layout */
    .graphic-event-summary {
      position: absolute;
      top: 50px;
      left: 70px;
      right: 70px;
      bottom: 50px;
      display: flex;
      flex-direction: column;
    }
    .event-summary-header {
      background: #d4d4d8;
      padding: 18px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .event-summary-title {
      font-size: 42px;
      font-weight: 800;
      color: #000;
      font-style: italic;
    }
    .event-summary-header-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
    }
    .event-summary-content {
      flex: 1;
      background: #27272a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Dual Meet Layout - 2 teams with center divider */
    .event-summary-dual {
      display: flex;
      flex: 1;
    }
    .event-summary-dual .team-column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .event-summary-dual .team-header {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: #18181b;
    }
    .event-summary-dual .team-header.left {
      justify-content: flex-start;
      gap: 16px;
    }
    .event-summary-dual .team-header.right {
      justify-content: flex-end;
      flex-direction: row-reverse;
      gap: 16px;
    }
    .event-summary-dual .team-logo {
      width: 48px;
      height: 48px;
      object-fit: contain;
    }
    .event-summary-dual .team-name {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-dual .team-total {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .event-summary-dual .team-header.right .team-total {
      margin-left: 0;
      margin-right: auto;
    }
    .event-summary-dual .athlete-list {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .event-summary-dual .athlete-row {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid #3f3f46;
    }
    .event-summary-dual .athlete-row:nth-child(odd) {
      background: #18181b;
    }
    .event-summary-dual .athlete-row:nth-child(even) {
      background: #0f0f10;
    }
    .event-summary-dual .athlete-order {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-right: 12px;
    }
    .event-summary-dual .athlete-photo {
      width: 48px;
      height: 48px;
      border-radius: 4px;
      object-fit: cover;
      background: #3f3f46;
      margin-right: 12px;
    }
    .event-summary-dual .athlete-name {
      flex: 1;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .event-summary-dual .athlete-diff {
      font-size: 14px;
      color: #a1a1aa;
      margin-right: 16px;
    }
    .event-summary-dual .athlete-score {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      min-width: 80px;
      text-align: right;
    }
    /* Right side - reverse order for RTL layout */
    .event-summary-dual .team-column.right .athlete-row {
      flex-direction: row-reverse;
    }
    .event-summary-dual .team-column.right .athlete-order {
      margin-right: 0;
      margin-left: 12px;
    }
    .event-summary-dual .team-column.right .athlete-photo {
      margin-right: 0;
      margin-left: 12px;
    }
    .event-summary-dual .team-column.right .athlete-name {
      text-align: right;
    }
    .event-summary-dual .team-column.right .athlete-diff {
      margin-right: 0;
      margin-left: 16px;
    }
    .event-summary-dual .team-column.right .athlete-score {
      text-align: left;
    }

    /* Center divider with rotation info and score diff */
    .event-summary-dual .center-divider {
      width: 120px;
      background: #27272a;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 12px;
    }
    .event-summary-dual .rotation-badge {
      font-size: 24px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 8px;
    }
    .event-summary-dual .score-diff {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .event-summary-dual .score-diff-value {
      font-size: 18px;
      font-weight: 600;
      color: #a1a1aa;
    }
    .event-summary-dual .score-diff-bar {
      width: 60px;
      height: 6px;
      background: #3f3f46;
      border-radius: 3px;
      position: relative;
    }
    .event-summary-dual .score-diff-indicator {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      top: -3px;
      background: #22c55e;
    }

    /* Footer with event totals */
    .event-summary-footer {
      display: flex;
      background: #18181b;
      border-top: 2px solid #3f3f46;
    }
    .event-summary-footer .footer-team {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 16px 20px;
      gap: 16px;
    }
    .event-summary-footer .footer-team.right {
      flex-direction: row-reverse;
    }
    .event-summary-footer .event-icon {
      width: 32px;
      height: 32px;
    }
    .event-summary-footer .event-label {
      font-size: 18px;
      font-weight: 600;
      color: #a1a1aa;
    }
    .event-summary-footer .event-total {
      font-size: 28px;
      font-weight: 800;
      color: #fff;
      margin-left: auto;
    }
    .event-summary-footer .footer-team.right .event-total {
      margin-left: 0;
      margin-right: auto;
    }
    .event-summary-footer .footer-center {
      width: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Quad Meet Layout - 4 team columns */
    .event-summary-quad {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      flex: 1;
      gap: 2px;
      background: #3f3f46;
    }
    .event-summary-quad .team-column {
      background: #18181b;
      display: flex;
      flex-direction: column;
    }
    .event-summary-quad .team-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 8px;
      background: #27272a;
      border-bottom: 2px solid #3f3f46;
    }
    .event-summary-quad .event-name {
      font-size: 14px;
      color: #a1a1aa;
      margin-bottom: 4px;
    }
    .event-summary-quad .team-name {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .event-summary-quad .team-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }
    .event-summary-quad .athlete-list {
      flex: 1;
      overflow: hidden;
    }
    .event-summary-quad .athlete-row {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      border-bottom: 1px solid #3f3f46;
    }
    .event-summary-quad .athlete-row:nth-child(odd) {
      background: #18181b;
    }
    .event-summary-quad .athlete-row:nth-child(even) {
      background: #0f0f10;
    }
    .event-summary-quad .athlete-order {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #52525b;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      margin-right: 8px;
    }
    .event-summary-quad .athlete-name {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .event-summary-quad .athlete-score {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    .event-summary-quad .team-footer {
      padding: 10px;
      background: #27272a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .event-summary-quad .footer-label {
      font-size: 14px;
      color: #a1a1aa;
    }
    .event-summary-quad .footer-total {
      font-size: 22px;
      font-weight: 800;
      color: #fff;
    }

    .event-summary-loading {
      color: #fff;
      font-size: 36px;
      text-align: center;
      padding: 100px;
    }
    .event-summary-error {
      color: #ef4444;
      font-size: 28px;
      text-align: center;
      padding: 100px;
    }

    /* Stream Graphics */
    .graphic-stream {
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .stream-title {
      font-size: 48px;
      font-weight: 800;
      color: #000;
      margin-bottom: 50px;
    }
    .stream-logo {
      width: 320px;
      height: 320px;
      object-fit: contain;
      margin-bottom: 50px;
    }
    .stream-event-name {
      font-size: 54px;
      font-weight: 800;
      color: #000;
    }
    .stream-date {
      font-size: 42px;
      font-weight: 700;
      color: #000;
      margin-top: 10px;
    }
    .stream-branding {
      margin-top: 30px;
      font-size: 36px;
      font-weight: 600;
      color: #000;
    }
    .stream-branding span {
      color: #22d3ee;
    }
  </style>
</head>
<body>
  <div id="output"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // Get competition ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const competitionId = urlParams.get('comp');

    if (!competitionId) {
      console.error('No competition ID specified in URL');
      document.body.innerHTML = '<div style="color: red; font-size: 48px; text-align: center; padding: 100px;">ERROR: No competition ID specified. Please access via dashboard.</div>';
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCh0aZUvKl6Qvqsva3hvOgJJlleP1OwcTY",
      authDomain: "gymnastics-graphics.firebaseapp.com",
      databaseURL: "https://gymnastics-graphics-default-rtdb.firebaseio.com",
      projectId: "gymnastics-graphics",
      storageBucket: "gymnastics-graphics.firebasestorage.app",
      messagingSenderId: "702072609550",
      appId: "1:702072609550:web:ac74a811186d3ff45b955f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const output = document.getElementById('output');

    // Fetch leaderboard data from Virtius API and render custom table
    async function fetchAndRenderLeaderboard(sessionId, eventName, shortCode) {
      const contentEl = document.getElementById('leaderboard-content');
      if (!contentEl) return;

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        // Build team logo map from teams data
        const teamLogos = {};
        if (data.meet?.teams) {
          data.meet.teams.forEach(team => {
            if (team.tricode && team.logo) {
              teamLogos[team.tricode] = team.logo;
            }
            if (team.short_name && team.logo) {
              teamLogos[team.short_name] = team.logo;
            }
          });
        }

        // Find the event results
        const eventResults = data.meet?.event_results?.find(e => e.event_name === eventName);
        if (!eventResults || !eventResults.gymnasts) {
          contentEl.innerHTML = '<div class="leaderboard-error">No results found for this event</div>';
          return;
        }

        // Build a map of gymnast_id -> detailed scores from team data FIRST
        // (needed for tiebreaker sorting by execution score)
        // The event_results only has final_score, but team.events[].gymnasts[] has e_score and scores[].start
        const gymnastScores = {};
        if (data.meet?.teams) {
          data.meet.teams.forEach(team => {
            if (team.events) {
              team.events.forEach(event => {
                if (event.event_name === eventName && event.gymnasts) {
                  event.gymnasts.forEach(g => {
                    if (g.gymnast_id) {
                      // Get start value from the first score entry (judge scores)
                      const startValue = g.scores && g.scores.length > 0
                        ? parseFloat(g.scores[0].start) || 0
                        : 0;
                      const execValue = parseFloat(g.e_score) || 0;
                      const ndValue = parseFloat(g.neutral) || 0;
                      const bonusValue = parseFloat(g.bonus) || 0;
                      const finalScore = parseFloat(g.final_score) || 0;

                      // Validation: score = difficulty + execution - neutral + bonus
                      // (e_score already includes the 10.0 base)
                      const calculated = startValue + execValue - ndValue + bonusValue;
                      console.log(`${g.first_name} ${g.last_name}: D=${startValue} E=${execValue} ND=${ndValue} B=${bonusValue} | Calc=${calculated.toFixed(3)} Actual=${finalScore.toFixed(3)}`);

                      gymnastScores[g.gymnast_id] = {
                        start: startValue,
                        exec: execValue,
                        nd: ndValue,
                        bonus: bonusValue
                      };
                    }
                  });
                }
              });
            }
          });
        }
        console.log('Gymnast scores map:', gymnastScores);

        // Sort by place, then by execution score (higher exec wins tiebreaker), limit to top 10
        const gymnasts = eventResults.gymnasts
          .sort((a, b) => {
            const placeA = a.place || 999;
            const placeB = b.place || 999;
            if (placeA !== placeB) return placeA - placeB;
            // Tiebreaker: higher execution score comes first
            const execA = gymnastScores[a.gymnast_id]?.exec || 0;
            const execB = gymnastScores[b.gymnast_id]?.exec || 0;
            return execB - execA; // Descending (higher exec first)
          })
          .slice(0, 10);

        // Calculate diff from leader (scores are strings in API)
        const topScore = parseFloat(gymnasts[0]?.final_score) || 0;

        // Build table HTML - columns: #, Name, Team, Apparatus, Score, Diff., Exec., SB
        let tableHtml = `
          <table class="leaderboard-table">
            <thead>
              <tr>
                <th class="col-rank">#</th>
                <th class="col-name">Name</th>
                <th class="col-team">Team</th>
                <th class="col-apparatus">Apparatus</th>
                <th class="col-score">Score</th>
                <th class="col-diff">Diff.</th>
                <th class="col-exec">Exec.</th>
                <th class="col-sb">SB</th>
              </tr>
            </thead>
            <tbody>
        `;

        // Check for ties - count how many gymnasts share each place
        const placeCounts = {};
        gymnasts.forEach(g => {
          const p = g.place || 999;
          placeCounts[p] = (placeCounts[p] || 0) + 1;
        });

        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const place = g.place || i + 1;
          const isTied = placeCounts[place] > 1;

          // Get detailed scores from the gymnastScores map (built from team data)
          const detailedScores = gymnastScores[g.gymnast_id] || {};
          const dScore = detailedScores.start || 0;
          const eScore = detailedScores.exec || 0;
          // Stick bonus is indicated by bonus > 0 in the API
          const hasStick = detailedScores.bonus > 0;

          // Rank display - medal for 1st/2nd/3rd, with T superscript for ties
          let rankHtml = '';
          if (place === 1) {
            rankHtml = `<span class="leaderboard-medal medal-gold">1</span>`;
          } else if (place === 2) {
            rankHtml = isTied ? `${place}<sup>T</sup>` : `<span class="leaderboard-medal medal-silver">2</span>`;
          } else if (place === 3) {
            rankHtml = isTied ? `${place}<sup>T</sup>` : `<span class="leaderboard-medal medal-bronze">3</span>`;
          } else {
            rankHtml = isTied ? `${place}<sup>T</sup>` : place;
          }

          // Name with colored circle indicator for top 3
          const placeIndicator = place === 1 ? '<span class="place-indicator gold"></span>' :
                                 place === 2 ? '<span class="place-indicator silver"></span>' :
                                 place === 3 ? '<span class="place-indicator bronze"></span>' : '';

          // Team logo - try tricode first, then short_name
          const teamKey = g.tricode || g.short_name || '';
          const logoUrl = teamLogos[teamKey] || '';
          const logoHtml = logoUrl ? `<img class="leaderboard-team-logo" src="${logoUrl}" alt="">` : '';

          // Stick bonus indicator
          const stickHtml = hasStick ? '<span class="stick-bonus">S</span>' : '';

          // Format difficulty - show 1 decimal, execution show 3 decimals
          const dScoreStr = dScore > 0 ? dScore.toFixed(1) : '-';
          const eScoreStr = eScore > 0 ? eScore.toFixed(3) : '-';

          // Use team_name for the team column (short_name is the team abbreviation)
          const teamName = g.team_name || g.short_name || '';

          tableHtml += `
            <tr>
              <td class="col-rank">${rankHtml}</td>
              <td class="col-name">${placeIndicator}${g.full_name || g.last_name || 'Unknown'}</td>
              <td class="col-team">${logoHtml}${teamName}</td>
              <td class="col-apparatus"><span class="apparatus-badge">${shortCode}</span></td>
              <td class="col-score">${score.toFixed(3)}</td>
              <td class="col-diff">${dScoreStr}</td>
              <td class="col-exec">${eScoreStr}</td>
              <td class="col-sb">${stickHtml}</td>
            </tr>
          `;
        });

        tableHtml += '</tbody></table>';
        contentEl.innerHTML = tableHtml;

      } catch (error) {
        console.error('Leaderboard fetch error:', error);
        contentEl.innerHTML = '<div class="leaderboard-error">Error loading leaderboard</div>';
      }
    }

    // Men's gymnastics events in Olympic order
    const MENS_EVENTS_ORDER = ['FLOOR', 'HORSE', 'RINGS', 'VAULT', 'PBARS', 'BAR'];
    const EVENT_DISPLAY_NAMES = {
      'FLOOR': 'Floor Exercise',
      'HORSE': 'Pommel Horse',
      'RINGS': 'Still Rings',
      'VAULT': 'Vault',
      'PBARS': 'Parallel Bars',
      'BAR': 'High Bar'
    };
    const EVENT_SHORT_CODES = {
      'FLOOR': 'FX',
      'HORSE': 'PH',
      'RINGS': 'SR',
      'VAULT': 'VT',
      'PBARS': 'PB',
      'BAR': 'HB'
    };

    // Athlete headshot library - maps lowercase athlete name to Virtius media URL
    // This allows us to use our own curated headshots instead of API defaults
    const ATHLETE_HEADSHOTS = {
      // Navy
      'aaron stein': 'https://media.virti.us/upload/images/athlete/bVREzuzMfJF5Pi3INKuss',
      'aaron zorgo': 'https://media.virti.us/upload/images/athlete/RNYnjPd8T8bVwuAqicvdA',
      'benjamin thurlow lam': 'https://media.virti.us/upload/images/athlete/ThZW7XIbg2YbyXJ2EnD7H',
      'benjamin venters': 'https://media.virti.us/upload/images/athlete/r-oKniK7q45of_qtKATRp',
      'boone washburn': 'https://media.virti.us/upload/images/athlete/ZQ3tK20Awuf-PB6Xr2tlo',
      'brian solomon': 'https://media.virti.us/upload/images/athlete/zxKpzPO1WD1wuCTqu7yPR',
      'cody phillips': 'https://media.virti.us/upload/images/athlete/CBgJfcoBg99i_6dyApgPK',
      'colby prince': 'https://media.virti.us/upload/images/athlete/G7njrXwnxJ-EEKmGfPNFE',
      'daniel gurevich': 'https://media.virti.us/upload/images/athlete/kkZkc2xI9W89c57kITtbt',
      'danilo viciana': 'https://media.virti.us/upload/images/athlete/cSSPoHA9GXaHtV75aV61n',
      'garrett lawless': 'https://media.virti.us/upload/images/athlete/YbATup9pdxGJULqPmjenU',
      'jonah soltz': 'https://media.virti.us/upload/images/athlete/7Wp4vRjGrChEPu8Mwd_sq',
      'julian galvez': 'https://media.virti.us/upload/images/athlete/5Fmj6ulMKyhrDvUwIKBvm',
      'justin lozano': 'https://media.virti.us/upload/images/athlete/X8uS5pYTvziEg7UctRMTL',
      'kody tokunaga': 'https://media.virti.us/upload/images/athlete/7T-wvjPMsWIpiGClmVOgS',
      'matthew petros': 'https://media.virti.us/upload/images/athlete/Cf_PyziTQlB1O82sDBiww',
      'matthew zeigler': 'https://media.virti.us/upload/images/athlete/a3culpWPBE-_iMG44An6d',
      'mckinley michel': 'https://media.virti.us/upload/images/athlete/Zzm1XxWflm3d6afQPPZFg',
      'michael romo': 'https://media.virti.us/upload/images/athlete/m9Ujh6AViDf4uUUIFKaPQ',
      'payton guillory': 'https://media.virti.us/upload/images/athlete/Ic6oFPMimFW7FMuJtNxMw',
      'saran alexander': 'https://media.virti.us/upload/images/athlete/TrNnHtfYrH5BozHozZzvL',
      'sean armstrong': 'https://media.virti.us/upload/images/athlete/SCrZqcbmFrPnJqOSu77bG',
      // Cal (California)
      'brendan strom': 'https://media.virti.us/upload/images/athlete/1cVXy-T-5mgwnNav4VJ6k',
      'carter kim': 'https://media.virti.us/upload/images/athlete/COfO8fbGgFA_ZBnE37ndJ',
      'davide comparin': 'https://media.virti.us/upload/images/athlete/R8Y1dfHBDHeiszcSGw3Wd',
      'evan wenstad': 'https://media.virti.us/upload/images/athlete/ZmxVIe-6MFDVd1U9wXCdK',
      'finley chin': 'https://media.virti.us/upload/images/athlete/f3STeUMwZ0TVWsu5w6J2b',
      'harry kim': 'https://media.virti.us/upload/images/athlete/hIqN7d97gKOnCC2G_5fk5',
      'jasper smith-gordon': 'https://media.virti.us/upload/images/athlete/ceZUXMm4uDBQSSqVh9zXZ',
      'jaxon mitchell': 'https://media.virti.us/upload/images/athlete/P29GhcR9nqOqN3aVASjaE',
      'jd ehinger': 'https://media.virti.us/upload/images/athlete/kz5pENbBzHno2zd0CllHl',
      'kaien orion': 'https://media.virti.us/upload/images/athlete/wXur_UvfSugKysN6D8Olm',
      'khalen curry': 'https://media.virti.us/upload/images/athlete/nMiYTGBmoDQibJ6cGExHv',
      'liam deweese': 'https://media.virti.us/upload/images/athlete/n9jC3XkZoWTj3D6da3s3M',
      'matteo bardana': 'https://media.virti.us/upload/images/athlete/SmVMJA7m8A6AcYGsi51oD',
      'nathan underhill': 'https://media.virti.us/upload/images/athlete/gLKC-_s0WAuZGXo8LRTzV',
      'sam cirlincione': 'https://media.virti.us/upload/images/athlete/HkzVaqzoshqzieNTnBev7',
      'theodor roald gadderud': 'https://media.virti.us/upload/images/athlete/eMTETdroQg1Nl73PIhR8n',
      'trigg dudley': 'https://media.virti.us/upload/images/athlete/L7dfIQiIDF2ao7T8n4Mm5',
      'troy nuesca': 'https://media.virti.us/upload/images/athlete/iX_ld2SgoQNEyCPNg_ASM',
      'tucker yasunaga': 'https://media.virti.us/upload/images/athlete/EYAEZe97glrJFWqyiReUm',
      'will horenziak': 'https://media.virti.us/upload/images/athlete/3XEFbFASgcKc2x720zZfJ',
      // Stanford
      'arun chhetri': 'https://media.virti.us/upload/images/athlete/j_v4sIFnfBzHUwleTC68X',
      'asher hong': 'https://media.virti.us/upload/images/athlete/aH7Kk874GhAh590PuEVFK',
      'cooper kim': 'https://media.virti.us/upload/images/athlete/0IBtstDrlJxbpErwM_UNp',
      'david shamah': 'https://media.virti.us/upload/images/athlete/QvYoTeG65O4dMEUdjNuBw',
      'deano roberts': 'https://media.virti.us/upload/images/athlete/PYQP_A7cjIs43SZv3i6qb',
      'divier ramos-delgado': 'https://media.virti.us/upload/images/athlete/vJXpAVVkqcDWWnPcbC190',
      'jowy nieves': 'https://media.virti.us/upload/images/athlete/IEXuMRTPVcettEEuebjfV',
      'junnosuke iwai': 'https://media.virti.us/upload/images/athlete/W9sFpRcn6HvjjByDVYpp-',
      'kai uemura': 'https://media.virti.us/upload/images/athlete/n83H-u8_JtPWdGLwlQuzz',
      'kiran mandava': 'https://media.virti.us/upload/images/athlete/yOzUdi_gNYlXjYSer5KfA',
      'marcus kushner': 'https://media.virti.us/upload/images/athlete/fAbKKbZZNJccKh9F8nzWj',
      'marcus pietarinen': 'https://media.virti.us/upload/images/athlete/lOtiWvRbryKEPMpQ14sqK',
      'michael scheiner': 'https://media.virti.us/upload/images/athlete/h59SVg975ou4-i5__6rlH',
      'nick kuebler': 'https://media.virti.us/upload/images/athlete/NohCBsw4JRhcakpVG7BBV',
      'reece landsperger': 'https://media.virti.us/upload/images/athlete/DoN-UgHC2qrI4nbeZg1F6',
      'toma murakawa': 'https://media.virti.us/upload/images/athlete/q-quTVY2a-8bzzI4jnIyd',
      'wade nelson': 'https://media.virti.us/upload/images/athlete/q4wfg5mr_FnE4YrjNwUI6',
      'xander hong': 'https://media.virti.us/upload/images/athlete/quAXgfD40w-f5mLDzqrGQ',
      'zachary green': 'https://media.virti.us/upload/images/athlete/coBnRbQygRwoK6epO36LC',
      // Fisk University (Women's)
      'aiyana thomas': 'https://media.virti.us/upload/images/athlete/QCIWQjesQnaUAKhnE-tnL',
      'aliyah reed-hammon': 'https://media.virti.us/upload/images/athlete/M83B6Hrx3nKLNX9e7PSf6',
      'allie berkley': 'https://media.virti.us/upload/images/athlete/1FM5JNidhdVPTWlCIEYTM',
      'ciniah rosby': 'https://media.virti.us/upload/images/athlete/u46EN0dgCtUgN3sAOoiVy',
      'hadassah diggs': 'https://media.virti.us/upload/images/athlete/i72U-MXljHxgEw8A8r5iy',
      'jordynn cromartie': 'https://media.virti.us/upload/images/athlete/S2DO-FlczUy33MMzfU3uq',
      'kennedi johnson': 'https://media.virti.us/upload/images/athlete/6u82DqwshCFIWiAYtBnbd',
      'liberty mora': 'https://media.virti.us/upload/images/athlete/oyGyeVtmmPQQW0lCFD_w8',
      'makia rosado': 'https://media.virti.us/upload/images/athlete/_6WhV5x-9sKeK3lEIlwjr',
      'sophia pratt': 'https://media.virti.us/upload/images/athlete/X7rB2_ZgSFDXfs0eW8UFr',
      'zanna brewer': 'https://media.virti.us/upload/images/athlete/v0oBQIJ7H0TkxBS55xK47',
      'zyia coleman': 'https://media.virti.us/upload/images/athlete/kXS5CGn6ch1iQYC3YRFT5',
      // Centenary College (Women's)
      'amy foret': 'https://media.virti.us/upload/images/athlete/YSWTModYqlsFZK3WdnrzK',
      'anna ichiba': 'https://media.virti.us/upload/images/athlete/Fvt_cH77bWufJ6juvuLZR',
      'brooke murdock': 'https://media.virti.us/upload/images/athlete/TwDo2-r9291i3bb5oVzVC',
      'cecilia paredes': 'https://media.virti.us/upload/images/athlete/GiglP2tBIueo166zWsS7d',
      'chloe gilbert': 'https://media.virti.us/upload/images/athlete/MmdqdhRFTWjiOnBSBi61B',
      'claire flores': 'https://media.virti.us/upload/images/athlete/YQeKZjm_C3LHO6Ne7G287',
      'erin pinder': 'https://media.virti.us/upload/images/athlete/s3wYoVHXVoLMulUc15Xyd',
      'hayden cagle': 'https://media.virti.us/upload/images/athlete/4SPIOiKHVs07SAZwDWbXQ',
      'lelia dunlavy': 'https://media.virti.us/upload/images/athlete/KugvvPNIFcWhwFQjE04cP',
      'mallory stephens': 'https://media.virti.us/upload/images/athlete/xSsPI3ZZ2wp14L-g0oQbK',
      'molly english': 'https://media.virti.us/upload/images/athlete/WxKykVl1ufwVxRVCw6iGO',
      'nyah washington': 'https://media.virti.us/upload/images/athlete/BRnuNCn2gSFlC2WDDwP1D',
      'olivia montgomery': 'https://media.virti.us/upload/images/athlete/FzXmVWGhGkfm7OtLm55q1',
      'olivia stratmann': 'https://media.virti.us/upload/images/athlete/Ub9lMyNwtBW8TPnx4nrbv',
      'olivia williams': 'https://media.virti.us/upload/images/athlete/qGG7TVOvXqk5K5sUxGGHN',
      'peyton burford': 'https://media.virti.us/upload/images/athlete/vnemcpLN8OwerOEuAPacV',
      'riley navarro': 'https://media.virti.us/upload/images/athlete/dEyNMURLSl7Rw-SIO1hwt',
      'skyla cruz': 'https://media.virti.us/upload/images/athlete/ChsX3x1OD2yJiwnpV8kts',
      // Wilberforce (Women's)
      'carli finkley': 'https://media.virti.us/upload/images/athlete/jRQJcUOc-91YvL4TF9Gpp',
      'danielle johnson': 'https://media.virti.us/upload/images/athlete/M2kvQSaF6z4Yp6VeoqurV',
      'diamond cook': 'https://media.virti.us/upload/images/athlete/dh8QK5ckClYJSNysBpEBe',
      'emily herrera': 'https://media.virti.us/upload/images/athlete/yciQBEg0HXty3ugDhlwHK',
      'hannah gouldbourne': 'https://media.virti.us/upload/images/athlete/LtoKResa_Bc0u0ZXB_mJx',
      'jaidyn bryant': 'https://media.virti.us/upload/images/athlete/EOLLc780NzbKv6loHhCuX',
      'kaleigh garner': 'https://media.virti.us/upload/images/athlete/rjSs6Hu8q7ympHQ2ZQ1Ng',
      'mackenzie butler': 'https://media.virti.us/upload/images/athlete/V2CeS42mKVR7It524CAWR',
      'madison kelly': 'https://media.virti.us/upload/images/athlete/plCiU8VPx_qLs3YnMVgIx',
      'makiyah davis': 'https://media.virti.us/upload/images/athlete/1Di7Al76uWLhA2sCCar-A',
      'mikayla clements': 'https://media.virti.us/upload/images/athlete/1O41JjAQjiNnR7Uhqq4Oo',
      'myca kelly': 'https://media.virti.us/upload/images/athlete/2W1DlvcyZZHA5rbdwyGLf',
      'myna caines': 'https://media.virti.us/upload/images/athlete/iKFe8UAfJuPWUgwJCDA7g',
      "n'diah brown": 'https://media.virti.us/upload/images/athlete/rf6EYRlhPtyVIaZxx4fhI',
      'nishayla riley': 'https://media.virti.us/upload/images/athlete/87iqde2o7Ht-wZFtMhrc_',
      'promise jean-marie': 'https://media.virti.us/upload/images/athlete/OWZun71ChfPJeV8bIAhX4',
      'sadara mayhorn': 'https://media.virti.us/upload/images/athlete/1pSuBF5AyDypHc4yRc00q',
      'saniah smith': 'https://media.virti.us/upload/images/athlete/GdDVF4oxa-aNTcjolceBC',
      'sydney smith': 'https://media.virti.us/upload/images/athlete/UoRyzVz2LksoEoTj8iSIC',
      // Greenville (Women's)
      'alessia russo': 'https://media.virti.us/upload/images/athlete/smkg4wf_S-ihWRpjgSDFX',
      'alexis stonebraker': 'https://media.virti.us/upload/images/athlete/JF-_Ra50E-f_HcveHgbDS',
      'amara nelson': 'https://media.virti.us/upload/images/athlete/1tGFjzE1os0N5y7g7gQe7',
      'aubrey kenimer': 'https://media.virti.us/upload/images/athlete/7eLgaVnOWsM19QDXn9DIc',
      'christianna cutler': 'https://media.virti.us/upload/images/athlete/UeBdwZMa1LOlYrkDNisQH',
      'ellery gilmer': 'https://media.virti.us/upload/images/athlete/TKHPU0R_3rjvgi_xwm6X5',
      'elli schnieders': 'https://media.virti.us/upload/images/athlete/-OcZrBQdnQA4jiSKVarAx',
      'emma brannon': 'https://media.virti.us/upload/images/athlete/qxlRn2xGi20UwMTOZfwwk',
      'faye jones': 'https://media.virti.us/upload/images/athlete/bLP-Hntcp9yXOhtAo60NJ',
      'isabella feltman': 'https://media.virti.us/upload/images/athlete/3VoKov015ClGqzt9HL4-T',
      'izabella yanis': 'https://media.virti.us/upload/images/athlete/5Y-yKeMM1M1ivbJLU1tW7',
      'laila manley': 'https://media.virti.us/upload/images/athlete/-E8-v9NHgPXuhOSWPGZAb',
      'madison carter': 'https://media.virti.us/upload/images/athlete/SGQWkwNtuLvlWIin7dfCM',
      'madison ford': 'https://media.virti.us/upload/images/athlete/kPVDaeF31R4iso9-ZlJt1',
      'matilda brougham': 'https://media.virti.us/upload/images/athlete/9MnxatWgy46cgqdPDMY3L',
      'maycee mcknight': 'https://media.virti.us/upload/images/athlete/cR2UZ1w6XfaF4eyYieq7G',
      'naima murray': 'https://media.virti.us/upload/images/athlete/ToXEjbKMGSBAjdolhdcvE',
      'olivia tocco': 'https://media.virti.us/upload/images/athlete/KnlNsoKjFdGlJCo6g44-1',
      'reagan rodriguez': 'https://media.virti.us/upload/images/athlete/pSF0sqJQ7c4Dyjp_UaVgl',
      'reese clapper': 'https://media.virti.us/upload/images/athlete/xOxDOKLTx5B2F_Z5OxG_X',
      'roya zehtab': 'https://media.virti.us/upload/images/athlete/7maWXHWLsZvg9X6rcrSYS',
      'taylor templin': 'https://media.virti.us/upload/images/athlete/MAu3yL7pFaNCiAYWH2-Mo',
      'valeria arraiz': 'https://media.virti.us/upload/images/athlete/CXnHDBhbLTupvDgyQyIwm',
    };

    // Look up athlete headshot - checks library first, then falls back to API headshot
    function getAthleteHeadshot(firstName, lastName, apiHeadshot) {
      if (!firstName && !lastName) return apiHeadshot || '';

      // Build full name for lookup
      const fullName = `${firstName || ''} ${lastName || ''}`.toLowerCase().trim();

      // Check library first
      if (ATHLETE_HEADSHOTS[fullName]) {
        return ATHLETE_HEADSHOTS[fullName];
      }

      // Try normalized match (remove special chars)
      const normalized = fullName.replace(/[^a-z\s]/g, '').replace(/\s+/g, ' ').trim();
      if (ATHLETE_HEADSHOTS[normalized]) {
        return ATHLETE_HEADSHOTS[normalized];
      }

      // Fall back to API headshot
      return apiHeadshot || '';
    }

    // Calculate which event a team is on for a given rotation
    // - Head-to-head: Both teams compete on the SAME apparatus (Floor, then PH, etc.)
    // - Alternating: Teams start on different events and swap every rotation
    //   R1: Home=FX, Away=PH | R2: Home=PH, Away=FX | R3: Home=SR, Away=VT | R4: Home=VT, Away=SR | R5: Home=PB, Away=HB | R6: Home=HB, Away=PB
    function getTeamEventForRotation(teamOrder, rotation, numTeams, competitionFormat) {
      // teamOrder is 0-indexed (0 = home, 1 = away), rotation is 1-indexed (1-6)

      if (competitionFormat === 'head-to-head') {
        // Head-to-head: Both teams on same event, progressing through Olympic order
        return (rotation - 1) % 6;
      }

      // Alternating format: Teams on adjacent events, swapping each rotation
      // Rotation pairs: 1-2 (FX/PH), 3-4 (SR/VT), 5-6 (PB/HB)
      const pairIndex = Math.floor((rotation - 1) / 2); // 0, 0, 1, 1, 2, 2
      const isSecondInPair = (rotation - 1) % 2 === 1; // false, true, false, true, false, true
      const baseEvent = pairIndex * 2; // 0, 0, 2, 2, 4, 4

      if (teamOrder === 0) {
        // Home team: starts on first event of pair, swaps to second
        return isSecondInPair ? baseEvent + 1 : baseEvent;
      } else {
        // Away team: starts on second event of pair, swaps to first
        return isSecondInPair ? baseEvent : baseEvent + 1;
      }
    }

    // Fetch event summary data from Virtius API and render rotation view
    async function fetchAndRenderEventSummary(sessionId, rotation, numTeams, competitionFormat) {
      const contentEl = document.getElementById('event-summary-content');
      if (!contentEl) return;

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        const teams = data.meet?.teams || [];
        if (teams.length === 0) {
          contentEl.innerHTML = '<div class="event-summary-error">No teams found</div>';
          return;
        }

        // Sort teams by team_order
        const sortedTeams = [...teams].sort((a, b) => (a.team_order || 0) - (b.team_order || 0));

        // Determine if this is a dual meet (2 teams) or multi-team (3+)
        const isDual = sortedTeams.length === 2;
        const actualNumTeams = Math.min(sortedTeams.length, numTeams || sortedTeams.length);

        // Build rotation data for each team
        const rotationData = sortedTeams.slice(0, actualNumTeams).map((team, idx) => {
          const eventIndex = getTeamEventForRotation(idx, rotation, actualNumTeams, competitionFormat);
          const eventName = MENS_EVENTS_ORDER[eventIndex];
          const teamEvent = team.events?.find(e => e.event_name === eventName);
          const gymnasts = teamEvent?.gymnasts?.sort((a, b) => (a.order || 0) - (b.order || 0)) || [];
          const eventScore = parseFloat(teamEvent?.event_score) || 0;
          const totalScore = parseFloat(team.final_score) || 0;

          return {
            team,
            eventName,
            eventDisplayName: EVENT_DISPLAY_NAMES[eventName] || eventName,
            eventShortCode: EVENT_SHORT_CODES[eventName] || eventName,
            gymnasts,
            eventScore,
            totalScore
          };
        });

        // Render based on meet type
        if (isDual) {
          renderDualMeetSummary(contentEl, rotationData, rotation);
        } else {
          renderMultiTeamSummary(contentEl, rotationData, rotation, actualNumTeams);
        }

      } catch (error) {
        console.error('Event summary fetch error:', error);
        contentEl.innerHTML = '<div class="event-summary-error">Error loading event summary</div>';
      }
    }

    // Render dual meet layout (2 teams side-by-side with center divider)
    function renderDualMeetSummary(contentEl, rotationData, rotation) {
      const team1 = rotationData[0];
      const team2 = rotationData[1];

      // Calculate score differences for each lineup position
      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildTeamColumn(team1, 'left', maxAthletes);
      const rightColumn = buildTeamColumn(team2, 'right', maxAthletes);

      // Build center divider with score diffs
      let centerHtml = `<div class="center-divider"><div class="rotation-badge">R${rotation}</div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = diff === 0 ? '--' : (diff > 0 ? diff.toFixed(3) : diff.toFixed(3));
        centerHtml += `
          <div class="score-diff" style="height: 68px; display: flex; flex-direction: column; justify-content: center;">
            <div class="score-diff-value">${diffStr}</div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Build footer with event totals
      const footerHtml = `
        <div class="event-summary-footer">
          <div class="footer-team left">
            <div class="event-label">${team1.eventShortCode}</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : '—'}</div>
          </div>
          <div class="footer-center">
            <div style="font-size: 18px; color: #a1a1aa;">${(team1.eventScore - team2.eventScore).toFixed(3)}</div>
          </div>
          <div class="footer-team right">
            <div class="event-label">${team2.eventShortCode}</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : '—'}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="event-summary-dual">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // Build a team column for dual meet layout
    function buildTeamColumn(teamData, side, maxAthletes) {
      const { team, gymnasts, totalScore, eventShortCode } = teamData;

      let athletesHtml = '';
      for (let i = 0; i < maxAthletes; i++) {
        const g = gymnasts[i];
        if (g) {
          const score = parseFloat(g.final_score) || 0;
          const diff = g.scores && g.scores.length > 0 ? parseFloat(g.scores[0].start) || 0 : 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          // Look up headshot from library first, fall back to API headshot
          const photoUrl = getAthleteHeadshot(g.first_name, g.last_name, g.headshot);

          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              ${photoUrl ? `<img class="athlete-photo" src="${photoUrl}" alt="">` : '<div class="athlete-photo"></div>'}
              <div class="athlete-name">${name}</div>
              <div class="athlete-diff">${diff > 0 ? diff.toFixed(1) : ''}</div>
              <div class="athlete-score">${score > 0 ? score.toFixed(3) : 'On Eval'}</div>
            </div>
          `;
        } else {
          athletesHtml += `<div class="athlete-row" style="height: 68px;"></div>`;
        }
      }

      const logoUrl = team.logo || '';
      return `
        <div class="team-column ${side}">
          <div class="team-header ${side}">
            ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
            <div class="team-name">${team.name || team.tricode}</div>
            <div class="team-total">${totalScore > 0 ? totalScore.toFixed(3) : ''}</div>
          </div>
          <div class="athlete-list">
            ${athletesHtml}
          </div>
        </div>
      `;
    }

    // Render multi-team layout (quad meet - 4 columns)
    function renderMultiTeamSummary(contentEl, rotationData, rotation, numTeams) {
      let columnsHtml = '';

      rotationData.forEach(teamData => {
        const { team, eventDisplayName, eventShortCode, gymnasts, eventScore } = teamData;
        const logoUrl = team.logo || '';

        let athletesHtml = '';
        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              <div class="athlete-name">${name}</div>
              <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        });

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : '—'}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad">${columnsHtml}</div>`;
    }

    // Map apparatus short codes to API event names
    const APPARATUS_TO_EVENT = {
      'fx': 'FLOOR',
      'ph': 'HORSE',
      'sr': 'RINGS',
      'vt': 'VAULT',
      'pb': 'PBARS',
      'hb': 'BAR'
    };

    // Fetch event summary by apparatus (both teams on same event)
    async function fetchAndRenderEventSummaryByApparatus(sessionId, apparatus, numTeams, competitionFormat) {
      const contentEl = document.getElementById('event-summary-content');
      if (!contentEl) return;

      try {
        const response = await fetch(`https://api.virti.us/session/${sessionId}/json`);
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();

        const teams = data.meet?.teams || [];
        if (teams.length === 0) {
          contentEl.innerHTML = '<div class="event-summary-error">No teams found</div>';
          return;
        }

        // Sort teams by team_order
        const sortedTeams = [...teams].sort((a, b) => (a.team_order || 0) - (b.team_order || 0));

        // Get the event name from the apparatus code
        const eventName = APPARATUS_TO_EVENT[apparatus] || 'FLOOR';
        const eventDisplayName = EVENT_DISPLAY_NAMES[eventName] || eventName;
        const eventShortCode = EVENT_SHORT_CODES[eventName] || apparatus.toUpperCase();

        // Determine if this is a dual meet (2 teams) or multi-team (3+)
        const isDual = sortedTeams.length === 2;
        const actualNumTeams = Math.min(sortedTeams.length, numTeams || sortedTeams.length);

        // Build data for each team on the SAME event (apparatus mode)
        const apparatusData = sortedTeams.slice(0, actualNumTeams).map((team) => {
          const teamEvent = team.events?.find(e => e.event_name === eventName);
          const gymnasts = teamEvent?.gymnasts?.sort((a, b) => (a.order || 0) - (b.order || 0)) || [];
          const eventScore = parseFloat(teamEvent?.event_score) || 0;
          const totalScore = parseFloat(team.final_score) || 0;

          return {
            team,
            eventName,
            eventDisplayName,
            eventShortCode,
            gymnasts,
            eventScore,
            totalScore
          };
        });

        // Render based on meet type
        if (isDual) {
          renderDualMeetSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode);
        } else {
          renderMultiTeamSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode, actualNumTeams);
        }

      } catch (error) {
        console.error('Event summary fetch error:', error);
        contentEl.innerHTML = '<div class="event-summary-error">Error loading event summary</div>';
      }
    }

    // Render dual meet apparatus layout (2 teams side-by-side, same event)
    function renderDualMeetSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode) {
      const team1 = apparatusData[0];
      const team2 = apparatusData[1];

      // Calculate score differences for each lineup position
      const maxAthletes = Math.max(team1.gymnasts.length, team2.gymnasts.length);

      // Build left team column
      const leftColumn = buildTeamColumn(team1, 'left', maxAthletes);
      const rightColumn = buildTeamColumn(team2, 'right', maxAthletes);

      // Build center divider with event name (instead of rotation)
      let centerHtml = `<div class="center-divider"><div class="rotation-badge">${eventShortCode}</div>`;
      for (let i = 0; i < maxAthletes; i++) {
        const score1 = team1.gymnasts[i] ? parseFloat(team1.gymnasts[i].final_score) || 0 : 0;
        const score2 = team2.gymnasts[i] ? parseFloat(team2.gymnasts[i].final_score) || 0 : 0;
        const diff = score1 - score2;
        const diffStr = diff === 0 ? '--' : (diff > 0 ? diff.toFixed(3) : diff.toFixed(3));
        centerHtml += `
          <div class="score-diff" style="height: 68px; display: flex; flex-direction: column; justify-content: center;">
            <div class="score-diff-value">${diffStr}</div>
          </div>
        `;
      }
      centerHtml += '</div>';

      // Build footer with event totals (same event for both teams)
      const footerHtml = `
        <div class="event-summary-footer">
          <div class="footer-team left">
            <div class="event-label">${eventShortCode}</div>
            <div class="event-total">${team1.eventScore > 0 ? team1.eventScore.toFixed(3) : '—'}</div>
          </div>
          <div class="footer-center">
            <div style="font-size: 18px; color: #a1a1aa;">${(team1.eventScore - team2.eventScore).toFixed(3)}</div>
          </div>
          <div class="footer-team right">
            <div class="event-label">${eventShortCode}</div>
            <div class="event-total">${team2.eventScore > 0 ? team2.eventScore.toFixed(3) : '—'}</div>
          </div>
        </div>
      `;

      contentEl.innerHTML = `
        <div class="event-summary-dual">
          ${leftColumn}
          ${centerHtml}
          ${rightColumn}
        </div>
        ${footerHtml}
      `;
    }

    // Render multi-team apparatus layout (all teams on same event)
    function renderMultiTeamSummaryApparatus(contentEl, apparatusData, eventDisplayName, eventShortCode, numTeams) {
      let columnsHtml = '';

      apparatusData.forEach(teamData => {
        const { team, gymnasts, eventScore } = teamData;
        const logoUrl = team.logo || '';

        let athletesHtml = '';
        gymnasts.forEach((g, i) => {
          const score = parseFloat(g.final_score) || 0;
          const name = `${g.first_name?.charAt(0) || ''}. ${g.last_name || ''}`;
          athletesHtml += `
            <div class="athlete-row">
              <div class="athlete-order">${i + 1}</div>
              <div class="athlete-name">${name}</div>
              <div class="athlete-score">${score > 0 ? score.toFixed(3) : ''}</div>
            </div>
          `;
        });

        columnsHtml += `
          <div class="team-column">
            <div class="team-header">
              <div class="event-name">${eventDisplayName}</div>
              <div class="team-name">
                ${team.name || team.tricode}
                ${logoUrl ? `<img class="team-logo" src="${logoUrl}" alt="">` : ''}
              </div>
            </div>
            <div class="athlete-list">
              ${athletesHtml}
            </div>
            <div class="team-footer">
              <div class="footer-label">Event Total</div>
              <div class="footer-total">${eventScore > 0 ? eventScore.toFixed(3) : '—'}</div>
            </div>
          </div>
        `;
      });

      contentEl.innerHTML = `<div class="event-summary-quad">${columnsHtml}</div>`;
    }

    // Graphic renderers
    const renderers = {
      clear: () => '',

      logos: (data) => {
        // Collect all team logos that exist (filter out empty/placeholder)
        const logos = [];
        for (let i = 1; i <= 6; i++) {
          const logo = data[`team${i}Logo`];
          if (logo && logo.trim() && !logo.includes('placeholder')) {
            logos.push(logo);
          }
        }

        // Use grid layout for 5+ teams, row for 2-4
        const isGrid = logos.length >= 5;
        const containerClass = isGrid ? 'graphic-logos graphic-logos-grid' : 'graphic-logos';

        const logosHtml = logos.map((logo, i) =>
          `<img class="team-logo" src="${logo}" alt="Team ${i + 1}">`
        ).join('');

        return `<div class="graphic-container ${containerClass}">${logosHtml}</div>`;
      },

      'event-bar': (data) => `
        <div class="graphic-container graphic-event-bar">
          <div class="event-bar-logo">
            <img src="${data.team1Logo}" alt="Team">
          </div>
          <div class="event-bar-content">
            <div class="event-bar-venue">${data.venue}</div>
            <div class="event-bar-details">
              <div class="event-bar-name">${data.eventName}</div>
              <div class="event-bar-location">${data.location}</div>
            </div>
          </div>
        </div>
      `,

      hosts: (data) => `
        <div class="graphic-container graphic-hosts">
          <div class="hosts-header">
            <div class="hosts-title">HOSTS</div>
          </div>
          <div class="hosts-content">
            ${data.hosts.split('\n').map(h => `<div class="hosts-name">${h}</div>`).join('')}
          </div>
        </div>
      `,

      'team1-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team1Name}</div>
            <img class="stats-logo" src="${data.team1Logo}" alt="Team">
            <div class="stats-con">${data.team1Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team1Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team1High}</div>
            </div>
          </div>
        </div>
      `,

      'team1-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team1Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team1Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team2-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team2Name}</div>
            <img class="stats-logo" src="${data.team2Logo}" alt="Team">
            <div class="stats-con">${data.team2Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team2Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team2High}</div>
            </div>
          </div>
        </div>
      `,

      'team2-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team2Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team2Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team3-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team3Name}</div>
            <img class="stats-logo" src="${data.team3Logo}" alt="Team">
            <div class="stats-con">${data.team3Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team3Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team3High}</div>
            </div>
          </div>
        </div>
      `,

      'team3-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team3Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team3Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team4-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team4Name}</div>
            <img class="stats-logo" src="${data.team4Logo}" alt="Team">
            <div class="stats-con">${data.team4Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team4Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team4High}</div>
            </div>
          </div>
        </div>
      `,

      'team4-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team4Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team4Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team5-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team5Name}</div>
            <img class="stats-logo" src="${data.team5Logo}" alt="Team">
            <div class="stats-con">${data.team5Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team5Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team5High}</div>
            </div>
          </div>
        </div>
      `,

      'team5-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team5Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team5Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'team6-stats': (data) => `
        <div class="graphic-container graphic-team-stats">
          <div class="stats-header">
            <div class="stats-team-name">${data.team6Name}</div>
            <img class="stats-logo" src="${data.team6Logo}" alt="Team">
            <div class="stats-con">${data.team6Con} CON</div>
          </div>
          <div class="stats-content">
            <div class="stat-item">
              <div class="stat-label">AVE</div>
              <div class="stat-value">${data.team6Ave}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">HIGH</div>
              <div class="stat-value">${data.team6High}</div>
            </div>
          </div>
        </div>
      `,

      'team6-coaches': (data) => `
        <div class="graphic-container graphic-coaches">
          <div class="coaches-header">
            <div class="coaches-title">COACHES</div>
            <img class="coaches-logo" src="${data.team6Logo}" alt="Team">
          </div>
          <div class="coaches-content">
            ${data.team6Coaches.split('\n').map(c => `<div class="coach-name">${c}</div>`).join('')}
          </div>
        </div>
      `,

      'event-frame': (data) => `
        <div class="graphic-container graphic-event-frame">
          <div class="frame-header">
            <div class="frame-title">${data.frameTitle}</div>
            <img class="frame-logo" src="${data.team1Logo}" alt="Team">
          </div>
          <div class="frame-content"></div>
        </div>
      `,

      'stream-starting': (data) => `
        <div class="graphic-container graphic-stream">
          <div class="stream-title">STREAM STARTING SOON</div>
          <img class="stream-logo" src="${data.team1Logo}" alt="Team">
          <div class="stream-event-name">${data.eventName}</div>
          <div class="stream-date">${data.meetDate}</div>
          <div class="stream-branding"><span>V</span>irtius</div>
        </div>
      `,

      'stream-thanks': (data) => `
        <div class="graphic-container graphic-stream">
          <div class="stream-title">THANKS FOR WATCHING</div>
          <img class="stream-logo" src="${data.team1Logo}" alt="Team">
          <div class="stream-event-name">${data.eventName}</div>
          <div class="stream-date">${data.meetDate}</div>
          <div class="stream-branding"><span>V</span>irtius</div>
        </div>
      `,

      'event-summary': (data) => {
        const sessionId = data.virtiusSessionId;
        const mode = data.summaryMode || 'rotation';
        const rotation = data.summaryRotation || 1;
        const apparatus = data.summaryApparatus || 'fx';
        const numTeams = data.summaryNumTeams || 2;
        const competitionFormat = data.summaryFormat || 'head-to-head';
        const hostLogo = data.team1Logo || '';

        if (!sessionId) {
          return '<div style="color: red; padding: 100px; font-size: 36px;">No Virtius Session ID configured for this competition</div>';
        }

        // Fetch and render after initial paint
        if (mode === 'apparatus') {
          setTimeout(() => fetchAndRenderEventSummaryByApparatus(sessionId, apparatus, numTeams, competitionFormat), 100);
        } else {
          setTimeout(() => fetchAndRenderEventSummary(sessionId, rotation, numTeams, competitionFormat), 100);
        }

        const logoHtml = hostLogo && hostLogo.trim() && !hostLogo.includes('placeholder')
          ? `<img class="event-summary-header-logo" src="${hostLogo}" alt="">`
          : '';

        const loadingText = mode === 'apparatus'
          ? `Loading ${apparatus.toUpperCase()}...`
          : `Loading rotation ${rotation}...`;

        return `
          <div class="graphic-container graphic-event-summary">
            <div class="event-summary-header">
              <div class="event-summary-title">EVENT SUMMARY</div>
              ${logoHtml}
            </div>
            <div class="event-summary-content" id="event-summary-content">
              <div class="event-summary-loading">${loadingText}</div>
            </div>
          </div>
        `;
      },

      'virtius-leaderboard': (data) => {
        const sessionId = data.virtiusSessionId;
        const event = data.leaderboardEvent || 'aa';
        if (!sessionId) {
          return '<div style="color: red; padding: 100px; font-size: 36px;">No Virtius Session ID configured for this competition</div>';
        }

        // Map event codes to display titles and API event names
        const eventTitles = {
          'fx': 'FLOOR EXERCISE',
          'ph': 'POMMEL HORSE',
          'sr': 'STILL RINGS',
          'vt': 'VAULT',
          'pb': 'PARALLEL BARS',
          'hb': 'HORIZONTAL BAR',
          'aa': 'ALL AROUND'
        };
        const eventApiNames = {
          'fx': 'FLOOR',
          'ph': 'HORSE',
          'sr': 'RINGS',
          'vt': 'VAULT',
          'pb': 'PBARS',
          'hb': 'BAR',
          'aa': 'All Around'
        };
        const eventShortCodes = {
          'fx': 'FX',
          'ph': 'PH',
          'sr': 'SR',
          'vt': 'VT',
          'pb': 'PB',
          'hb': 'HB',
          'aa': 'AA'
        };
        const title = eventTitles[event] || event.toUpperCase();
        const apiEventName = eventApiNames[event] || event;
        const shortCode = eventShortCodes[event] || event.toUpperCase();

        // Return loading state initially, then fetch and update
        setTimeout(() => fetchAndRenderLeaderboard(sessionId, apiEventName, shortCode), 100);

        // Only show logo if it exists and is valid
        const logoHtml = data.team1Logo && data.team1Logo.trim() && !data.team1Logo.includes('placeholder')
          ? `<img class="frame-logo" src="${data.team1Logo}" alt="">`
          : '';

        return `
          <div class="graphic-container graphic-virtius-leaderboard">
            <div class="frame-header">
              <div class="frame-title">${title}</div>
              ${logoHtml}
            </div>
            <div class="frame-content" id="leaderboard-content">
              <div class="leaderboard-loading">Loading leaderboard...</div>
            </div>
          </div>
        `;
      }
    };

    // Listen for graphic changes
    db.ref(`competitions/${competitionId}/currentGraphic`).on('value', (snapshot) => {
      const state = snapshot.val();
      if (!state) {
        output.innerHTML = '';
        return;
      }

      const { graphic, data } = state;
      
      if (graphic === 'clear' || !renderers[graphic]) {
        output.innerHTML = '';
        return;
      }

      output.innerHTML = renderers[graphic](data);
    });

    console.log(`Output panel ready - listening for graphics on competition: ${competitionId}`);
    // Note: Keyboard shortcuts (like 'b' for bold mode) work in OBS via Interact mode,
    // but not in regular browsers due to cross-origin iframe restrictions.
  </script>
</body>
</html>
